<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Passport Photo Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{--ratio:3/4}
*{box-sizing:border-box}

body{
  margin:0;
  background:#0e0e0e;
  font-family:system-ui;
  color:#eaeaea;
}

header{
  padding:14px 16px;
  border-bottom:1px solid #333;
  background:#121212;
}
header h1{font-size:16px;margin:0 0 6px}
header p{font-size:12px;color:#bbb;margin:0}

.container{
  display:flex;
  justify-content:center;
  padding:12px;
}

.frame{
  width:min(92vw,420px);
  aspect-ratio:var(--ratio);
  position:relative;
  border-radius:14px;
  overflow:hidden;
  background:#000;
  box-shadow:0 0 0 2px #2a2a2a;
}

video,canvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
}
video{object-fit:cover}

/* mirror only for front camera (display only) */
video.mirror{
  transform:scaleX(-1);
}

#output{display:none}

.frame-title{
  position:absolute;
  top:6px;left:8px;
  font-size:11px;
  background:rgba(0,0,0,.6);
  padding:3px 6px;
  border-radius:6px;
  z-index:5;
}

/* info */
.info{
  position:absolute;
  bottom:8px;
  left:8px;
  font-size:11px;
  background:rgba(0,0,0,.6);
  padding:4px 8px;
  border-radius:6px;
  z-index:5;
}

/* camera switch */
.switch{
  position:absolute;
  top:6px;
  right:8px;
  font-size:11px;
  background:rgba(0,0,0,.6);
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  z-index:6;
  user-select:none;
}

/* capture button */
.capture{
  position:absolute;
  left:50%;
  bottom:26%;
  transform:translateX(-50%);
  width:72px;
  height:72px;
  border-radius:50%;
  background:#fff;
  border:5px solid #111;
  cursor:pointer;
  z-index:6;

  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  font-weight:600;
  color:#111;
  user-select:none;
}
.capture:active{transform:translateX(-50%) scale(.95)}

/* countdown */
.countdown{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:72px;
  font-weight:700;
  background:rgba(0,0,0,.45);
  z-index:10;
}
</style>
</head>

<body>

<header>
<h1>Passport Photo Capture</h1>
<p>Use front or back camera. Front camera preview is mirrored.</p>
</header>

<div class="container">
  <div class="frame">
    <div class="frame-title">Passport Frame (3×4)</div>
    <div class="switch" id="switch">Front</div>

    <video id="video" autoplay playsinline></video>
    <canvas id="mask"></canvas>

    <div class="info" id="info">Live size: — KB</div>
    <div class="capture" id="capture">Press</div>
    <div class="countdown" id="countdown">10</div>
  </div>
</div>

<canvas id="output" width="360" height="480"></canvas>

<script>
const PW=360, PH=480, MAX_KB=20;

const video=document.getElementById("video");
const mask=document.getElementById("mask");
const output=document.getElementById("output");
const info=document.getElementById("info");
const captureBtn=document.getElementById("capture");
const countdownEl=document.getElementById("countdown");
const switchBtn=document.getElementById("switch");

const mctx=mask.getContext("2d");
const octx=output.getContext("2d");

let facing="user";
let stream=null;

/* AUDIO */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function beep(freq=800,dur=0.1){
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=freq;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+dur);
  o.stop(audioCtx.currentTime+dur);
}

/* CAMERA START */
async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());

  stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:facing,width:{ideal:1280},height:{ideal:1920}}
  });
  video.srcObject=stream;

  if(facing==="user") video.classList.add("mirror");
  else video.classList.remove("mirror");
}

startCamera();

/* SWITCH CAMERA */
switchBtn.onclick=()=>{
  facing = facing==="user" ? "environment" : "user";
  switchBtn.textContent = facing==="user" ? "Front" : "Back";
  startCamera();
};

/* RESIZE */
function resize(){
  const r=mask.getBoundingClientRect();
  mask.width=r.width; mask.height=r.height;
}
window.addEventListener("resize",resize);
video.onloadedmetadata=resize;

/* MASK */
function drawMask(){
  const w=mask.width,h=mask.height;
  mctx.clearRect(0,0,w,h);
  mctx.fillStyle="rgba(0,0,0,.7)";
  mctx.fillRect(0,0,w,h);

  mctx.globalCompositeOperation="destination-out";
  const cx=w/2, headY=h*0.38;
  const rx=w*0.30, ry=h*0.28;

  mctx.beginPath();
  mctx.ellipse(cx,headY,rx,ry,0,0,Math.PI*2);
  mctx.fill();

  mctx.beginPath();
  mctx.moveTo(w*0.12,h*0.74);
  mctx.quadraticCurveTo(cx,h*0.58,w*0.88,h*0.74);
  mctx.lineTo(w*0.88,h);
  mctx.lineTo(w*0.12,h);
  mctx.closePath();
  mctx.fill();

  mctx.globalCompositeOperation="source-over";
}

/* LIVE SIZE ESTIMATE */
function estimateSize(){
  octx.drawImage(video,0,0,PW,PH);
  const d=output.toDataURL("image/jpeg",0.8);
  return Math.round((d.length*3)/4/1024);
}

/* LOOP */
function loop(){
  drawMask();
  info.textContent=`Live size: ${estimateSize()} KB`;
  requestAnimationFrame(loop);
}
loop();

/* COUNTDOWN + CAPTURE */
captureBtn.onclick=()=>{
  audioCtx.resume();
  let t=10;
  countdownEl.style.display="flex";
  countdownEl.textContent=t;
  beep();

  const timer=setInterval(()=>{
    t--;
    if(t>0){
      countdownEl.textContent=t;
      beep();
    }else{
      clearInterval(timer);
      countdownEl.style.display="none";
      takePhoto();
    }
  },1000);
};

/* SAVE (NOT MIRRORED) */
function takePhoto(){
  beep(1200,0.2);

  const vw=video.videoWidth,vh=video.videoHeight;
  const target=PW/PH;
  let sw=vw,sh=vh,sx=0,sy=0;

  if(vw/vh>target){sw=vh*target;sx=(vw-sw)/2}
  else{sh=vw/target;sy=(vh-sh)/2}

  octx.drawImage(video,sx,sy,sw,sh,0,0,PW,PH);

  let q=0.95,data,size;
  do{
    data=output.toDataURL("image/jpeg",q);
    size=Math.round((data.length*3)/4/1024);
    q-=0.05;
  }while(size>MAX_KB && q>0.3);

  const a=document.createElement("a");
  a.href=data;
  a.download="passport_photo.jpg";
  a.click();
}
</script>

</body>
</html>
