<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fingerprint CLAHE Binary Enhancer</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body{margin:0;background:#0e0e0e;font-family:system-ui;color:#eaeaea}
header{padding:12px 14px;border-bottom:1px solid #333;background:#121212}
header h1{font-size:15px;margin:0}
.container{display:flex;flex-direction:column;height:calc(100vh - 150px);padding:8px;gap:8px}
.box{flex:1;position:relative;border:2px solid #2a2a2a;border-radius:10px;background:#000;overflow:hidden}
.box-title{position:absolute;top:6px;left:8px;font-size:11px;background:rgba(0,0,0,.6);padding:3px 6px;border-radius:6px;z-index:5}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.controls{padding:8px;background:#111;border-top:1px solid #333}
label{font-size:11px;color:#bbb}
input{width:100%}
.row{margin-bottom:6px}
</style>
</head>

<body>

<header>
<h1>Fingerprint CLAHE Binary Enhancer</h1>
</header>

<div class="container">
  <div class="box">
    <div class="box-title">Live Camera</div>
    <video id="v" autoplay playsinline></video>
    <canvas id="m"></canvas>
  </div>
  <div class="box">
    <div class="box-title">Binary Fingerprint Output</div>
    <canvas id="b"></canvas>
  </div>
</div>

<div class="controls">
  <div class="row"><label>Tile Size: <span id="tsv">160</span></label><input id="ts" type="range" min="80" max="240" step="16" value="160"></div>
  <div class="row"><label>Clip Limit: <span id="lv">40</span></label><input id="limit" type="range" min="10" max="80" step="2" value="40"></div>
  <div class="row"><label>Ridge Gain: <span id="gv">1.8</span></label><input id="gain" type="range" min="1" max="3" step="0.1" value="1.8"></div>
  <div class="row"><label>Binary Threshold: <span id="tv">0.95</span></label><input id="thr" type="range" min="0.7" max="1.2" step="0.01" value="0.95"></div>
</div>

<script>
(()=>{

const $=i=>document.getElementById(i),
V=$("v"),M=$("m"),B=$("b"),
CM=M.getContext("2d"),CB=B.getContext("2d");

navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}})
.then(s=>V.srcObject=s);

V.onloadedmetadata=()=>{
  M.width=B.width=V.videoWidth;
  M.height=B.height=V.videoHeight;
};

const ts=$("ts"),limit=$("limit"),gain=$("gain"),thr=$("thr");
const tsv=$("tsv"),lv=$("lv"),gv=$("gv"),tv=$("tv");

[ts,limit,gain,thr].forEach(x=>x.oninput=()=>{
  tsv.textContent=ts.value;
  lv.textContent=limit.value;
  gv.textContent=gain.value;
  tv.textContent=thr.value;
});

function claheLite(img,w,h,ts,clip){
  const out=new Uint8ClampedArray(w*h);
  for(let y=0;y<h;y+=ts)for(let x=0;x<w;x+=ts){
    let hist=new Array(256).fill(0);
    for(let j=0;j<ts;j++)for(let i=0;i<ts;i++){
      const px=(y+j)*w+(x+i);
      if(px<img.length)hist[img[px]]++;
    }
    let excess=0;
    for(let i=0;i<256;i++)if(hist[i]>clip){excess+=hist[i]-clip;hist[i]=clip}
    const red=Math.floor(excess/256);
    for(let i=0;i<256;i++)hist[i]+=red;

    let cdf=[],s=0;
    for(let i=0;i<256;i++){s+=hist[i];cdf[i]=s}

    for(let j=0;j<ts;j++)for(let i=0;i<ts;i++){
      const px=(y+j)*w+(x+i);
      if(px<img.length)
        out[px]=Math.min(255,(cdf[img[px]]/cdf[255])*255);
    }
  }
  return out;
}

(function loop(){
  if(!B.width)return requestAnimationFrame(loop);
  CB.drawImage(V,0,0,B.width,B.height);
  const I=CB.getImageData(0,0,B.width,B.height),D=I.data;
  const G=new Uint8ClampedArray(B.width*B.height);

  for(let i=0,j=0;i<D.length;i+=4,j++)
    G[j]=.299*D[i]+.587*D[i+1]+.114*D[i+2];

  const C=claheLite(G,B.width,B.height,+ts.value,+limit.value);
  let mean=0;
  for(let i=0;i<C.length;i++){C[i]=Math.min(255,(C[i]-110)*gain.value+128);mean+=C[i]}
  mean/=C.length;

  for(let i=0,j=0;i<D.length;i+=4,j++){
    const v=C[j]>mean*thr.value?255:0;
    D[i]=D[i+1]=D[i+2]=v;
  }

  CB.putImageData(I,0,0);
  requestAnimationFrame(loop);
})();

})();
</script>

</body>
</html>
