<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fingerprint Capture â€“ Finger Segmented Quality</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    background: #000;
    font-family: Arial, sans-serif;
    color: #fff;
}

.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

.box {
    flex: 1;
    position: relative;
    overflow: hidden;
}

video, canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

video { z-index: 1; }
#maskCanvas { z-index: 2; }

#donutCanvas {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 140px;
    height: 140px;
    z-index: 4;
}

.score-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 22px;
    font-weight: bold;
    z-index: 5;
}

.bottom-score {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 13px;
}
</style>
</head>

<body>

<div class="container">

<!-- TOP -->
<div class="box">
    <video id="video" autoplay playsinline></video>
    <canvas id="maskCanvas"></canvas>
    <canvas id="donutCanvas" width="140" height="140"></canvas>
    <div id="scoreText" class="score-text">0%</div>
</div>

<!-- BOTTOM -->
<div class="box">
    <canvas id="bwCanvas"></canvas>
    <div class="bottom-score">Peak: <span id="peakScore">0%</span></div>
</div>

</div>

<script>
const video = document.getElementById("video");
const maskCanvas = document.getElementById("maskCanvas");
const maskCtx = maskCanvas.getContext("2d");
const bwCanvas = document.getElementById("bwCanvas");
const bwCtx = bwCanvas.getContext("2d");

const donut = document.getElementById("donutCanvas");
const dctx = donut.getContext("2d");
const scoreText = document.getElementById("scoreText");
const peakScoreEl = document.getElementById("peakScore");

let peakScore = 0;

// === CAMERA INIT (TORCH ON) ===
navigator.mediaDevices.getUserMedia({
    video: {
        facingMode: { ideal: "environment" },
        focusMode: "continuous",
        exposureMode: "continuous",
        width: { ideal: 1920 },
        height: { ideal: 1080 }
    }
}).then(stream => {
    video.srcObject = stream;
    const track = stream.getVideoTracks()[0];
    try { track.applyConstraints({ advanced: [{ torch: true }] }); } catch {}
    const caps = track.getCapabilities?.();
    if (caps?.focusDistance) {
        track.applyConstraints({ advanced: [{ focusDistance: caps.focusDistance.min }] });
    }
});

// Resize
function resize() {
    const w = video.videoWidth || 640;
    const h = video.videoHeight || 480;
    maskCanvas.width = bwCanvas.width = w;
    maskCanvas.height = bwCanvas.height = h;
}
video.addEventListener("loadedmetadata", resize);

// === ROI ===
function drawROI() {
    const w = maskCanvas.width;
    const h = maskCanvas.height;
    const rw = w * 0.72;
    const rh = h * 0.48;
    const x = (w - rw) / 2;
    const y = h * 0.22;

    maskCtx.clearRect(0,0,w,h);
    maskCtx.fillStyle = "rgba(0,0,0,0.75)";
    maskCtx.fillRect(0,0,w,h);
    maskCtx.globalCompositeOperation = "destination-out";
    maskCtx.fillRect(x, y, rw, rh);
    maskCtx.globalCompositeOperation = "source-over";

    return { x, y, w: rw, h: rh };
}

// === DONUT ===
function drawDonut(score) {
    dctx.clearRect(0,0,140,140);
    const cx=70, cy=70, r=55;
    const start=-Math.PI/2;
    const end=start+2*Math.PI*score;
    const color = score<0.4?"#ff4444":score<0.7?"#ffaa00":"#00ff88";

    dctx.lineWidth=12;
    dctx.strokeStyle="#222";
    dctx.beginPath();
    dctx.arc(cx,cy,r,0,2*Math.PI);
    dctx.stroke();

    dctx.strokeStyle=color;
    dctx.beginPath();
    dctx.arc(cx,cy,r,start,end);
    dctx.stroke();
}

// === PROCESS LOOP WITH FINGER SEGMENTATION ===
function process() {
    if (!bwCanvas.width) return requestAnimationFrame(process);

    const roi = drawROI();

    bwCtx.drawImage(video, roi.x, roi.y, roi.w, roi.h, roi.x, roi.y, roi.w, roi.h);
    let img = bwCtx.getImageData(roi.x, roi.y, roi.w, roi.h);
    let d = img.data;

    let gray = new Uint8Array(d.length/4);
    let sum=0, sumSq=0;

    // Grayscale + contrast
    for (let i=0,j=0;i<d.length;i+=4,j++){
        let g = 0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
        g = Math.min(255, Math.max(0,(g-110)*1.8+128));
        gray[j]=g;
        sum+=g;
        sumSq+=g*g;
    }

    const mean = sum/gray.length;

    // Finger mask (skin-like region)
    let fingerMask = new Uint8Array(gray.length);
    let fingerPixels=0;

    for (let i=0;i<gray.length;i++){
        if (gray[i] > mean*0.6 && gray[i] < mean*1.2){
            fingerMask[i]=1;
            fingerPixels++;
        }
    }

    // Compute quality only on finger pixels
    let edges=0, varSum=0;
    for (let i=1;i<gray.length;i++){
        if (fingerMask[i]){
            let diff = Math.abs(gray[i]-gray[i-1]);
            edges+=diff;
            varSum+=(gray[i]-mean)*(gray[i]-mean);
        }
    }

    // Render BW fingerprint (finger-only)
    for (let i=0,j=0;i<d.length;i+=4,j++){
        let bw = fingerMask[j] ? (gray[j]<mean?0:255) : 0;
        d[i]=d[i+1]=d[i+2]=bw;
    }

    bwCtx.putImageData(img, roi.x, roi.y);

    // Normalize quality
    let rawScore = (edges + varSum) / Math.max(1,fingerPixels);
    let quality = Math.min(1, rawScore / 900);

    let percent = Math.round(quality*100);
    scoreText.textContent = percent+"%";
    drawDonut(quality);

    if (percent>peakScore){
        peakScore=percent;
        peakScoreEl.textContent=peakScore+"%";
    }

    requestAnimationFrame(process);
}

process();
</script>

</body>
</html>
