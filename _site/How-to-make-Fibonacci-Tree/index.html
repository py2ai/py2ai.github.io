

  <!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/Article">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Pinterest & Google verification -->
  <meta name="p:domain_verify" content="fb68a8459fe32b8b072bcd5cc620d125"/>
  <meta name="google-site-verification" content="WAkFPi5cvufClnQetgIl0STmvvwHhVf8jfyENFWhsxU" />
  <meta name="google-site-verification" content="g2pFZlv-92XQD67BPgiVHsvZ4TZH13Ucvmmvvv36kU4" />

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Recursive function to grow TREE in Python | PyShine</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Recursive function to grow TREE in Python" />
<meta name="author" content="PyShine Team" />
<meta property="og:locale" content="en" />
<meta name="description" content="Fibonacci Tree in python" />
<meta property="og:description" content="Fibonacci Tree in python" />
<link rel="canonical" href="http://localhost:4000/How-to-make-Fibonacci-Tree/" />
<meta property="og:url" content="http://localhost:4000/How-to-make-Fibonacci-Tree/" />
<meta property="og:site_name" content="PyShine" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-10-24T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Recursive function to grow TREE in Python" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"PyShine Team"},"dateModified":"2025-10-24T00:00:00+08:00","datePublished":"2025-10-24T00:00:00+08:00","description":"Fibonacci Tree in python","headline":"Recursive function to grow TREE in Python","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/How-to-make-Fibonacci-Tree/"},"name":"{{ page.title escape }}","url":"http://localhost:4000/How-to-make-Fibonacci-Tree/"}</script>
<!-- End Jekyll SEO tag -->


  <!-- Favicon & App Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/icons/apple-touch-icon.png?v=qA3OXqyw77">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/icons/favicon-32x32.png?v=qA3OXqyw77">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/icons/favicon-16x16.png?v=qA3OXqyw77">
  <link rel="manifest" href="/assets/img/icons/manifest.json?v=qA3OXqyw77">
  <link rel="mask-icon" href="/assets/img/icons/safari-pinned-tab.svg?v=qA3OXqyw77" color="#5bbad5">
  <link rel="shortcut icon" href="/assets/img/icons/favicon.ico?v=qA3OXqyw77">
  <!--[if IE]><link rel="shortcut icon" href="/assets/img/icons/favicon.ico?v=qA3OXqyw77"><![endif]-->

  <!-- App & Theme Info -->
  <meta name="apple-mobile-web-app-title" content="Sleek">
  <meta name="application-name" content="Sleek">
  <meta name="msapplication-config" content="/assets/img/icons/browserconfig.xml?v=qA3OXqyw77">
  <meta name="theme-color" content="#ffffff">

  
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-TCVFBKF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'GTM-TCVFBKF');
</script>

  

  <!-- Critical CSS Inline -->
  <style class="inlineCSS">
    h1{color:#313237;margin-top:0;margin-bottom:.5rem}.dark-bg{background-color:#19d319}@media (min-width:48em){.post-card{width:48.4375%;margin-right:3.125%}.post-card:last-of-type,.post-card:nth-child(2n+2){margin-right:0}}html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figure,main{display:block}figure{margin:1em 40px}a{background-color:transparent;-webkit-text-decoration-skip:objects}img{border-style:none}svg:not(:root){overflow:hidden}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{-webkit-box-sizing:border-box;box-sizing:border-box}body{-webkit-overflow-scrolling:touch}*,::after,::before{-webkit-box-sizing:inherit;box-sizing:inherit}.site{display:-webkit-box;display:-ms-flexbox;display:flex;min-height:100vh;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}.site__content{-webkit-box-flex:1;-ms-flex:1;flex:1}img{max-width:100%;height:auto;width:auto;vertical-align:middle}figure{margin:0}body{background-color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif;font-size:1rem;line-height:1.5;color:#343851;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%}p{margin-top:0;margin-bottom:1.25rem}h1,h2{color:#313237;margin-top:0;margin-bottom:.5rem}a{color:#277cea;text-decoration:none;border-bottom:1px dashed #277cea}.blur{background:#fff;filter:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="filter"><feGaussianBlur stdDeviation="16" /></filter></svg>#filter');-webkit-filter:blur(1rem);filter:blur(1rem)}.container{padding:0 20px}@media (min-width:0){.container{max-width:auto;margin:0 auto}}@media (min-width:36em){.container{max-width:540px;margin:0 auto}}@media (min-width:48em){.container{max-width:720px;margin:0 auto}}@media (min-width:62em){.container{max-width:960px;margin:0 auto}}@media (min-width:75em){.container{max-width:1170px;margin:0 auto}}.header{background-color:#fff;color:#343851;position:absolute;z-index:4;width:100%;top:0;left:0;will-change:transform;-webkit-transform:translateY(0);transform:translateY(0)}.header a{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-bottom:0}.header__logo{display:-webkit-box;display:-ms-flexbox;display:flex;height:100%;overflow:hidden;padding:19px 0;margin-right:1.25rem;outline:0;border-bottom:0;color:#313237}.header__logo .header__logo--container{width:58px}.header__logo .header__logo--container .logo{fill:currentColor}.header__inner{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:3.75em;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.header__links{padding-bottom:.5rem;display:none;position:absolute;top:3.75em;left:0;width:100%;height:auto;background:#fff}.header__link{color:#343851;padding:.938rem 0;border-top:1px solid #ededed}.header__toggle{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;width:44px;height:100%;background-color:transparent;padding-left:1.25rem}.header__toggle span{display:block;position:relative;margin-top:4px;background-color:#343851;width:100%;height:2px;border-radius:1px}.header__toggle span:first-child{margin-top:0}@media (min-width:62em){.header__toggle{display:none;visibility:hidden}.header__links{position:static;padding:0;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;visibility:visible;width:auto;height:100%}.header__links-wrapper{display:-webkit-box;display:-ms-flexbox;display:flex;height:100%;padding:0}.header__link{position:relative;padding:.938rem 1rem;border:0;height:100%}.header__link::after{content:"";display:block;position:absolute;left:0;bottom:0;height:3px;width:100%;-webkit-transform:scaleX(0);transform:scaleX(0);background:#277cea}}.post-card{display:block;position:relative;width:100%;min-height:250px;border-radius:4px;overflow:hidden;background-color:#fff;-webkit-box-shadow:0 1px 3px rgba(0,0,0,.08);box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:2.25rem;border-bottom:0}@media (min-width:48em){.post-card{width:48.4375%;margin-right:3.125%}.post-card:nth-child(2n+2){margin-right:0}}@media (min-width:75em){.post-card{width:31.25%;margin-right:3.125%}.post-card:nth-child(2n+2){margin-right:3.125%}}.post-card__label{position:absolute;top:1.5rem;left:1.5rem;z-index:2}.post-card__thumb{margin:0;background:#fff;position:relative;overflow:hidden}.post-card__thumb::after{content:"";display:block;height:0;width:100%;padding-bottom:56.25%}.post-card__thumb>*{position:absolute;top:0;left:0;width:100%;height:100%;display:block}.post-card__inner{padding:1.875rem 1.25rem .625rem;color:#838c8d}.post-card__header{margin-bottom:.75rem}.post-card__header .post-card__meta{font-size:.875rem}.label{padding:0 10px;margin-bottom:1rem;display:inline-block;line-height:20px;font-size:.75rem;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.8);border:2px solid rgba(255,255,255,.5);border-radius:100px}.hero{margin:3.75rem auto 0;min-height:16.25rem;width:100%;position:relative;background-color:#dde5ea;background-repeat:no-repeat;background-position:50%;background-size:cover}@media (min-width:62em){.hero{margin:0 auto;height:36em}}.hero::before{position:absolute;display:block;content:"";top:0;left:0;width:100%;height:100%;background:rgba(52,56,81,.8)}.hero__wrap{position:absolute;margin:auto;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);text-align:center;color:rgba(255,255,255,.8);width:100%;max-width:90%;z-index:1}.hero__wrap .hero__title{font-size:1.8em;color:#fff}.blog{background-color:#f9f9f9}.post-list{padding-top:2.5em;display:-webkit-box;display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-flex:1;-ms-flex:1 0 auto;flex:1 0 auto}@media (min-width:48em){.hero__wrap{max-width:40em}.hero__wrap .hero__title{padding:1rem 0;font-size:2.625em;line-height:3.125rem}.post-list{padding-top:5em}}
  </style>

  <!-- Main CSS -->
  <link rel="preload" href="/assets/css/main.css" as="style" onload="this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/assets/css/main.css"></noscript>

  <script type="text/javascript">
    /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
(function(w){"use strict";if(!w.loadCSS){w.loadCSS=function(){}}
var rp=loadCSS.relpreload={};rp.support=(function(){var ret;try{ret=w.document.createElement("link").relList.supports("preload")}catch(e){ret=!1}
return function(){return ret}})();rp.bindMediaToggle=function(link){var finalMedia=link.media||"all";function enableStylesheet(){link.media=finalMedia}
if(link.addEventListener){link.addEventListener("load",enableStylesheet)}else if(link.attachEvent){link.attachEvent("onload",enableStylesheet)}
setTimeout(function(){link.rel="stylesheet";link.media="only x"});setTimeout(enableStylesheet,3000)};rp.poly=function(){if(rp.support()){return}
var links=w.document.getElementsByTagName("link");for(var i=0;i<links.length;i++){var link=links[i];if(link.rel==="preload"&&link.getAttribute("as")==="style"&&!link.getAttribute("data-loadcss")){link.setAttribute("data-loadcss",!0);rp.bindMediaToggle(link)}}};if(!rp.support()){rp.poly();var run=w.setInterval(rp.poly,500);if(w.addEventListener){w.addEventListener("load",function(){rp.poly();w.clearInterval(run)})}else if(w.attachEvent){w.attachEvent("onload",function(){rp.poly();w.clearInterval(run)})}}
if(typeof exports!=="undefined"){exports.loadCSS=loadCSS}
else{w.loadCSS=loadCSS}}(typeof global!=="undefined"?global:this))

  </script>

  <!-- MathJax -->
  <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
</head>


  <body class="site" itemscope itemtype="https://schema.org/WebPage">

    
      <!-- Google Tag Manager (noscript) -->
      <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TCVFBKF"
                height="0" width="0" style="display:none;visibility:hidden"></iframe>
      </noscript>
      <!-- End Google Tag Manager -->
    

    <header class="header" itemscope itemtype="http://schema.org/SiteNavigationElement" aria-label="Main navigation">
  <div class="container">
    <div class="header__inner">
      <!-- Logo -->
      <a class="header__logo" href="/">
        <div class="header__logo--container">
          <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24" enable-background="new 0 0 24 24" xml:space="preserve">
<g>
	<path d="M18.121,9.88l-7.832-7.836c-0.155-0.158-0.428-0.155-0.584,0L1.842,9.913c-0.262,0.263-0.073,0.705,0.292,0.705h2.069v7.042c0,0.227,0.187,0.414,0.414,0.414h3.725c0.228,0,0.414-0.188,0.414-0.414v-3.313h2.483v3.313c0,0.227,0.187,0.414,0.413,0.414h3.726c0.229,0,0.414-0.188,0.414-0.414v-7.042h2.068h0.004C18.331,10.617,18.389,10.146,18.121,9.88 M14.963,17.245h-2.896v-3.313c0-0.229-0.186-0.415-0.414-0.415H8.342c-0.228,0-0.414,0.187-0.414,0.415v3.313H5.032v-6.628h9.931V17.245z M3.133,9.79l6.864-6.868l6.867,6.868H3.133z"></path>

	
	
</g>
</svg>

        </div>
      </a>

      <!-- Navigation Links -->
      <nav class="header__links">
        <div class="container header__links-wrapper">
          
            <a class="header__link" href="/" itemprop="url">
              <span itemprop="name">Home</span>
            </a>
          
            <a class="header__link" href="/converter.html" itemprop="url">
              <span itemprop="name">Free PNG Converter</span>
            </a>
          
            <a class="header__link" href="/categories" itemprop="url">
              <span itemprop="name">Categories</span>
            </a>
          
            <a class="header__link" href="/about" itemprop="url">
              <span itemprop="name">About</span>
            </a>
          
            <a class="header__link" href="/contact" itemprop="url">
              <span itemprop="name">Contact</span>
            </a>
          
            <a class="header__link" href="/privacy" itemprop="url">
              <span itemprop="name">Privacy Policy</span>
            </a>
          
            <a class="header__link" href="/disclaimer" itemprop="url">
              <span itemprop="name">Disclaimer</span>
            </a>
          
        </div>
      </nav>

      <!-- Mobile Menu Toggle -->
      <div class="header__toggle" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Recursive function to grow TREE in Python | PyShine</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Recursive function to grow TREE in Python" />
<meta name="author" content="PyShine Team" />
<meta property="og:locale" content="en" />
<meta name="description" content="Fibonacci Tree in python" />
<meta property="og:description" content="Fibonacci Tree in python" />
<link rel="canonical" href="http://localhost:4000/How-to-make-Fibonacci-Tree/" />
<meta property="og:url" content="http://localhost:4000/How-to-make-Fibonacci-Tree/" />
<meta property="og:site_name" content="PyShine" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-10-24T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Recursive function to grow TREE in Python" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"PyShine Team"},"dateModified":"2025-10-24T00:00:00+08:00","datePublished":"2025-10-24T00:00:00+08:00","description":"Fibonacci Tree in python","headline":"Recursive function to grow TREE in Python","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/How-to-make-Fibonacci-Tree/"},"name":"{{ page.title escape }}","url":"http://localhost:4000/How-to-make-Fibonacci-Tree/"}</script>
<!-- End Jekyll SEO tag -->

</header>


    
      <div class="hero dark-bg" role="img" aria-label="Recursive function to grow TREE in Python">
    
        <div class="hero__wrap">
          
            <div class="hero__categories">
              
            </div>
          

          <h1 class="hero__title" itemprop="headline">Recursive function to grow TREE in Python</h1>

          <p class="hero__meta">
            <time datetime="2025-10-24T00:00:00+08:00" itemprop="datePublished">
              24 Oct 2025
            </time>
            &nbsp;·&nbsp;
            
            <span itemprop="timeRequired">
              
                23 mins read
              
            </span>
          </p>
        </div>
      </div>

    <main class="site__content" role="main">
      <div class="container">

        <article class="post-content"
                 itemprop="articleBody"
                 itemscope itemtype="https://schema.org/Article">
          
          <h1 id="fibonacci-tree-growth-multithreaded">Fibonacci Tree Growth (Multithreaded)</h1>

<blockquote>
  <p>A detailed, step-by-step tutorial explaining a Pygame program that draws a Fibonacci-based tree. This tutorial shows how the original recursive growth works and how to modify it so branches grow in parallel using multithreading (safe and practical approach).</p>
</blockquote>

<h2 id="table-of-contents">Table of contents</h2>

<h2 id="table-of-contents-1">Table of Contents</h2>
<ul>
  <li><a href="#1-introduction">Introduction</a></li>
  <li><a href="#2-prerequisites">Prerequisites</a></li>
  <li><a href="#3-project-structure">Project Structure</a></li>
  <li><a href="#4-simple-code">Full Original Code</a></li>
  <li><a href="#5-deep-explanation--line-by-line-and-concept-by-concept">Deep Explanation — Line by Line and Concept by Concept</a></li>
  <li><a href="#6-why-and-when-to-parallelize">Why and When to Parallelize</a></li>
  <li><a href="#7-design-choices-for-multithreading">Design Choices for Multithreading</a></li>
  <li><a href="#8-multithreaded-implementation--full-code">Multithreaded Implementation — Full Code</a></li>
  <li><a href="#9-how-to-run-and-test">How to Run and Test</a></li>
  <li><a href="#10-performance-considerations--debugging-tips">Performance Considerations &amp; Debugging Tips</a></li>
  <li><a href="#11-faq-and-closing-notes">FAQ and Closing Notes</a></li>
</ul>

<h2 id="1-introduction">1. Introduction</h2>

<p>This tutorial teaches you how a small Pygame program simulates a fractal, Fibonacci-based tree. Branch lengths and spreads follow Fibonacci-derived ratios so the resulting shape looks natural and organic.</p>

<p>You’ll see:</p>
<ul>
  <li>How the recursive <code class="language-plaintext highlighter-rouge">grow()</code> function builds branches.</li>
  <li>Why some branches look thicker or greener.</li>
  <li>How to convert the growth stage into parallel tasks so multiple branches can be computed at the same time, using Python threads.</li>
</ul>

<p>The tutorial ends with a complete multithreaded version ready to copy and run.</p>

<h2 id="2-prerequisites">2. Prerequisites</h2>

<ul>
  <li>Python 3.8+ (works well with 3.10 / 3.11)</li>
  <li><code class="language-plaintext highlighter-rouge">pygame</code> installed (<code class="language-plaintext highlighter-rouge">pip install pygame</code>)</li>
  <li>Basic knowledge of Python functions and threading concepts</li>
  <li>Optional: <code class="language-plaintext highlighter-rouge">concurrent.futures</code> familiarity</li>
</ul>

<h2 id="3-project-structure">3. Project structure</h2>

<p>Single file: <code class="language-plaintext highlighter-rouge">fibonacci_tree_parallel.py</code> . Run it with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python fibonacci_tree_parallel.py
</code></pre></div></div>

<h2 id="4-simple-code">4. Simple code</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pygame</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">random</span>

<span class="c1"># INITIAL SETUP 
</span><span class="n">pygame</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>

<span class="n">WIN_WIDTH</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">600</span>
<span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">WIN_WIDTH</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span><span class="p">))</span>
<span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s">"Fibonacci Tree Growth"</span><span class="p">)</span>

<span class="c1"># COLOR DEFINITIONS 
</span><span class="n">SKY_COLOR</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">135</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">235</span><span class="p">)</span>
<span class="n">BROWN_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">139</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span>
<span class="n">GREEN_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span>

<span class="c1"># TREE PARAMETERS 
</span><span class="n">GROUND_HEIGHT</span>   <span class="o">=</span> <span class="mi">50</span>
<span class="n">TREE_DEPTH</span>      <span class="o">=</span> <span class="mi">10</span>
<span class="n">BRANCH_WIDTH</span>    <span class="o">=</span> <span class="mi">20</span>
<span class="n">SPREAD_BASE</span>     <span class="o">=</span> <span class="mi">25</span>
<span class="n">SPREAD_FACTOR</span>   <span class="o">=</span> <span class="mi">70</span>         <span class="c1"># slightly larger spread for wider crown
</span><span class="n">LENGTH_DECAY</span>    <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">LENGTH_VARIANCE</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">BRANCH_STEP</span>     <span class="o">=</span> <span class="mi">3</span>
<span class="n">FPS</span>             <span class="o">=</span> <span class="mi">60</span>

<span class="c1"># FONT 
</span><span class="n">font</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">font</span><span class="p">.</span><span class="n">SysFont</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># GLOBALS 
</span><span class="n">branches</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">draw_step</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># FIBONACCI FUNCTION 
</span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="s">"""Return the nth Fibonacci number."""</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="c1"># TREE GENERATION 
</span><span class="k">def</span> <span class="nf">grow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
    <span class="s">"""
    Recursive Fibonacci-based branching function.
    Ensures branches stay mostly above the horizon and spread outward naturally.
    """</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">end_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span>
    <span class="n">end_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">math</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span>

    <span class="c1"># prevent branches from going below the ground
</span>    <span class="k">if</span> <span class="n">end_y</span> <span class="o">&gt;</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span><span class="p">:</span>
        <span class="n">end_y</span> <span class="o">=</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span>

    <span class="c1"># add this branch
</span>    <span class="n">branches</span><span class="p">.</span><span class="n">append</span><span class="p">(((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">end_x</span><span class="p">,</span> <span class="n">end_y</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">depth</span><span class="p">))</span>

    <span class="c1"># Fibonacci ratio scaling
</span>    <span class="n">f_ratio</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fib</span><span class="p">(</span><span class="n">TREE_DEPTH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="n">SPREAD_BASE</span> <span class="o">+</span> <span class="n">SPREAD_FACTOR</span> <span class="o">*</span> <span class="n">f_ratio</span>

    <span class="c1"># number of child branches
</span>    <span class="n">sub_branches</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span>

    <span class="c1"># nonlinear upward bias — keeps branches from pointing downward
</span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sub_branches</span><span class="p">):</span>
        <span class="n">new_length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="p">(</span><span class="n">LENGTH_DECAY</span> <span class="o">+</span> <span class="n">LENGTH_VARIANCE</span> <span class="o">*</span> <span class="n">f_ratio</span><span class="p">)</span>
        
        <span class="c1"># bias the angle upwards: restrict below horizontal (no downward growth)
</span>        <span class="n">bias</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">spread</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
        <span class="n">new_angle</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">+</span> <span class="n">bias</span>

        <span class="c1"># Clamp angles: ensure they stay above -90 (horizontal) and below 90
</span>        <span class="n">new_angle</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="n">new_angle</span><span class="p">))</span>

        <span class="n">new_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">))</span>
        <span class="n">grow</span><span class="p">(</span><span class="n">end_x</span><span class="p">,</span> <span class="n">end_y</span><span class="p">,</span> <span class="n">new_length</span><span class="p">,</span> <span class="n">new_angle</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_width</span><span class="p">)</span>

<span class="c1"># INITIAL TREE CREATION 
</span><span class="n">INITIAL_LENGTH</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="mi">120</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">TREE_DEPTH</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">grow</span><span class="p">(</span><span class="n">WIN_WIDTH</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span><span class="p">,</span> <span class="n">INITIAL_LENGTH</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TREE_DEPTH</span><span class="p">,</span> <span class="n">BRANCH_WIDTH</span><span class="p">)</span>

<span class="c1"># CLOCK 
</span><span class="n">clock</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">Clock</span><span class="p">()</span>

<span class="c1"># MAIN LOOP 
</span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="p">.</span><span class="n">QUIT</span><span class="p">:</span>
            <span class="n">pygame</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="p">.</span><span class="n">MOUSEBUTTONDOWN</span><span class="p">:</span>
            <span class="n">started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">screen</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">SKY_COLOR</span><span class="p">)</span>
    <span class="n">pygame</span><span class="p">.</span><span class="n">draw</span><span class="p">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">GREEN_COLOR</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span><span class="p">,</span> <span class="n">WIN_WIDTH</span><span class="p">,</span> <span class="n">GROUND_HEIGHT</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">started</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"CLICK TO START"</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">GREEN_COLOR</span><span class="p">)</span>
        <span class="n">screen</span><span class="p">.</span><span class="n">blit</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="n">WIN_WIDTH</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">msg</span><span class="p">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">draw_step</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">draw_step</span> <span class="o">+</span> <span class="n">BRANCH_STEP</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">))</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">[:</span><span class="n">draw_step</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">BROWN_COLOR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">BROWN_COLOR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">GREEN_COLOR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">pygame</span><span class="p">.</span><span class="n">draw</span><span class="p">.</span><span class="n">line</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="sa">f</span><span class="s">"BRANCH COUNT: </span><span class="si">{</span><span class="n">draw_step</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">GREEN_COLOR</span><span class="p">)</span>
        <span class="n">screen</span><span class="p">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="n">WIN_WIDTH</span> <span class="o">-</span> <span class="n">text</span><span class="p">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">flip</span><span class="p">()</span>
    <span class="n">clock</span><span class="p">.</span><span class="n">tick</span><span class="p">(</span><span class="n">FPS</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="5-deep-explanation--line-by-line-and-concept-by-concept">5. Deep explanation — line by line and concept by concept</h2>

<p>I’ll walk through the important pieces and why they exist.</p>

<h3 id="a-initialization-and-constants">a) Initialization and constants</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pygame.init()</code> starts Pygame.</li>
  <li><code class="language-plaintext highlighter-rouge">WIN_WIDTH</code>, <code class="language-plaintext highlighter-rouge">WIN_HEIGHT</code> — screen size.</li>
  <li>Color constants defined as RGB tuples.</li>
  <li>Tree parameters such as <code class="language-plaintext highlighter-rouge">TREE_DEPTH</code>, <code class="language-plaintext highlighter-rouge">BRANCH_WIDTH</code>, <code class="language-plaintext highlighter-rouge">SPREAD_BASE</code>, etc., control how deep the recursion goes, how thick branches start, and how widely they spread.</li>
</ul>

<p><strong>Tip:</strong> Keep <code class="language-plaintext highlighter-rouge">TREE_DEPTH</code> moderate (7–12). Too large creates many branches and can slow rendering and thread overhead.</p>

<h3 id="b-fibonacci-function">b) Fibonacci function</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span>
</code></pre></div></div>

<ul>
  <li>Returns the nth Fibonacci number (1-indexed here).</li>
  <li>Used to compute ratios that change with depth — making lower/higher branches differ organically.</li>
</ul>

<h3 id="c-recursive-growth-grow">c) Recursive growth: <code class="language-plaintext highlighter-rouge">grow()</code></h3>

<p><code class="language-plaintext highlighter-rouge">grow(x, y, length, angle, depth, width)</code> does the heavy lifting.</p>

<p>Key steps inside:</p>
<ol>
  <li>Base case: stop when depth &lt;= 0 or length is tiny.</li>
  <li>Compute end coordinates using trigonometry:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">end_x = x + sin(angle) * length</code></li>
      <li><code class="language-plaintext highlighter-rouge">end_y = y - cos(angle) * length</code></li>
    </ul>
  </li>
  <li>Prevent branches dipping below the ground by clamping <code class="language-plaintext highlighter-rouge">end_y</code>.</li>
  <li>Append the branch to the <code class="language-plaintext highlighter-rouge">branches</code> list: <code class="language-plaintext highlighter-rouge">branches.append(((x, y), (end_x, end_y), width, depth))</code>.</li>
  <li>Compute Fibonacci-based scale <code class="language-plaintext highlighter-rouge">f_ratio</code> and <code class="language-plaintext highlighter-rouge">spread</code> to determine how much children diverge.</li>
  <li>Decide <code class="language-plaintext highlighter-rouge">sub_branches</code> — number of children, varied with Fibonacci.</li>
  <li>Loop through children, derive <code class="language-plaintext highlighter-rouge">new_length</code>, <code class="language-plaintext highlighter-rouge">new_angle</code> (biased upwards), clamp angles, reduce width, then recursively call <code class="language-plaintext highlighter-rouge">grow()</code> with <code class="language-plaintext highlighter-rouge">depth - 1</code>.</li>
</ol>

<p>This recursion builds a flattened list <code class="language-plaintext highlighter-rouge">branches</code> which is later drawn progressively in the main loop.</p>

<h3 id="d-drawing-loop-and-draw_step">d) Drawing loop and <code class="language-plaintext highlighter-rouge">draw_step</code></h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">branches</code> is precomputed once by <code class="language-plaintext highlighter-rouge">grow(...)</code> starting at the trunk base.</li>
  <li>Once user clicks, <code class="language-plaintext highlighter-rouge">draw_step</code> increases and the program draws <code class="language-plaintext highlighter-rouge">branches[:draw_step]</code> to animate growth.</li>
  <li>Color interpolation between brown and green depends on depth to simulate branch → leaf transition.</li>
</ul>

<h2 id="6-why-and-when-to-parallelize">6. Why and when to parallelize</h2>

<p>The algorithm is CPU-heavy when <code class="language-plaintext highlighter-rouge">TREE_DEPTH</code> is high — recursively creating many branches. Parallelizing the <strong>generation</strong> (not the drawing) can bring speed benefits on multicore machines.</p>

<p><strong>Important</strong>: Pygame drawing calls must happen in the main thread on many platforms. So you parallelize only the computationally heavy part: generating branch geometry (<code class="language-plaintext highlighter-rouge">branches</code> list). Drawing stays single-threaded.</p>

<p>When to parallelize:</p>
<ul>
  <li>If <code class="language-plaintext highlighter-rouge">TREE_DEPTH &gt;= 11</code> or you notice long pauses at startup while branches are computed.</li>
  <li>If you want quicker precomputation before animating the growth.</li>
</ul>

<h2 id="7-design-choices-for-multithreading">7. Design choices for multithreading</h2>

<p>Options:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">threading.Thread</code> and manual queue/lock management.</li>
  <li><code class="language-plaintext highlighter-rouge">concurrent.futures.ThreadPoolExecutor</code> — simpler, higher-level.</li>
</ul>

<p>Constraints &amp; safety:</p>
<ul>
  <li>The shared <code class="language-plaintext highlighter-rouge">branches</code> list must be protected by a <code class="language-plaintext highlighter-rouge">threading.Lock</code> during append operations.</li>
  <li>Avoid creating thousands of concurrent threads. Use a bounded pool (<code class="language-plaintext highlighter-rouge">max_workers = min(32, os.cpu_count() or 4)</code>) to limit resource usage.</li>
  <li>Keep recursion depth per thread modest; better approach: have each submitted task compute an entire subtree (e.g., <code class="language-plaintext highlighter-rouge">grow()</code> from a given node down to a shallow depth) and append the resulting local list to the global list under a lock.</li>
</ul>

<p>Strategy implemented below:</p>
<ul>
  <li>The main <code class="language-plaintext highlighter-rouge">grow_parallel()</code> will push top-level child <code class="language-plaintext highlighter-rouge">grow</code> tasks into an executor.</li>
  <li>Each worker runs a variant <code class="language-plaintext highlighter-rouge">grow_worker()</code> that returns a local list of branches for that subtree.</li>
  <li>The main thread collects futures and merges results into the global <code class="language-plaintext highlighter-rouge">branches</code> once each future completes (safe merging under lock).</li>
</ul>

<p>This design reduces lock contention (threads only lock briefly to append a chunk) and keeps Pygame drawing safe.</p>

<h2 id="8-multithreaded-implementation--full-code">8. Multithreaded implementation — full code</h2>

<p>Copy this file as <code class="language-plaintext highlighter-rouge">fibonacci_tree_parallel.py</code> and run it. This includes the parallel <code class="language-plaintext highlighter-rouge">generate_tree()</code> which uses <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code> and a safe <code class="language-plaintext highlighter-rouge">branches</code> merge.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pygame</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># INITIAL SETUP
</span><span class="n">pygame</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
<span class="n">WIN_WIDTH</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">600</span>
<span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">WIN_WIDTH</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span><span class="p">))</span>
<span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s">"Fibonacci Tree Growth (Multithreaded)"</span><span class="p">)</span>

<span class="c1"># COLORS
</span><span class="n">SKY_COLOR</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">135</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">235</span><span class="p">)</span>
<span class="n">BROWN_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">139</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span>
<span class="n">GREEN_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span>

<span class="c1"># TREE PARAMETERS
</span><span class="n">GROUND_HEIGHT</span>   <span class="o">=</span> <span class="mi">50</span>
<span class="n">TREE_DEPTH</span>      <span class="o">=</span> <span class="mi">10</span>
<span class="n">BRANCH_WIDTH</span>    <span class="o">=</span> <span class="mi">20</span>
<span class="n">SPREAD_BASE</span>     <span class="o">=</span> <span class="mi">25</span>
<span class="n">SPREAD_FACTOR</span>   <span class="o">=</span> <span class="mi">70</span>
<span class="n">LENGTH_DECAY</span>    <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">LENGTH_VARIANCE</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">BRANCH_STEP</span>     <span class="o">=</span> <span class="mi">3</span>
<span class="n">FPS</span>             <span class="o">=</span> <span class="mi">60</span>

<span class="n">font</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">font</span><span class="p">.</span><span class="n">SysFont</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># GLOBALS
</span><span class="n">branches</span> <span class="o">=</span> <span class="p">[]</span>             <span class="c1"># global branch list used by the renderer
</span><span class="n">branches_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>  <span class="c1"># protect writes to `branches`
</span><span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># FIB
</span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="c1"># Worker-grow produces a local list and returns it (no shared writes).
</span><span class="k">def</span> <span class="nf">grow_worker</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">tree_depth</span><span class="p">):</span>
    <span class="n">local</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">end_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span>
        <span class="n">end_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">math</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span>
        <span class="k">if</span> <span class="n">end_y</span> <span class="o">&gt;</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span><span class="p">:</span>
            <span class="n">end_y</span> <span class="o">=</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span>
        <span class="n">local</span><span class="p">.</span><span class="n">append</span><span class="p">(((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">end_x</span><span class="p">,</span> <span class="n">end_y</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">depth</span><span class="p">))</span>

        <span class="n">f_ratio</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fib</span><span class="p">(</span><span class="n">tree_depth</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">SPREAD_BASE</span> <span class="o">+</span> <span class="n">SPREAD_FACTOR</span> <span class="o">*</span> <span class="n">f_ratio</span>
        <span class="n">sub_branches</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sub_branches</span><span class="p">):</span>
            <span class="n">new_length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="p">(</span><span class="n">LENGTH_DECAY</span> <span class="o">+</span> <span class="n">LENGTH_VARIANCE</span> <span class="o">*</span> <span class="n">f_ratio</span><span class="p">)</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">spread</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
            <span class="n">new_angle</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">+</span> <span class="n">bias</span>
            <span class="n">new_angle</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="n">new_angle</span><span class="p">))</span>
            <span class="n">new_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">))</span>
            <span class="n">_g</span><span class="p">(</span><span class="n">end_x</span><span class="p">,</span> <span class="n">end_y</span><span class="p">,</span> <span class="n">new_length</span><span class="p">,</span> <span class="n">new_angle</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_width</span><span class="p">)</span>

    <span class="n">_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">local</span>

<span class="c1"># Multithreaded generation that submits the trunk's immediate children as tasks.
</span><span class="k">def</span> <span class="nf">generate_tree_parallel</span><span class="p">(</span><span class="n">root_x</span><span class="p">,</span> <span class="n">root_y</span><span class="p">,</span> <span class="n">initial_length</span><span class="p">,</span> <span class="n">root_depth</span><span class="p">,</span> <span class="n">root_width</span><span class="p">):</span>
    <span class="c1"># We'll compute the trunk synchronously, then spawn worker tasks for each top-level child subtree.
</span>    <span class="k">global</span> <span class="n">branches</span>
    <span class="n">branches</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Add trunk (depth=root_depth)
</span>    <span class="n">rad</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">trunk_end_x</span> <span class="o">=</span> <span class="n">root_x</span> <span class="o">+</span> <span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">initial_length</span>
    <span class="n">trunk_end_y</span> <span class="o">=</span> <span class="n">root_y</span> <span class="o">-</span> <span class="n">math</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">initial_length</span>
    <span class="k">if</span> <span class="n">trunk_end_y</span> <span class="o">&gt;</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span><span class="p">:</span>
        <span class="n">trunk_end_y</span> <span class="o">=</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span>
    <span class="n">branches</span><span class="p">.</span><span class="n">append</span><span class="p">(((</span><span class="n">root_x</span><span class="p">,</span> <span class="n">root_y</span><span class="p">),</span> <span class="p">(</span><span class="n">trunk_end_x</span><span class="p">,</span> <span class="n">trunk_end_y</span><span class="p">),</span> <span class="n">root_width</span><span class="p">,</span> <span class="n">root_depth</span><span class="p">))</span>

    <span class="c1"># Prepare tasks for child subtrees emerging from trunk_end
</span>    <span class="n">f_ratio</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="n">root_depth</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">fib</span><span class="p">(</span><span class="n">TREE_DEPTH</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="n">SPREAD_BASE</span> <span class="o">+</span> <span class="n">SPREAD_FACTOR</span> <span class="o">*</span> <span class="n">f_ratio</span>
    <span class="n">sub_branches</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">root_depth</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span>

    <span class="c1"># Decide worker pool size
</span>    <span class="n">max_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sub_branches</span><span class="p">):</span>
            <span class="n">new_length</span> <span class="o">=</span> <span class="n">initial_length</span> <span class="o">*</span> <span class="p">(</span><span class="n">LENGTH_DECAY</span> <span class="o">+</span> <span class="n">LENGTH_VARIANCE</span> <span class="o">*</span> <span class="n">f_ratio</span><span class="p">)</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">spread</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
            <span class="n">new_angle</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="n">bias</span><span class="p">))</span>
            <span class="n">new_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">root_width</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">))</span>
            <span class="c1"># Submit each subtree
</span>            <span class="n">futures</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">grow_worker</span><span class="p">,</span> <span class="n">trunk_end_x</span><span class="p">,</span> <span class="n">trunk_end_y</span><span class="p">,</span> <span class="n">new_length</span><span class="p">,</span> <span class="n">new_angle</span><span class="p">,</span> <span class="n">root_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_width</span><span class="p">,</span> <span class="n">TREE_DEPTH</span><span class="p">))</span>

        <span class="c1"># As futures complete, merge their local lists into the global branches list with minimal locking.
</span>        <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
            <span class="n">local_branches</span> <span class="o">=</span> <span class="n">fut</span><span class="p">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">branches_lock</span><span class="p">:</span>
                <span class="n">branches</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">local_branches</span><span class="p">)</span>

<span class="c1"># INITIAL TREE CREATION (parallel)
</span><span class="n">INITIAL_LENGTH</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="mi">120</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">TREE_DEPTH</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="c1"># generate using parallel generator
</span><span class="n">generate_tree_parallel</span><span class="p">(</span><span class="n">WIN_WIDTH</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span><span class="p">,</span> <span class="n">INITIAL_LENGTH</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TREE_DEPTH</span><span class="p">,</span> <span class="n">BRANCH_WIDTH</span><span class="p">)</span>

<span class="c1"># CLOCK
</span><span class="n">clock</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">Clock</span><span class="p">()</span>

<span class="c1"># MAIN LOOP
</span><span class="n">clock</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">Clock</span><span class="p">()</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="p">.</span><span class="n">QUIT</span><span class="p">:</span>
            <span class="n">pygame</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="p">.</span><span class="n">MOUSEBUTTONDOWN</span><span class="p">:</span>
            <span class="n">started</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">screen</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">SKY_COLOR</span><span class="p">)</span>
    <span class="n">pygame</span><span class="p">.</span><span class="n">draw</span><span class="p">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">GREEN_COLOR</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span> <span class="o">-</span> <span class="n">GROUND_HEIGHT</span><span class="p">,</span> <span class="n">WIN_WIDTH</span><span class="p">,</span> <span class="n">GROUND_HEIGHT</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">started</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"CLICK TO START"</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">GREEN_COLOR</span><span class="p">)</span>
        <span class="n">screen</span><span class="p">.</span><span class="n">blit</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="n">WIN_WIDTH</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">msg</span><span class="p">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">WIN_HEIGHT</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># animate growth
</span>        <span class="n">draw_step</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">),</span> <span class="p">(</span><span class="n">pygame</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">get_ticks</span><span class="p">()</span> <span class="o">//</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">[:</span><span class="n">draw_step</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">BROWN_COLOR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">BROWN_COLOR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">GREEN_COLOR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">pygame</span><span class="p">.</span><span class="n">draw</span><span class="p">.</span><span class="n">line</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="sa">f</span><span class="s">"BRANCH COUNT: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">draw_step</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">))</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">GREEN_COLOR</span><span class="p">)</span>
        <span class="n">screen</span><span class="p">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="n">WIN_WIDTH</span> <span class="o">-</span> <span class="n">text</span><span class="p">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">flip</span><span class="p">()</span>
    <span class="n">clock</span><span class="p">.</span><span class="n">tick</span><span class="p">(</span><span class="n">FPS</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Notes about the code above</strong>:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">grow_worker()</code> performs the recursion only <em>locally</em> and returns a <code class="language-plaintext highlighter-rouge">local</code> list of branches rather than appending to a global list while computing. This avoids heavy lock contention.</li>
  <li><code class="language-plaintext highlighter-rouge">generate_tree_parallel()</code> handles trunk creation synchronously, then schedules multiple subtree computations via <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code>. When a future completes, its result is merged into <code class="language-plaintext highlighter-rouge">branches</code> under <code class="language-plaintext highlighter-rouge">branches_lock</code>.</li>
  <li>The renderer still draws from <code class="language-plaintext highlighter-rouge">branches</code> on the main thread.</li>
</ul>

<h2 id="9-how-to-run-and-test">9. How to run and test</h2>

<ol>
  <li>Save the file as <code class="language-plaintext highlighter-rouge">fibonacci_tree_parallel.py</code>.</li>
  <li>Install pygame if necessary: <code class="language-plaintext highlighter-rouge">pip install pygame</code>.</li>
  <li>Run: <code class="language-plaintext highlighter-rouge">python fibonacci_tree_parallel.py</code>.</li>
  <li>Click the window to start the growth animation.</li>
</ol>

<p><strong>Testing tips</strong>:</p>
<ul>
  <li>Try small/large <code class="language-plaintext highlighter-rouge">TREE_DEPTH</code> values to observe performance changes.</li>
  <li>Toggle <code class="language-plaintext highlighter-rouge">max_workers</code> or the strategy to see CPU/time tradeoffs.</li>
</ul>

<h2 id="10-performance-considerations--debugging-tips">10. Performance considerations &amp; debugging tips</h2>

<ul>
  <li>
    <p>Python threads are limited by the Global Interpreter Lock (GIL) for pure-Python CPU-bound tasks. However, splitting heavy recursion into multiple threads often helps if some operations release the GIL (not the case here) OR if overhead (waiting for random numbers, I/O) exists. Still, for pure CPU-bound tasks, <code class="language-plaintext highlighter-rouge">multiprocessing</code> may give better scaling. The thread approach helps eliminate GUI freeze because branch generation tasks are off the main thread.</p>
  </li>
  <li>
    <p>If you want true parallel CPU utilization for heavy depth, consider <code class="language-plaintext highlighter-rouge">multiprocessing</code> instead. It requires serializing results between processes (e.g., <code class="language-plaintext highlighter-rouge">multiprocessing.Pool</code>), but it avoids the GIL.</p>
  </li>
  <li>
    <p>Keep <code class="language-plaintext highlighter-rouge">branches</code> merging minimal and batched. Appending many single branches under a lock causes contention. Returning a local list and merging it once avoids this.</p>
  </li>
  <li>
    <p>On Windows, <code class="language-plaintext highlighter-rouge">pygame</code> must run in the main thread. Don’t attempt to call Pygame display or drawing from worker threads.</p>
  </li>
</ul>

<h2 id="11-faq-and-closing-notes">11. FAQ and closing notes</h2>

<p><strong>Q: Why not call <code class="language-plaintext highlighter-rouge">grow()</code> directly in multiple threads (no <code class="language-plaintext highlighter-rouge">local</code> lists)?</strong>
A: That creates lock contention (every branch append needs a lock) and increases the chance of subtle bugs. Using local results and merging is safer and faster.</p>

<p><strong>Q: Can I parallelize drawing?</strong>
A: No — drawing must stay in the main thread for portability and correctness.</p>

<p><strong>Q: When should I use <code class="language-plaintext highlighter-rouge">multiprocessing</code> instead?</strong>
A: Use it when <code class="language-plaintext highlighter-rouge">TREE_DEPTH</code> is large (e.g., 12+) and CPU usage is the bottleneck. It has higher overhead but avoids the GIL.</p>

<h3 id="final-thoughts">Final thoughts</h3>

<p>This tutorial shows how to understand the original recursive fractal generator and how to safely run expensive geometry generation in parallel without touching the GUI thread. Use the provided code as a starting point — tweak parameters, depths, and the pool strategy to match your CPU and artistic goal.</p>

<p>Happy coding and happy tree-growing!</p>


          <!-- Inline code styling -->
          <link href="/assets/css/syntax.css" rel="stylesheet">
          <script src="/assets/scripts/copyCode.js" async></script>

          <!-- Google Ad (responsive rectangle after content) -->
          <section aria-label="Advertisements" class="ads mt-4">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-2976211678184829"
                 data-ad-slot="7658460605"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
              (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
          </section>

        </article>

        <!-- Post Navigation -->
        <nav class="post-navigation controls__inner mt-5" aria-label="Post navigation">
          <div class="controls__item prev">
            
              <span>Previous</span>
              <a href="/How-to-Simulate-GPS-Satellites/" rel="prev">
                How to make a GPS Satellite Simulatio...
              </a>
            
          </div>

          <div class="controls__item next">
            
              <span>Next</span>
              <a href="/AC-to-DC-Full-Wave-Rectifier-in-Pygame/" rel="next">
                AC to DC conversion Simulation in Python
              </a>
            
          </div>
        </nav>

        <!-- Comments Section -->
        
          <section class="comments mt-5" aria-label="Comments Section">
            
<div id="disqus_thread"></div>
<script>

var disqus_config = function () {
this.page.url = 'http://localhost:4000/How-to-make-Fibonacci-Tree/';
this.page.identifier = 'http://localhost:4000/How-to-make-Fibonacci-Tree/';
};

(function() {
var d = document, s = d.createElement('script');
s.src = 'https://https-py2ai-github-io.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the comments.</noscript>


          </section>
        

      </div>
    </main>

    <footer class="footer">
  <div class="container">
    <nav class="social">
      
      
      
    </nav>
    <span>&copy; 2025 PyShine. All rights reserved.</span>
  </div>
</footer>
<script async src="/assets/js/bundle.js"></script>

<script async>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').then(function( registration ) {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    })
    .catch(function(error) {
      console.log('ServiceWorker registration failed: ', error);
    });
  }
</script>



    <!-- Scripts at bottom for performance -->
    
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<script
  type="text/javascript"
  charset="utf-8"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
>
</script>
<script
  type="text/javascript"
  charset="utf-8"
  src="https://vincenttam.github.io/javascripts/MathJaxLocal.js"
>
</script>



    <!-- Async Ads script globally -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  </body>
</html>


