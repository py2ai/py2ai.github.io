<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="http://localhost:4000/atom.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" hreflang="en" /><updated>2026-02-16T19:09:14+08:00</updated><id>http://localhost:4000/atom.xml</id><title type="html">PyShine</title><subtitle>Simple and practical Python tutorials for everyone. Learn, build, and explore AI and coding step by step — no jargon, just clear explanations.</subtitle><author><name>PyShine Team</name></author><entry><title type="html">Top 10 AI Models You Need to Know in 2026 - Complete Guide</title><link href="http://localhost:4000/Top-10-AI-Models/" rel="alternate" type="text/html" title="Top 10 AI Models You Need to Know in 2026 - Complete Guide" /><published>2026-02-16T00:00:00+08:00</published><updated>2026-02-16T00:00:00+08:00</updated><id>http://localhost:4000/Top-10-AI-Models</id><content type="html" xml:base="http://localhost:4000/Top-10-AI-Models/"><![CDATA[<h1 id="top-10-ai-models-you-need-to-know-in-2026">Top 10 AI Models You Need to Know in 2026</h1>

<p>Artificial Intelligence has evolved dramatically, with 2026 bringing unprecedented advancements in AI capabilities. This comprehensive guide explores the top 10 AI models that are reshaping industries, from natural language processing to computer vision and beyond.</p>

<h2 id="1-gpt-4-openai">1. <strong>GPT-4 (OpenAI)</strong></h2>

<p>GPT-4 remains the most advanced large language model from OpenAI, offering exceptional reasoning capabilities, coding assistance, and creative writing. With approximately 1.76 trillion parameters and multimodal capabilities (text, images, and code), GPT-4 continues to set the standard for AI performance.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>~1.76 trillion parameters for advanced reasoning</li>
  <li>Multimodal understanding (text, images, code)</li>
  <li>128K context window for long conversations</li>
  <li>Superior coding and debugging capabilities</li>
  <li>Temperature control (0-2) for output randomness</li>
  <li>Top-P sampling for diverse outputs</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Complex coding tasks</li>
  <li>Content creation and copywriting</li>
  <li>Data analysis and interpretation</li>
  <li>Educational tutoring</li>
</ul>

<h2 id="2-claude-35-anthropic">2. <strong>Claude 3.5 (Anthropic)</strong></h2>

<p>Claude 3.5 represents Anthropic’s commitment to safe, helpful, and honest AI. With approximately 175 billion parameters and a 200K token context window, Claude excels at following complex instructions and maintaining context over long conversations. The latest Opus 4.5 version achieves 80% accuracy on SWE-bench Verified benchmark.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>~175 billion parameters for advanced reasoning</li>
  <li>200K token context window for extended conversations</li>
  <li>Superior analytical capabilities with 80% SWE-bench accuracy</li>
  <li>Strong adherence to safety guidelines</li>
  <li>Excellent at technical documentation</li>
  <li>Skill Engineering support for complex tasks</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Research and analysis</li>
  <li>Technical writing</li>
  <li>Code review and optimization</li>
  <li>Long-form content creation</li>
</ul>

<h2 id="3-gemini-20-google">3. <strong>Gemini 2.0 (Google)</strong></h2>

<p>Google’s Gemini 2.0 combines powerful language understanding with native multimodal capabilities. With approximately 1.5 trillion parameters and a massive 1M token context window, it processes text, images, audio, and video simultaneously. Gemini has grown 672.26% year-over-year with 2.68 billion monthly visits.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>~1.5 trillion parameters for multimodal processing</li>
  <li>1M token context window for massive content analysis</li>
  <li>Native multimodal processing (text, images, audio, video)</li>
  <li>Real-time information access with 19.21% monthly growth</li>
  <li>Advanced reasoning capabilities</li>
  <li>Seamless Google Workspace integration</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Multimodal content analysis</li>
  <li>Image and video understanding</li>
  <li>Research with web access</li>
  <li>Productivity enhancement</li>
</ul>

<h2 id="4-llama-3-meta">4. <strong>LLaMA 3 (Meta)</strong></h2>

<p>Meta’s LLaMA 3 (Large Language Model Meta) offers open-source alternatives to proprietary models. With parameter sizes of 8B and 70B, it provides flexibility for different deployment scenarios. LLaMA 3 can run efficiently on consumer hardware, with 70B models running smoothly on 8GB GPUs.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>8B and 70B parameter sizes for different use cases</li>
  <li>8K-128K token context window</li>
  <li>Fully open-source and customizable</li>
  <li>Efficient inference on consumer hardware</li>
  <li>Strong multilingual support</li>
  <li>70B model runs on 8GB GPUs</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Custom model fine-tuning</li>
  <li>On-premise deployment</li>
  <li>Privacy-sensitive applications</li>
  <li>Research and development</li>
</ul>

<h2 id="5-mistral-large-mistral-ai">5. <strong>Mistral Large (Mistral AI)</strong></h2>

<p>Mistral Large has emerged as a powerful open-source model that competes with proprietary giants. With approximately 123 billion parameters and a 32K token context window, it’s known for its efficiency and strong performance. Mistral also offers Voxtral Transcribe 2 with only 0.2 seconds latency for speech recognition.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>~123 billion parameters for enterprise applications</li>
  <li>32K token context window</li>
  <li>Exceptional efficiency-to-performance ratio</li>
  <li>Strong coding capabilities</li>
  <li>Multilingual proficiency</li>
  <li>Active community support</li>
  <li>Voxtral Transcribe 2 with 0.2s latency</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Enterprise applications</li>
  <li>Coding assistance</li>
  <li>Multilingual tasks</li>
  <li>Cost-effective deployments</li>
</ul>

<h2 id="6-dall-e-3-openai">6. <strong>DALL-E 3 (OpenAI)</strong></h2>

<p>DALL-E 3 represents the pinnacle of text-to-image generation. With approximately 12 billion parameters and integration with ChatGPT for prompt generation, it offers improved photorealism, better understanding of complex prompts, and faster generation times.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>~12 billion parameters for image generation</li>
  <li>ChatGPT integration for prompt optimization</li>
  <li>Photorealistic image generation</li>
  <li>Complex scene understanding</li>
  <li>Style transfer capabilities</li>
  <li>High-resolution output</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Marketing materials</li>
  <li>Concept art and design</li>
  <li>Social media content</li>
  <li>Product visualization</li>
</ul>

<h2 id="7-stable-diffusion-xl-stability-ai">7. <strong>Stable Diffusion XL (Stability AI)</strong></h2>

<p>Stable Diffusion XL continues to be the leading open-source image generation model. With approximately 6.6 billion parameters and extensive community support, it offers unparalleled flexibility for creative projects with countless fine-tuned versions available.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>~6.6 billion parameters for image generation</li>
  <li>Completely open-source and customizable</li>
  <li>Extensive model ecosystem</li>
  <li>Customizable and trainable</li>
  <li>Strong community support</li>
  <li>Multiple fine-tuned versions available</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Artistic creation</li>
  <li>Custom model training</li>
  <li>Commercial applications</li>
  <li>Research and experimentation</li>
</ul>

<h2 id="8-whisper-v3-openai">8. <strong>Whisper v3 (OpenAI)</strong></h2>

<p>Whisper v3 sets the gold standard for speech recognition and transcription. With approximately 1.5 billion parameters and support for 99+ languages, it achieves 98.5% accuracy even with poor audio quality. New AI transcription tools like TingNao AI achieve 10-second transcription for 3-minute recordings.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>~1.5 billion parameters for speech recognition</li>
  <li>Multilingual support (99+ languages)</li>
  <li>High accuracy (98.5%) even with poor audio quality</li>
  <li>Speaker diarization</li>
  <li>Real-time transcription</li>
  <li>30-second audio processing window</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Meeting transcription</li>
  <li>Video captioning</li>
  <li>Podcast processing</li>
  <li>Accessibility features</li>
</ul>

<h2 id="9-midjourney-v7">9. <strong>Midjourney v7</strong></h2>

<p>Midjourney v7 continues to dominate the AI art space with its exceptional artistic style and attention to detail. With approximately 8 billion parameters, it offers superior artistic quality, excellent style consistency, and advanced parameter control. While not open-source, its output quality remains unmatched for creative professionals.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>~8 billion parameters for artistic generation</li>
  <li>Superior artistic quality</li>
  <li>Excellent style consistency</li>
  <li>Advanced parameter control</li>
  <li>Strong community ecosystem</li>
  <li>Professional-grade output</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Professional art creation</li>
  <li>Concept visualization</li>
  <li>Brand identity design</li>
  <li>Illustration work</li>
</ul>

<h2 id="10-codellama-25-meta">10. <strong>CodeLlama 2.5 (Meta)</strong></h2>

<p>CodeLlama 2.5 specializes in code generation and understanding. With parameter sizes of 7B, 13B, and 34B, it offers 100K token context window and Python-optimized performance. The 7B model achieves 82% code accuracy, while the 34B model reaches 88%, with 7B running smoothly on 8GB GPUs.</p>

<p><strong>Key Features:</strong></p>
<ul>
  <li>7B/13B/34B parameter sizes for different needs</li>
  <li>100K token context window for project-level analysis</li>
  <li>Specialized for programming languages</li>
  <li>Strong code completion (82-88% accuracy)</li>
  <li>Bug detection and fixing</li>
  <li>Python-optimized performance</li>
  <li>7B model runs on 8GB GPUs</li>
</ul>

<p><strong>Best Use Cases:</strong></p>
<ul>
  <li>Software development</li>
  <li>Code review</li>
  <li>Learning programming</li>
  <li>Debugging assistance</li>
</ul>

<h2 id="comparison-table">Comparison Table</h2>

<table>
  <thead>
    <tr>
      <th>AI Model</th>
      <th>Developer</th>
      <th>Type</th>
      <th>Parameters</th>
      <th>Context Window</th>
      <th>Best For</th>
      <th>Open Source</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>GPT-4</td>
      <td>OpenAI</td>
      <td>General Purpose</td>
      <td>~1.76T</td>
      <td>128K tokens</td>
      <td>Complex reasoning, coding, content creation</td>
      <td>No</td>
    </tr>
    <tr>
      <td>Claude 3.5</td>
      <td>Anthropic</td>
      <td>Analysis &amp; Writing</td>
      <td>~175B</td>
      <td>200K tokens</td>
      <td>Research, technical writing, code review</td>
      <td>No</td>
    </tr>
    <tr>
      <td>Gemini 2.0</td>
      <td>Google</td>
      <td>Multimodal</td>
      <td>~1.5T</td>
      <td>1M tokens</td>
      <td>Multimodal content analysis, research with web access</td>
      <td>No</td>
    </tr>
    <tr>
      <td>LLaMA 3</td>
      <td>Meta</td>
      <td>Custom Deployment</td>
      <td>8B/70B</td>
      <td>8K-128K tokens</td>
      <td>Custom model fine-tuning, on-premise deployment</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td>Mistral Large</td>
      <td>Mistral AI</td>
      <td>Enterprise</td>
      <td>~123B</td>
      <td>32K tokens</td>
      <td>Enterprise applications, coding, multilingual tasks</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td>DALL-E 3</td>
      <td>OpenAI</td>
      <td>Image Generation</td>
      <td>~12B</td>
      <td>N/A</td>
      <td>Marketing materials, concept art, social media content</td>
      <td>No</td>
    </tr>
    <tr>
      <td>Stable Diffusion XL</td>
      <td>Stability AI</td>
      <td>Art &amp; Design</td>
      <td>~6.6B</td>
      <td>N/A</td>
      <td>Artistic creation, custom model training, commercial applications</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td>Whisper v3</td>
      <td>OpenAI</td>
      <td>Speech Recognition</td>
      <td>~1.5B</td>
      <td>30 seconds</td>
      <td>Meeting transcription, video captioning, podcast processing</td>
      <td>No</td>
    </tr>
    <tr>
      <td>Midjourney v7</td>
      <td>Midjourney</td>
      <td>Art Creation</td>
      <td>~8B</td>
      <td>N/A</td>
      <td>Professional art creation, concept visualization, brand identity design</td>
      <td>No</td>
    </tr>
    <tr>
      <td>CodeLlama 2.5</td>
      <td>Meta</td>
      <td>Coding</td>
      <td>7B/13B/34B</td>
      <td>100K tokens</td>
      <td>Software development, code review, learning programming</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<h2 id="how-to-choose-the-right-ai-model">How to Choose the Right AI Model</h2>

<p><strong>For General Tasks:</strong></p>
<ul>
  <li>Use GPT-4 for maximum capability</li>
  <li>Use Claude 3.5 for analytical tasks</li>
  <li>Use Gemini 2.0 for multimodal needs</li>
</ul>

<p><strong>For Custom Deployment:</strong></p>
<ul>
  <li>Use LLaMA 3 for flexibility</li>
  <li>Use Mistral Large for efficiency</li>
  <li>Use CodeLlama 2.5 for coding</li>
</ul>

<p><strong>For Creative Work:</strong></p>
<ul>
  <li>Use DALL-E 3 for photorealism</li>
  <li>Use Stable Diffusion XL for customization</li>
  <li>Use Midjourney v7 for artistic quality</li>
</ul>

<p><strong>For Specialized Tasks:</strong></p>
<ul>
  <li>Use Whisper v3 for transcription</li>
  <li>Use CodeLlama 2.5 for programming</li>
</ul>

<h2 id="future-trends-in-ai-models">Future Trends in AI Models</h2>

<p>As we progress through 2026, expect to see:</p>
<ol>
  <li><strong>More Efficient Models:</strong> Smaller models matching larger ones’ performance</li>
  <li><strong>Better Multimodal Integration:</strong> Seamless text, image, audio, and video processing</li>
  <li><strong>Enhanced Reasoning:</strong> Improved logical deduction and problem-solving</li>
  <li><strong>Open-Source Growth:</strong> More powerful models becoming publicly available</li>
  <li><strong>Specialized Models:</strong> Purpose-built AI for specific industries</li>
</ol>

<h2 id="conclusion">Conclusion</h2>

<p>The AI landscape in 2026 offers unprecedented choices for developers, businesses, and creators. Whether you need general-purpose assistance, specialized coding help, or creative generation, there’s an AI model perfectly suited to your needs.</p>

<p>Stay updated with these developments, as the field continues to evolve rapidly. The key is understanding your specific requirements and choosing the model that best addresses them.</p>

<h2 id="related-posts">Related Posts</h2>

<ul>
  <li><a href="/How-to-make-chat-GPT-like-application/">How to Make a ChatGPT-like Application with FlexGen</a></li>
  <li><a href="/Lab1-of-FastAPI-for-Beginners/">Lab1 of FastAPI for Beginners</a></li>
  <li><a href="/Lab2-Personalized-Jokes-API-with-Categories/">Lab2 - Personalized Jokes API with Categories</a></li>
  <li><a href="/Lab3-FastAPI-Todo-List/">Lab3 - FastAPI Todo List</a></li>
</ul>]]></content><author><name>PyShine Team</name></author><category term="AI tutorial series" /><category term="AI" /><category term="Machine Learning" /><category term="GPT-4" /><category term="Claude" /><category term="Gemini" /><category term="LLaMA" /><category term="Mistral" /><category term="Deep Learning" /><category term="Neural Networks" /><category term="Technology" /><summary type="html"><![CDATA[Explore the top 10 AI models dominating the tech landscape in 2026. From GPT-4 to Claude, learn about the most powerful AI systems and their applications.]]></summary></entry><entry><title type="html">Building a Snake Game in Python with Tkinter</title><link href="http://localhost:4000/Tkinter-Snake-Game-Easy/" rel="alternate" type="text/html" title="Building a Snake Game in Python with Tkinter" /><published>2026-01-28T00:00:00+08:00</published><updated>2026-01-28T00:00:00+08:00</updated><id>http://localhost:4000/Tkinter-Snake-Game-Easy</id><content type="html" xml:base="http://localhost:4000/Tkinter-Snake-Game-Easy/"><![CDATA[<h1 id="building-a-snake-game-in-python-with-tkinter">Building a Snake Game in Python with Tkinter</h1>

<p>This tutorial walks you through a <strong>complete Snake game</strong> written in Python using <strong>Tkinter</strong>.<br />
It is designed for <strong>beginners</strong> who want to learn:</p>

<ul>
  <li>GUI programming with Tkinter</li>
  <li>Game loops and state management</li>
  <li>Keyboard handling</li>
  <li>Object‑oriented Python</li>
</ul>

<hr />

<h2 id="requirements">Requirements</h2>

<ul>
  <li>Python 3.8+</li>
  <li>Tkinter (comes preinstalled with Python on most systems)</li>
</ul>

<p>Run the game using:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python main.py
</code></pre></div></div>

<hr />

<h2 id="game-features">Game Features</h2>

<ul>
  <li>Arrow‑key movement</li>
  <li>Pause / Resume (<code class="language-plaintext highlighter-rouge">P</code> key or button)</li>
  <li>Score tracking</li>
  <li>Start / Reset buttons</li>
  <li>Collision detection</li>
  <li>Wrap‑around walls</li>
  <li>Clean object‑oriented structure</li>
</ul>

<hr />

<h2 id="core-concepts-explained">Core Concepts Explained</h2>

<h3 id="the-direction-enum">The Direction Enum</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">UP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">DOWN</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">LEFT</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">RIGHT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Why this matters:</strong><br />
Enums prevent invalid directions and make movement logic readable and safe.</p>

<hr />

<h3 id="game-grid-logic">Game Grid Logic</h3>

<p>Each cell is a square in a 20×20 grid:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span> <span class="o">=</span> <span class="mi">20</span>
<span class="bp">self</span><span class="p">.</span><span class="n">grid_width</span> <span class="o">=</span> <span class="mi">20</span>
<span class="bp">self</span><span class="p">.</span><span class="n">grid_height</span> <span class="o">=</span> <span class="mi">20</span>
</code></pre></div></div>

<p>The snake moves <strong>one cell at a time</strong>, not pixel‑by‑pixel — a common technique in grid‑based games.</p>

<hr />

<h3 id="the-game-loop-after">The Game Loop (<code class="language-plaintext highlighter-rouge">after()</code>)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">game_speed</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">move_snake</span><span class="p">)</span>
</code></pre></div></div>

<p>Tkinter doesn’t have a traditional <code class="language-plaintext highlighter-rouge">while</code> loop for games.<br />
Instead, it schedules updates using <code class="language-plaintext highlighter-rouge">after()</code> — this keeps the UI responsive.</p>

<hr />

<h3 id="snake-movement-logic">Snake Movement Logic</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">new_head</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">head_x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_width</span><span class="p">,</span>
    <span class="p">(</span><span class="n">head_y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_height</span>
<span class="p">)</span>
</code></pre></div></div>

<p><strong>Why <code class="language-plaintext highlighter-rouge">%</code> modulo?</strong><br />
This allows the snake to <strong>wrap around the screen</strong>, instead of crashing into walls.</p>

<hr />

<h3 id="collision-detection">Collision Detection</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">new_head</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">snake</span><span class="p">:</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">game_over</span><span class="p">()</span>
</code></pre></div></div>

<p>The game ends if the snake collides with itself — a classic Snake rule.</p>

<hr />

<h3 id="drawing-with-canvas">Drawing with Canvas</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_rectangle</span><span class="p">(...)</span>
<span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_oval</span><span class="p">(...)</span>
</code></pre></div></div>

<p>Tkinter’s <code class="language-plaintext highlighter-rouge">Canvas</code> lets you draw:</p>
<ul>
  <li>Rectangles → Snake body</li>
  <li>Ovals → Food</li>
  <li>Text → Game Over screen</li>
</ul>

<hr />

<h2 id="full-game-code">Full Game Code</h2>

<style>
  .copy-code-button {
	box-shadow:inset 0px 1px 0px 0px #bbdaf7;
	background:linear-gradient(to bottom, #79bbff 5%, #378de5 100%);
	background-color:#79bbff;
	border-radius:6px;
	border:1px solid #84bbf3;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #528ecc;
}
.copy-code-button:hover {
	background:linear-gradient(to bottom, #378de5 5%, #79bbff 100%);
	background-color:#378de5;
}
.copy-code-button:active {
	position:relative;
	top:1px;
}
</style>

<div class="code-header">
  <button class="copy-code-button">
    Copy code to clipboard
  </button>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="n">tk</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">UP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">DOWN</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">LEFT</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">RIGHT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SnakeGame</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Snake Game"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">resizable</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        
        <span class="c1"># Game settings
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">grid_width</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">grid_height</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">game_speed</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># milliseconds
</span>        
        <span class="c1"># Calculate window size
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">canvas_width</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_width</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas_height</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_height</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span>
        
        <span class="c1"># Create canvas
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Canvas</span><span class="p">(</span>
            <span class="n">root</span><span class="p">,</span> 
            <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">canvas_width</span><span class="p">,</span> 
            <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">canvas_height</span><span class="p">,</span>
            <span class="n">bg</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span>
            <span class="n">highlightthickness</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">padx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Create score label
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">score_label</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Score: 0"</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">"Arial"</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">score_label</span><span class="p">.</span><span class="n">pack</span><span class="p">()</span>
        
        <span class="c1"># Create buttons frame
</span>        <span class="n">button_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">button_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="c1"># Control buttons
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">start_button</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">button_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Start"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">start_game</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">start_button</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">pause_button</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">button_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Pause"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">toggle_pause</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pause_button</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">reset_button</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">button_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Reset"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">reset_game</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">reset_button</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="c1"># Initialize game state
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">reset_game</span><span class="p">()</span>
        
        <span class="c1"># Bind keyboard events
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">focus_set</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"&lt;KeyPress&gt;"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">handle_keypress</span><span class="p">)</span>
        
        <span class="c1"># Draw initial state
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset_game</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initial snake position (centered)
</span>        <span class="n">start_x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_width</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">start_y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_height</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">snake</span> <span class="o">=</span> <span class="p">[(</span><span class="n">start_x</span><span class="p">,</span> <span class="n">start_y</span><span class="p">)]</span>
        
        <span class="c1"># Initial direction
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">RIGHT</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">next_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">direction</span>
        
        <span class="c1"># Place first food
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">place_food</span><span class="p">()</span>
        
        <span class="c1"># Reset score
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">update_score</span><span class="p">()</span>
        
        <span class="c1"># Reset game state
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">is_paused</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">is_game_over</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">start_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">NORMAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pause_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">DISABLED</span><span class="p">)</span>
        
        <span class="c1"># Clear canvas and draw initial state
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tk</span><span class="p">.</span><span class="n">ALL</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">place_food</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">snake</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">food</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">move_snake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_paused</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_game_over</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Update direction
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">next_direction</span>
        
        <span class="c1"># Calculate new head position
</span>        <span class="n">head_x</span><span class="p">,</span> <span class="n">head_y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">snake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">direction</span><span class="p">.</span><span class="n">value</span>
        <span class="n">new_head</span> <span class="o">=</span> <span class="p">((</span><span class="n">head_x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_width</span><span class="p">,</span> <span class="p">(</span><span class="n">head_y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">grid_height</span><span class="p">)</span>
        
        <span class="c1"># Check for collision with self
</span>        <span class="k">if</span> <span class="n">new_head</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">snake</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">game_over</span><span class="p">()</span>
            <span class="k">return</span>
            
        <span class="c1"># Add new head
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">snake</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_head</span><span class="p">)</span>
        
        <span class="c1"># Check if food is eaten
</span>        <span class="k">if</span> <span class="n">new_head</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">food</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">score</span> <span class="o">+=</span> <span class="mi">10</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">update_score</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">place_food</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Remove tail if no food eaten
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">snake</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
            
        <span class="c1"># Draw updated game state
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">draw</span><span class="p">()</span>
        
        <span class="c1"># Schedule next move
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">game_speed</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">move_snake</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_keypress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">keysym</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">"Up"</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">DOWN</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">next_direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">UP</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">"Down"</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">UP</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">next_direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">DOWN</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">"Left"</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">RIGHT</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">next_direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">LEFT</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">"Right"</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">LEFT</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">next_direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">RIGHT</span>
        <span class="k">elif</span> <span class="n">key</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">'p'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">toggle_pause</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">toggle_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">is_paused</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_paused</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_paused</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">pause_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">"Resume"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">pause_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">"Pause"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">move_snake</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start_game</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">start_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">DISABLED</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pause_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">NORMAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">move_snake</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">game_over</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">is_game_over</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_text</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">canvas_width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">canvas_height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s">"GAME OVER</span><span class="se">\n</span><span class="s">Score: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="s">"red"</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">"Arial"</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
            <span class="n">justify</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">CENTER</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">start_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">NORMAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pause_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">DISABLED</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">score_label</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s">"Score: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">score</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Clear canvas
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tk</span><span class="p">.</span><span class="n">ALL</span><span class="p">)</span>
        
        <span class="c1"># Draw snake
</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">snake</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s">"lime green"</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">"green"</span>  <span class="c1"># Head is different color
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_rectangle</span><span class="p">(</span>
                <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span><span class="p">,</span>
                <span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span><span class="p">,</span>
                <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span><span class="p">,</span>
                <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">outline</span><span class="o">=</span><span class="s">"dark green"</span>
            <span class="p">)</span>
        
        <span class="c1"># Draw food
</span>        <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">food</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_oval</span><span class="p">(</span>
            <span class="n">fx</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span><span class="p">,</span>
            <span class="n">fy</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span><span class="p">,</span>
            <span class="p">(</span><span class="n">fx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span><span class="p">,</span>
            <span class="p">(</span><span class="n">fy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">cell_size</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="s">"red"</span><span class="p">,</span>
            <span class="n">outline</span><span class="o">=</span><span class="s">"dark red"</span>
        <span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">SnakeGame</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">root</span><span class="p">.</span><span class="n">mainloop</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h2 id="possible-extensions">Possible Extensions</h2>

<p>Try improving the game by adding:</p>

<ul>
  <li>Difficulty levels (speed increase)</li>
  <li>Sound effects</li>
  <li>High‑score saving (file or database)</li>
  <li>Walls and obstacles</li>
  <li>Color themes</li>
  <li>Multiplayer snake 👀</li>
</ul>

<hr />

<h2 id="common-questions-faq">Common Questions (FAQ)</h2>

<h3 id="q-why-use-tkinter-instead-of-pygame">Q: Why use Tkinter instead of Pygame?</h3>
<p>Tkinter is simpler, built‑in, and perfect for learning GUI + logic fundamentals.</p>

<h3 id="q-why-not-use-a-while-loop">Q: Why not use a <code class="language-plaintext highlighter-rouge">while</code> loop?</h3>
<p>Tkinter uses an <strong>event‑driven loop</strong>. <code class="language-plaintext highlighter-rouge">after()</code> prevents freezing the UI.</p>

<h3 id="q-how-does-pause-work">Q: How does pause work?</h3>
<p>The game simply stops scheduling the next <code class="language-plaintext highlighter-rouge">move_snake()</code> call.</p>

<h3 id="q-can-i-turn-off-wraparound-walls">Q: Can I turn off wrap‑around walls?</h3>
<p>Yes! Replace modulo logic with boundary collision detection.</p>

<hr />

<h2 id="final-thoughts">Final Thoughts</h2>

<p>This project teaches <strong>real‑world Python skills</strong>:</p>
<ul>
  <li>Structuring programs</li>
  <li>Managing state</li>
  <li>Event‑driven programming</li>
  <li>GUI rendering</li>
</ul>

<p>If you can build this — you’re officially <strong>past beginner level</strong> 🎉</p>

<p>Happy coding!</p>]]></content><author><name>PyShine</name></author><category term="python" /><category term="tkinter" /><category term="game-development" /><category term="beginners" /><summary type="html"><![CDATA[A beginner-friendly tutorial explaining how to build a classic Snake game using Python and Tkinter.]]></summary></entry><entry><title type="html">PyShine clipboard App for two PCs</title><link href="http://localhost:4000/Clipboard-App-for-Two-PCs/" rel="alternate" type="text/html" title="PyShine clipboard App for two PCs" /><published>2026-01-27T00:00:00+08:00</published><updated>2026-01-27T00:00:00+08:00</updated><id>http://localhost:4000/Clipboard-App-for-Two-PCs</id><content type="html" xml:base="http://localhost:4000/Clipboard-App-for-Two-PCs/"><![CDATA[<h1 id="pyshine-clipboard">PyShine Clipboard</h1>

<p>Seamlessly copy and paste <strong>text, files, and folders</strong> between devices on the same local network —<br />
<strong>no cloud, no login, no tracking</strong>.</p>

<div class="video-container">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/Dw-Y_B5mzRQ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
  </iframe>
</div>

<p>Think <em>AirDrop</em>, but <strong>cross‑platform</strong>, <strong>private</strong>, and <strong>under your control</strong>.</p>

<hr />

<h2 id="features">Features</h2>

<ul>
  <li>Real-time clipboard sync</li>
  <li>File &amp; folder transfer with progress bar</li>
  <li>Works fully offline (Wifi or LAN)</li>
  <li>Cross-platform (Windows &amp; macOS)</li>
  <li>Fast, lightweight, and secure</li>
</ul>

<hr />

<h2 id="download-installers">Download Installers</h2>

<h3 id="windows-64-bit">Windows (64-bit)</h3>

<ul>
  <li><strong>Installer (.exe)</strong></li>
</ul>

<p><a href="/assets/downloads/pyshne_clipboard.exe">Download for Windows</a></p>

<blockquote>
  <p>Compatible with Windows 10 and above</p>
</blockquote>

<hr />

<h3 id="macos">macOS</h3>
<ul>
  <li><strong>Intel Macs</strong></li>
</ul>

<p><a href="/assets/downloads/pyshine_clipboard.zip">Download for macOS</a></p>

<p>Unzip pyshine_clipboard on macOS and then press option key and then click and select Open.</p>

<blockquote>
  <p>Compatible with macOS 11 (Big Sur) and above</p>
</blockquote>

<p>⚠️ On first launch, you may need to:</p>
<ul>
  <li>Right-click → Open</li>
  <li>Allow network access when prompted</li>
</ul>

<p>Use ipconfig on windows pc to find your IP address and use ifconfig en0 on MacOs to find the IP. Open both apps on both PCs, and enter the target IP. For example in Windows PC app the target IP is of MacOs IP and vice-versa.</p>

<hr />

<h2 id="how-it-works-quick">How It Works (Quick)</h2>

<ol>
  <li>Install Clipboard Pro on both machines</li>
  <li>Make sure both are on the same Wi‑Fi / LAN</li>
  <li>Launch the app on both devices</li>
  <li>Copy on one → Paste on the other</li>
</ol>

<hr />

<h2 id="complete-code">Complete Code</h2>

<style>
  .copy-code-button {
	box-shadow:inset 0px 1px 0px 0px #bbdaf7;
	background:linear-gradient(to bottom, #79bbff 5%, #378de5 100%);
	background-color:#79bbff;
	border-radius:6px;
	border:1px solid #84bbf3;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #528ecc;
}
.copy-code-button:hover {
	background:linear-gradient(to bottom, #378de5 5%, #79bbff 100%);
	background-color:#378de5;
}
.copy-code-button:active {
	position:relative;
	top:1px;
}
</style>

<div class="code-header">
  <button class="copy-code-button">
    Copy code to clipboard
  </button>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="s">"""
PyShine Clipboard Pro - Complete Cross-Platform Solution
With Real-Time Progress Tracking for All Transfers
Fixed for macOS clipboard detection with circular progress indicators
DIRECT CONNECTION VERSION - Only communication between two PCs

FIXED: Proper termination on window close for PyInstaller builds
"""</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="n">tk</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">ttk</span><span class="p">,</span> <span class="n">messagebox</span><span class="p">,</span> <span class="n">scrolledtext</span><span class="p">,</span> <span class="n">filedialog</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">pyperclip</span>
<span class="kn">import</span> <span class="nn">pyclip</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">netifaces</span>
<span class="kn">import</span> <span class="nn">ipaddress</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">platform</span>


<span class="c1"># ------------------ Configuration ------------------
</span><span class="n">TCP_PORT</span> <span class="o">=</span> <span class="mi">6000</span>
<span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">8192</span>
<span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">65536</span>
<span class="n">DEVICE_ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span>
<span class="n">HOST_OS</span> <span class="o">=</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span>

<span class="c1"># Clipboard check intervals - increased for macOS stability
</span><span class="n">TEXT_CHECK_INTERVAL</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># Increased from 1.0 for macOS
</span>
<span class="c1"># Set proper clipboard backend for macOS
</span><span class="n">CLIPBOARD_BACKEND</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">if</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="s">"Darwin"</span><span class="p">:</span>
    <span class="c1"># Try pyclip first (more reliable on macOS)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pyclip</span>
        <span class="n">CLIPBOARD_BACKEND</span> <span class="o">=</span> <span class="s">"pyclip"</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Using pyclip for macOS clipboard"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to set pyperclip to use pbcopy/pbpaste
</span>            <span class="n">pyperclip</span><span class="p">.</span><span class="n">set_clipboard</span><span class="p">(</span><span class="s">"pbcopy"</span><span class="p">)</span>
            <span class="n">CLIPBOARD_BACKEND</span> <span class="o">=</span> <span class="s">"pyperclip"</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Using pyperclip with pbcopy for macOS clipboard"</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">CLIPBOARD_BACKEND</span> <span class="o">=</span> <span class="s">"subprocess"</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Using subprocess for macOS clipboard"</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="s">"Windows"</span><span class="p">:</span>
    <span class="n">CLIPBOARD_BACKEND</span> <span class="o">=</span> <span class="s">"pyperclip"</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">win32clipboard</span>
    <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># Linux
</span>    <span class="n">CLIPBOARD_BACKEND</span> <span class="o">=</span> <span class="s">"pyperclip"</span>

<span class="k">def</span> <span class="nf">setup_application_icon</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="s">"""
    Setup application icon with reliable fallbacks.
    Creates .pyshine_clipboard folder in user directory and stores icon there.
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create application folder in user directory
</span>        <span class="n">app_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">".pyshine_clipboard"</span>
        <span class="n">app_folder</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Define icon paths
</span>        <span class="n">icon_paths</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'png'</span><span class="p">:</span> <span class="n">app_folder</span> <span class="o">/</span> <span class="s">"icon.png"</span><span class="p">,</span>
            <span class="s">'ico'</span><span class="p">:</span> <span class="n">app_folder</span> <span class="o">/</span> <span class="s">"icon.ico"</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="c1"># Check if we're running as PyInstaller executable
</span>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'frozen'</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'_MEIPASS'</span><span class="p">):</span>
            <span class="c1"># We're running as a bundled executable
</span>            <span class="n">bundle_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">_MEIPASS</span><span class="p">)</span>
            
            <span class="c1"># Look for icon in bundle
</span>            <span class="n">possible_bundle_icons</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">bundle_dir</span> <span class="o">/</span> <span class="s">"icon_clean.png"</span><span class="p">,</span>
                <span class="n">bundle_dir</span> <span class="o">/</span> <span class="s">"icon.png"</span><span class="p">,</span>
                <span class="n">bundle_dir</span> <span class="o">/</span> <span class="s">"app.ico"</span><span class="p">,</span>
                <span class="n">bundle_dir</span> <span class="o">/</span> <span class="s">"icon.ico"</span><span class="p">,</span>
            <span class="p">]</span>
            
            <span class="n">bundle_icon_found</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">bundle_icon</span> <span class="ow">in</span> <span class="n">possible_bundle_icons</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bundle_icon</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">bundle_icon_found</span> <span class="o">=</span> <span class="n">bundle_icon</span>
                    <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">bundle_icon_found</span><span class="p">:</span>
                <span class="c1"># Copy icon from bundle to user folder
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">bundle_icon_found</span><span class="p">,</span> <span class="n">icon_paths</span><span class="p">[</span><span class="s">'png'</span><span class="p">])</span>
                    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Icon copied from bundle to: </span><span class="si">{</span><span class="n">icon_paths</span><span class="p">[</span><span class="s">'png'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to copy icon from bundle: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># Now try to load icon from user folder
</span>        <span class="n">icon_loaded</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="c1"># Try PNG first (works on all platforms)
</span>        <span class="k">if</span> <span class="n">icon_paths</span><span class="p">[</span><span class="s">'png'</span><span class="p">].</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">icon</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">icon_paths</span><span class="p">[</span><span class="s">'png'</span><span class="p">]))</span>
                <span class="n">root</span><span class="p">.</span><span class="n">iconphoto</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">icon</span><span class="p">)</span>
                <span class="n">root</span><span class="p">.</span><span class="n">_icon</span> <span class="o">=</span> <span class="n">icon</span>  <span class="c1"># Keep reference
</span>                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Icon loaded from: </span><span class="si">{</span><span class="n">icon_paths</span><span class="p">[</span><span class="s">'png'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="n">icon_loaded</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to load PNG icon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># Try ICO for Windows
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">icon_loaded</span> <span class="ow">and</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span> <span class="ow">and</span> <span class="n">icon_paths</span><span class="p">[</span><span class="s">'ico'</span><span class="p">].</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">root</span><span class="p">.</span><span class="n">iconbitmap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">icon_paths</span><span class="p">[</span><span class="s">'ico'</span><span class="p">]))</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Windows ICO icon loaded from: </span><span class="si">{</span><span class="n">icon_paths</span><span class="p">[</span><span class="s">'ico'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="n">icon_loaded</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to load ICO icon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># Try to convert PNG to ICO if needed (Windows only)
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">icon_loaded</span> <span class="ow">and</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span> <span class="ow">and</span> <span class="n">icon_paths</span><span class="p">[</span><span class="s">'png'</span><span class="p">].</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Convert PNG to ICO
</span>                <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">icon_paths</span><span class="p">[</span><span class="s">'png'</span><span class="p">])</span>
                <span class="n">img</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">icon_paths</span><span class="p">[</span><span class="s">'ico'</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s">'ICO'</span><span class="p">)</span>
                <span class="n">root</span><span class="p">.</span><span class="n">iconbitmap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">icon_paths</span><span class="p">[</span><span class="s">'ico'</span><span class="p">]))</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Converted PNG to ICO and loaded: </span><span class="si">{</span><span class="n">icon_paths</span><span class="p">[</span><span class="s">'ico'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="n">icon_loaded</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"PIL not available for PNG to ICO conversion"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to convert PNG to ICO: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># Final fallback: try to load from any location
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">icon_loaded</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Trying fallback icon locations..."</span><span class="p">)</span>
            <span class="n">fallback_paths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Path</span><span class="p">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s">"icon_clean.png"</span><span class="p">,</span>
                <span class="n">Path</span><span class="p">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s">"icon.png"</span><span class="p">,</span>
                <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">).</span><span class="n">parent</span> <span class="o">/</span> <span class="s">"icon_clean.png"</span><span class="p">,</span>
                <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">).</span><span class="n">parent</span> <span class="o">/</span> <span class="s">"icon.png"</span><span class="p">,</span>
            <span class="p">]</span>
            
            <span class="k">for</span> <span class="n">fallback_path</span> <span class="ow">in</span> <span class="n">fallback_paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fallback_path</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fallback_path</span><span class="p">.</span><span class="n">suffix</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">'.png'</span><span class="p">:</span>
                            <span class="n">icon</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">fallback_path</span><span class="p">))</span>
                            <span class="n">root</span><span class="p">.</span><span class="n">iconphoto</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">icon</span><span class="p">)</span>
                            <span class="n">root</span><span class="p">.</span><span class="n">_icon</span> <span class="o">=</span> <span class="n">icon</span>
                            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Fallback icon loaded from: </span><span class="si">{</span><span class="n">fallback_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                            <span class="n">icon_loaded</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="c1"># Copy to user folder for future use
</span>                            <span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">fallback_path</span><span class="p">,</span> <span class="n">icon_paths</span><span class="p">[</span><span class="s">'png'</span><span class="p">])</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to load fallback icon </span><span class="si">{</span><span class="n">fallback_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">icon_loaded</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Could not load any icon, using Tkinter default"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="k">return</span> <span class="bp">True</span>
        
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error in setup_application_icon: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="c1"># ------------------ Enhanced Network Utilities ------------------
</span><span class="k">class</span> <span class="nc">NetworkUtils</span><span class="p">:</span>
    <span class="s">"""Network utilities for cross-platform compatibility"""</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">get_all_network_interfaces</span><span class="p">():</span>
        <span class="s">"""Get all network interfaces with IP addresses"""</span>
        <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iface</span> <span class="ow">in</span> <span class="n">netifaces</span><span class="p">.</span><span class="n">interfaces</span><span class="p">():</span>
                <span class="n">addrs</span> <span class="o">=</span> <span class="n">netifaces</span><span class="p">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="n">iface</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">netifaces</span><span class="p">.</span><span class="n">AF_INET</span> <span class="ow">in</span> <span class="n">addrs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">addrs</span><span class="p">[</span><span class="n">netifaces</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s">'addr'</span> <span class="ow">in</span> <span class="n">addr</span> <span class="ow">and</span> <span class="n">addr</span><span class="p">[</span><span class="s">'addr'</span><span class="p">]</span> <span class="o">!=</span> <span class="s">'127.0.0.1'</span><span class="p">:</span>
                            <span class="n">interfaces</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s">'name'</span><span class="p">:</span> <span class="n">iface</span><span class="p">,</span>
                                <span class="s">'ip'</span><span class="p">:</span> <span class="n">addr</span><span class="p">[</span><span class="s">'addr'</span><span class="p">],</span>
                                <span class="s">'netmask'</span><span class="p">:</span> <span class="n">addr</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'netmask'</span><span class="p">,</span> <span class="s">'255.255.255.0'</span><span class="p">),</span>
                                <span class="s">'broadcast'</span><span class="p">:</span> <span class="n">addr</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'broadcast'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
                            <span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error getting network interfaces: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interfaces</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">get_local_ip</span><span class="p">():</span>
        <span class="s">"""Get local IP address"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get local IP from socket
</span>            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
            <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Doesn't need to be reachable
</span>                <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">'10.255.255.255'</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">local_ip</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">local_ip</span> <span class="o">=</span> <span class="s">'127.0.0.1'</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">local_ip</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'127.0.0.1'</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_ip_address</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
        <span class="s">"""Validate IP address format"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">socket</span><span class="p">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">is_valid_port</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
        <span class="s">"""Validate port number"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">port</span> <span class="o">&lt;=</span> <span class="mi">65535</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># ------------------ Circular Progress Widget ------------------
</span><span class="k">class</span> <span class="nc">CircularProgress</span><span class="p">(</span><span class="n">tk</span><span class="p">.</span><span class="n">Canvas</span><span class="p">):</span>
    <span class="s">"""Circular spinning progress indicator"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"#2196F3"</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="s">"#f0f0f0"</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">bg_color</span> <span class="o">=</span> <span class="n">bg_color</span>
        
        <span class="n">tk</span><span class="p">.</span><span class="n">Canvas</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> 
                          <span class="n">width</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> 
                          <span class="n">height</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> 
                          <span class="n">bg</span><span class="o">=</span><span class="n">bg_color</span><span class="p">,</span>
                          <span class="n">highlightthickness</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">thickness</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        
        <span class="c1"># Draw background circle
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">bg_circle</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">create_oval</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="n">outline</span><span class="o">=</span><span class="n">bg_color</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="n">bg_color</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        
        <span class="c1"># Create progress arc
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">progress_arc</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">animation_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="c1"># Start position markers
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">start_markers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">radius</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">radius</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
            
            <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">create_line</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> 
                                     <span class="n">fill</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">color</span><span class="p">,</span> 
                                     <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                     <span class="n">state</span><span class="o">=</span><span class="s">'hidden'</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">start_markers</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Start the spinning animation"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_animate</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Stop the spinning animation"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">animation_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">animation_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">animation_id</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Hide all markers
</span>        <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">start_markers</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">itemconfig</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">'hidden'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_animate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Animate the circular progress"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Clear previous arc
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">progress_arc</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">progress_arc</span><span class="p">)</span>
        
        <span class="c1"># Calculate arc coordinates
</span>        <span class="n">start_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">angle</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="mi">80</span>  <span class="c1"># Length of the arc
</span>        
        <span class="c1"># Draw new arc
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">progress_arc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">create_arc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">center</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">start_angle</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="n">outline</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">color</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">thickness</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">ARC</span>
        <span class="p">)</span>
        
        <span class="c1"># Update angle for next frame
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">angle</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">angle</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
        
        <span class="c1"># Animate markers
</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">marker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">start_markers</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">angle</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">30</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">color</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'#</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="mi">02</span><span class="n">x</span><span class="si">}{</span><span class="n">g</span><span class="si">:</span><span class="mi">02</span><span class="n">x</span><span class="si">}{</span><span class="n">b</span><span class="si">:</span><span class="mi">02</span><span class="n">x</span><span class="si">}</span><span class="s">'</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">itemconfig</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">'normal'</span> <span class="k">if</span> <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mf">0.3</span> <span class="k">else</span> <span class="s">'hidden'</span><span class="p">)</span>
        
        <span class="c1"># Schedule next animation frame
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">animation_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_animate</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="s">"""Change the progress color"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">progress_arc</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">itemconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">progress_arc</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">start_markers</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">itemconfig</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

<span class="c1"># ------------------ Enhanced Clipboard Manager for macOS ------------------
</span><span class="k">class</span> <span class="nc">ClipboardManager</span><span class="p">:</span>
    <span class="s">"""Enhanced clipboard manager with macOS-specific fixes"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span> <span class="o">=</span> <span class="n">log_callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_hash</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_text</span> <span class="o">=</span> <span class="s">""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>
        
        <span class="c1"># Initialize clipboard for macOS
</span>        <span class="k">if</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="s">"Darwin"</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_init_macos_clipboard</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_init_macos_clipboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Initialize macOS clipboard"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Test clipboard access
</span>            <span class="n">test_text</span> <span class="o">=</span> <span class="s">"test"</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_set_clipboard_text_macos</span><span class="p">(</span><span class="n">test_text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">retrieved</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_clipboard_text_macos</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">retrieved</span> <span class="o">==</span> <span class="n">test_text</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="s">"[CLIPBOARD] macOS clipboard initialized successfully"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="s">"[CLIPBOARD] Warning: macOS clipboard verification failed"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="s">"[CLIPBOARD] Warning: Could not initialize macOS clipboard"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] Error initializing macOS clipboard: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_clipboard_text_macos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Get clipboard text specifically for macOS with multiple fallbacks"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_lock</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s">""</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try pyclip first (most reliable on macOS)
</span>                <span class="k">if</span> <span class="n">CLIPBOARD_BACKEND</span> <span class="o">==</span> <span class="s">"pyclip"</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">pyclip</span><span class="p">.</span><span class="n">paste</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">text</span>
                    <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
                        <span class="c1"># Silently skip if pyclip can't decode. Other methods might succeed.
</span>                        <span class="k">pass</span>  <span class="c1"># ⬅️ Changed from logging and returning
</span>                    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] pyclip failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Try pyperclip
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">pyperclip</span><span class="p">.</span><span class="n">paste</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">text</span><span class="p">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">text</span>
                <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">""</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] pyperclip failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Try pbpaste command directly
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="p">[</span><span class="s">'pbpaste'</span><span class="p">],</span>
                        <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s">'LANG'</span><span class="p">:</span> <span class="s">'en_US.UTF-8'</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
                        <span class="c1"># Try to decode, but ignore if it fails
</span>                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">text</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">text</span><span class="p">.</span><span class="n">strip</span><span class="p">():</span>
                                <span class="k">return</span> <span class="n">text</span>
                        <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
                            <span class="k">return</span> <span class="s">""</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] pbpaste failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Last resort: use AppleScript
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">script</span> <span class="o">=</span> <span class="s">'''
                    try
                        get the clipboard as text
                    on error
                        ""
                    end try
                    '''</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="p">[</span><span class="s">'osascript'</span><span class="p">,</span> <span class="s">'-e'</span><span class="p">,</span> <span class="n">script</span><span class="p">],</span>
                        <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">text</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] AppleScript failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] All macOS clipboard methods failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="s">""</span>
    <span class="k">def</span> <span class="nf">__get_clipboard_text_macos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Get clipboard text specifically for macOS with multiple fallbacks"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_lock</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s">""</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try pyclip first (most reliable on macOS)
</span>                <span class="k">if</span> <span class="n">CLIPBOARD_BACKEND</span> <span class="o">==</span> <span class="s">"pyclip"</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">pyclip</span><span class="p">.</span><span class="n">paste</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">text</span>
                    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] pyclip failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Try pyperclip
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">pyperclip</span><span class="p">.</span><span class="n">paste</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">text</span><span class="p">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">text</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] pyperclip failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Try pbpaste command directly
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="p">[</span><span class="s">'pbpaste'</span><span class="p">],</span>
                        <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s">'LANG'</span><span class="p">:</span> <span class="s">'en_US.UTF-8'</span><span class="p">}</span>  <span class="c1"># Set locale for consistency
</span>                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span>
                        <span class="k">return</span> <span class="n">text</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] pbpaste failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Last resort: use AppleScript
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">script</span> <span class="o">=</span> <span class="s">'''
                    try
                        get the clipboard as text
                    on error
                        ""
                    end try
                    '''</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="p">[</span><span class="s">'osascript'</span><span class="p">,</span> <span class="s">'-e'</span><span class="p">,</span> <span class="n">script</span><span class="p">],</span>
                        <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">text</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] AppleScript failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] All macOS clipboard methods failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="s">""</span>
    
    <span class="k">def</span> <span class="nf">_set_clipboard_text_macos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="s">"""Set clipboard text specifically for macOS with multiple fallbacks"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try pyclip first
</span>                <span class="k">if</span> <span class="n">CLIPBOARD_BACKEND</span> <span class="o">==</span> <span class="s">"pyclip"</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pyclip</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                        <span class="c1"># Verify
</span>                        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">verify</span> <span class="o">=</span> <span class="n">pyclip</span><span class="p">.</span><span class="n">paste</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verify</span> <span class="o">==</span> <span class="n">text</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">True</span>
                    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] pyclip copy failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Try pyperclip
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pyperclip</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="c1"># Verify
</span>                    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">verify</span> <span class="o">=</span> <span class="n">pyperclip</span><span class="p">.</span><span class="n">paste</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">verify</span> <span class="o">==</span> <span class="n">text</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] pyperclip copy failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Try pbcopy command directly
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="p">[</span><span class="s">'pbcopy'</span><span class="p">],</span>
                        <span class="nb">input</span><span class="o">=</span><span class="n">text</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">),</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s">'LANG'</span><span class="p">:</span> <span class="s">'en_US.UTF-8'</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Verify with pbpaste
</span>                        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">verify_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
                            <span class="p">[</span><span class="s">'pbpaste'</span><span class="p">],</span>
                            <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">verify_result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">verify_result</span><span class="p">.</span><span class="n">stdout</span> <span class="o">==</span> <span class="n">text</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] pbcopy failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Last resort: use AppleScript
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Escape quotes in text
</span>                    <span class="n">escaped_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'"'</span><span class="p">,</span> <span class="s">'</span><span class="se">\\</span><span class="s">"'</span><span class="p">)</span>
                    <span class="n">script</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'set the clipboard to "</span><span class="si">{</span><span class="n">escaped_text</span><span class="si">}</span><span class="s">"'</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="p">[</span><span class="s">'osascript'</span><span class="p">,</span> <span class="s">'-e'</span><span class="p">,</span> <span class="n">script</span><span class="p">],</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] AppleScript copy failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] All macOS clipboard set methods failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">get_clipboard_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Safely get clipboard text for all platforms"""</span>
        <span class="k">if</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="s">"Darwin"</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_clipboard_text_macos</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_lock</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">pyperclip</span><span class="p">.</span><span class="n">paste</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] Error getting text: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">""</span>
    
    <span class="k">def</span> <span class="nf">set_clipboard_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="s">"""Safely set clipboard text for all platforms"""</span>
        <span class="k">if</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="s">"Darwin"</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_set_clipboard_text_macos</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_lock</span><span class="p">:</span>
                    <span class="n">pyperclip</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="c1"># Verify
</span>                    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">verify</span> <span class="o">=</span> <span class="n">pyperclip</span><span class="p">.</span><span class="n">paste</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">verify</span> <span class="o">==</span> <span class="n">text</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] Error setting text: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">check_for_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Check if clipboard text has changed with improved macOS handling"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_text</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_clipboard_text</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">current_text</span> <span class="ow">or</span> <span class="n">current_text</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">""</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            
            <span class="c1"># Normalize text - remove extra whitespace that macOS might add
</span>            <span class="n">current_text</span> <span class="o">=</span> <span class="n">current_text</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">current_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">current_text</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">current_hash</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">.</span><span class="n">last_hash</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">last_hash</span> <span class="o">=</span> <span class="n">current_hash</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">last_text</span> <span class="o">=</span> <span class="n">current_text</span>
                <span class="k">return</span> <span class="n">current_text</span>
            
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[CLIPBOARD] Error checking for changes: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># ------------------ Progress Manager ------------------
</span><span class="k">class</span> <span class="nc">ProgressManager</span><span class="p">:</span>
    <span class="s">"""Manages progress tracking for file transfers"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gui_callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">gui_callback</span> <span class="o">=</span> <span class="n">gui_callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">start_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">transfer_type</span><span class="o">=</span><span class="s">"send"</span><span class="p">):</span>
        <span class="s">"""Start tracking a new transfer"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">'filename'</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                <span class="s">'total_size'</span><span class="p">:</span> <span class="n">total_size</span><span class="p">,</span>
                <span class="s">'current_size'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">'start_time'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="s">'transfer_type'</span><span class="p">:</span> <span class="n">transfer_type</span><span class="p">,</span>
                <span class="s">'last_update'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="s">'completed'</span><span class="p">:</span> <span class="bp">False</span>
            <span class="p">}</span>
            
            <span class="c1"># Notify GUI
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">gui_callback</span><span class="p">(</span><span class="s">'transfer_started'</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                <span class="s">'filename'</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                <span class="s">'total_size'</span><span class="p">:</span> <span class="n">total_size</span><span class="p">,</span>
                <span class="s">'transfer_type'</span><span class="p">:</span> <span class="n">transfer_type</span>
            <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">bytes_transferred</span><span class="p">):</span>
        <span class="s">"""Update progress for a transfer"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transfer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">:</span>
                <span class="n">transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span>
                <span class="n">transfer</span><span class="p">[</span><span class="s">'current_size'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">bytes_transferred</span>
                <span class="n">transfer</span><span class="p">[</span><span class="s">'last_update'</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
                
                <span class="c1"># Calculate progress percentage (for internal use only)
</span>                <span class="k">if</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'total_size'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">transfer</span><span class="p">[</span><span class="s">'current_size'</span><span class="p">]</span> <span class="o">/</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'total_size'</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">percentage</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="c1"># Notify GUI - simplified for circular progress
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">gui_callback</span><span class="p">(</span><span class="s">'progress_updated'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                    <span class="s">'percentage'</span><span class="p">:</span> <span class="n">percentage</span><span class="p">,</span>
                    <span class="s">'current_size'</span><span class="p">:</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'current_size'</span><span class="p">],</span>
                    <span class="s">'total_size'</span><span class="p">:</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'total_size'</span><span class="p">],</span>
                    <span class="s">'transfer_type'</span><span class="p">:</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'transfer_type'</span><span class="p">]</span>
                <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">complete_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""Mark a transfer as completed"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transfer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">:</span>
                <span class="n">transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span>
                <span class="n">transfer</span><span class="p">[</span><span class="s">'completed'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">transfer</span><span class="p">[</span><span class="s">'end_time'</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">transfer</span><span class="p">[</span><span class="s">'success'</span><span class="p">]</span> <span class="o">=</span> <span class="n">success</span>
                <span class="n">transfer</span><span class="p">[</span><span class="s">'error'</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
                
                <span class="c1"># Calculate total time
</span>                <span class="n">total_time</span> <span class="o">=</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'end_time'</span><span class="p">]</span> <span class="o">-</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'start_time'</span><span class="p">]</span>
                
                <span class="c1"># Notify GUI
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">gui_callback</span><span class="p">(</span><span class="s">'transfer_completed'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                    <span class="s">'filename'</span><span class="p">:</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'filename'</span><span class="p">],</span>
                    <span class="s">'success'</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
                    <span class="s">'error_msg'</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s">'total_time'</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
                    <span class="s">'total_size'</span><span class="p">:</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'total_size'</span><span class="p">]</span>
                <span class="p">})</span>
                
                <span class="c1"># Keep for a while then remove
</span>                <span class="n">threading</span><span class="p">.</span><span class="n">Timer</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_remove_transfer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]).</span><span class="n">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_remove_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">):</span>
        <span class="s">"""Remove a completed transfer"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transfer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">format_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_bytes</span><span class="p">):</span>
        <span class="s">"""Format file size in human-readable format"""</span>
        <span class="k">if</span> <span class="n">size_bytes</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size_bytes</span><span class="si">}</span><span class="s"> B"</span>
        <span class="k">elif</span> <span class="n">size_bytes</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size_bytes</span><span class="o">/</span><span class="mi">1024</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> KB"</span>
        <span class="k">elif</span> <span class="n">size_bytes</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size_bytes</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> MB"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size_bytes</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> GB"</span>
    
    <span class="k">def</span> <span class="nf">get_active_transfers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Get list of active transfers"""</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">.</span><span class="n">items</span><span class="p">())</span>

<span class="c1"># ------------------ File Transfer Manager ------------------
</span><span class="k">class</span> <span class="nc">FileTransferManager</span><span class="p">:</span>
    <span class="s">"""Handles all file and folder transfers"""</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">zip_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""Zip a folder for transfer with progress tracking"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_path</span><span class="p">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">folder_path</span><span class="p">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="s">"Not a valid folder"</span>
            
            <span class="c1"># Count total files for progress
</span>            <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">folder_path</span><span class="p">.</span><span class="n">rglob</span><span class="p">(</span><span class="s">'*'</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">file_path</span><span class="p">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">file_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                    <span class="n">total_size</span> <span class="o">+=</span> <span class="n">file_path</span><span class="p">.</span><span class="n">stat</span><span class="p">().</span><span class="n">st_size</span>
            
            <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
                <span class="n">progress_callback</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Preparing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span><span class="si">}</span><span class="s"> files..."</span><span class="p">)</span>
            
            <span class="c1"># Create temp zip file
</span>            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="n">gettempdir</span><span class="p">())</span>
            <span class="n">zip_path</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">folder_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">.zip"</span>
            
            <span class="k">with</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s">'w'</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
                    <span class="n">arcname</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
                    <span class="n">zipf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">arcname</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">progress_callback</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                        <span class="n">progress_callback</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Compressing: </span><span class="si">{</span><span class="n">file_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
                <span class="n">progress_callback</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">"Compression complete"</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">zip_path</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">get_file_info</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="s">"""Get file information for transfer"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="s">"File does not exist"</span>
            
            <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">'name'</span><span class="p">:</span> <span class="n">filepath</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">'size'</span><span class="p">:</span> <span class="n">filepath</span><span class="p">.</span><span class="n">stat</span><span class="p">().</span><span class="n">st_size</span><span class="p">,</span>
                <span class="s">'modified'</span><span class="p">:</span> <span class="n">filepath</span><span class="p">.</span><span class="n">stat</span><span class="p">().</span><span class="n">st_mtime</span><span class="p">,</span>
                <span class="s">'is_dir'</span><span class="p">:</span> <span class="n">filepath</span><span class="p">.</span><span class="n">is_dir</span><span class="p">(),</span>
                <span class="s">'is_file'</span><span class="p">:</span> <span class="n">filepath</span><span class="p">.</span><span class="n">is_file</span><span class="p">(),</span>
                <span class="s">'path'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="c1"># Get MIME type
</span>            <span class="n">mime_type</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="p">.</span><span class="n">guess_type</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mime_type</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filepath</span><span class="p">.</span><span class="n">is_dir</span><span class="p">():</span>
                    <span class="n">mime_type</span> <span class="o">=</span> <span class="s">'application/x-directory'</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mime_type</span> <span class="o">=</span> <span class="s">'application/octet-stream'</span>
            
            <span class="n">info</span><span class="p">[</span><span class="s">'mime_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mime_type</span>
            
            <span class="c1"># Get folder info if it's a directory
</span>            <span class="k">if</span> <span class="n">filepath</span><span class="p">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">file_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">.</span><span class="n">rglob</span><span class="p">(</span><span class="s">'*'</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">is_file</span><span class="p">():</span>
                        <span class="n">file_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">total_size</span> <span class="o">+=</span> <span class="n">item</span><span class="p">.</span><span class="n">stat</span><span class="p">().</span><span class="n">st_size</span>
                
                <span class="n">info</span><span class="p">[</span><span class="s">'file_count'</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_count</span>
                <span class="n">info</span><span class="p">[</span><span class="s">'total_size'</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_size</span>
            
            <span class="k">return</span> <span class="n">info</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">format_size</span><span class="p">(</span><span class="n">size_bytes</span><span class="p">):</span>
        <span class="s">"""Format file size in human-readable format"""</span>
        <span class="k">if</span> <span class="n">size_bytes</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size_bytes</span><span class="si">}</span><span class="s"> B"</span>
        <span class="k">elif</span> <span class="n">size_bytes</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size_bytes</span><span class="o">/</span><span class="mi">1024</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> KB"</span>
        <span class="k">elif</span> <span class="n">size_bytes</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size_bytes</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> MB"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size_bytes</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> GB"</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">open_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="s">"""Open file with default application"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="s">'Windows'</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="s">'Darwin'</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'open'</span><span class="p">,</span> <span class="n">filepath</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'xdg-open'</span><span class="p">,</span> <span class="n">filepath</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">open_folder</span><span class="p">(</span><span class="n">folderpath</span><span class="p">):</span>
        <span class="s">"""Open folder in file browser"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">folderpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folderpath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="s">'Windows'</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">folderpath</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="s">'Darwin'</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'open'</span><span class="p">,</span> <span class="n">folderpath</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'xdg-open'</span><span class="p">,</span> <span class="n">folderpath</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># ------------------ Clipboard Monitor ------------------
</span><span class="k">class</span> <span class="nc">ClipboardMonitor</span><span class="p">:</span>
    <span class="s">"""Monitor clipboard for changes with improved macOS handling"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clipboard_callback</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_callback</span> <span class="o">=</span> <span class="n">clipboard_callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span> <span class="o">=</span> <span class="n">log_callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_manager</span> <span class="o">=</span> <span class="n">ClipboardManager</span><span class="p">(</span><span class="n">log_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_sent_hash</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">monitor_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Start monitoring"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">monitor_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_monitor_loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">monitor_thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="s">"[MONITOR] Clipboard monitoring started"</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_monitor_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Main monitoring loop with improved error handling"""</span>
        <span class="n">consecutive_errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_consecutive_errors</span> <span class="o">=</span> <span class="mi">5</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">monitor_lock</span><span class="p">:</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_manager</span><span class="p">.</span><span class="n">check_for_changes</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="n">new_text</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">last_sent_hash</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_manager</span><span class="p">.</span><span class="n">last_hash</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">last_sent_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_manager</span><span class="p">.</span><span class="n">last_hash</span>
                        
                        <span class="n">clipboard_item</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s">'type'</span><span class="p">:</span> <span class="s">'text'</span><span class="p">,</span>
                            <span class="s">'data'</span><span class="p">:</span> <span class="n">new_text</span><span class="p">,</span>
                            <span class="s">'mime_type'</span><span class="p">:</span> <span class="s">'text/plain'</span><span class="p">,</span>
                            <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">(),</span>
                            <span class="s">'hash'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_manager</span><span class="p">.</span><span class="n">last_hash</span>
                        <span class="p">}</span>
                        
                        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_callback</span><span class="p">(</span><span class="n">clipboard_item</span><span class="p">)</span>
                        
                        <span class="c1"># Reset error counter on success
</span>                        <span class="n">consecutive_errors</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TEXT_CHECK_INTERVAL</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">consecutive_errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[MONITOR] Error in loop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">consecutive_errors</span> <span class="o">&gt;=</span> <span class="n">max_consecutive_errors</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="s">"[MONITOR] Too many errors, restarting clipboard manager..."</span><span class="p">)</span>
                    <span class="c1"># Reinitialize clipboard manager
</span>                    <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_manager</span> <span class="o">=</span> <span class="n">ClipboardManager</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">)</span>
                    <span class="n">consecutive_errors</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="c1"># Exponential backoff on errors
</span>                <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">TEXT_CHECK_INTERVAL</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="nb">min</span><span class="p">(</span><span class="n">consecutive_errors</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Stop monitoring"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="s">"[MONITOR] Clipboard monitoring stopped"</span><span class="p">)</span>

<span class="c1"># ------------------ TCP Server (Receiver with Progress) ------------------
</span><span class="k">class</span> <span class="nc">ClipboardReceiver</span><span class="p">:</span>
    <span class="s">"""Receive clipboard data with progress tracking"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">data_callback</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span> <span class="n">progress_callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">data_callback</span> <span class="o">=</span> <span class="n">data_callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span> <span class="o">=</span> <span class="n">log_callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span> <span class="o">=</span> <span class="n">progress_callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">server_socket</span> <span class="o">=</span> <span class="bp">None</span>
        
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Start TCP server"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_server_loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">server_thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[RECEIVER] Listening on TCP port </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_server_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Main server loop"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">server_socket</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">server_socket</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">port</span><span class="p">))</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">server_socket</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">server_socket</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">client_socket</span><span class="p">,</span> <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">server_socket</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
                    <span class="n">client_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_handle_client</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">client_address</span><span class="p">),</span>
                        <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span>
                    <span class="p">)</span>
                    <span class="n">client_thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
                    
                <span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">timeout</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[RECEIVER] Accept error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                        
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[RECEIVER] Server error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_handle_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_socket</span><span class="p">,</span> <span class="n">client_address</span><span class="p">):</span>
        <span class="s">"""Handle incoming connection with progress tracking"""</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">transfer_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"recv_</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">"</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client_socket</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            
            <span class="c1"># Receive header
</span>            <span class="n">header_data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_receive_with_progress</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">header_data</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span>
                
            <span class="n">header_len</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">'!I'</span><span class="p">,</span> <span class="n">header_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Receive header JSON
</span>            <span class="n">header_json</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_receive_with_progress</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">header_len</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">header_json</span><span class="p">:</span>
                <span class="k">return</span>
                
            <span class="n">header</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">header_json</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'type'</span><span class="p">,</span> <span class="s">'text'</span><span class="p">)</span>
            <span class="n">total_size</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'size'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">transfer_type</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'transfer_type'</span><span class="p">,</span> <span class="s">'single'</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'filename'</span><span class="p">,</span> <span class="sa">f</span><span class="s">'file_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
            <span class="n">is_folder</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'is_folder'</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            
            <span class="c1"># Start progress tracking for large files
</span>            <span class="k">if</span> <span class="n">total_size</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># &gt; 1MB
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'start_transfer'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                    <span class="s">'filename'</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="s">'total_size'</span><span class="p">:</span> <span class="n">total_size</span><span class="p">,</span>
                    <span class="s">'transfer_type'</span><span class="p">:</span> <span class="s">'receive'</span><span class="p">,</span>
                    <span class="s">'source_ip'</span><span class="p">:</span> <span class="n">ip</span>
                <span class="p">})</span>
                
                <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[RECEIVER] Receiving </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">FileTransferManager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span><span class="si">}</span><span class="s">) from </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Receive data with progress tracking
</span>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_receive_with_progress</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s">'text'</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">data_callback</span><span class="p">({</span>
                        <span class="s">'type'</span><span class="p">:</span> <span class="s">'text'</span><span class="p">,</span>
                        <span class="s">'data'</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                        <span class="s">'source_ip'</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
                        <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="p">})</span>
                    
                <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s">'file'</span><span class="p">:</span>
                    <span class="n">mime_type</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'mime_type'</span><span class="p">,</span> <span class="s">'application/octet-stream'</span><span class="p">)</span>
                    
                    <span class="n">file_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">'type'</span><span class="p">:</span> <span class="s">'file'</span><span class="p">,</span>
                        <span class="s">'data'</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                        <span class="s">'filename'</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                        <span class="s">'mime_type'</span><span class="p">:</span> <span class="n">mime_type</span><span class="p">,</span>
                        <span class="s">'is_folder'</span><span class="p">:</span> <span class="n">is_folder</span><span class="p">,</span>
                        <span class="s">'transfer_type'</span><span class="p">:</span> <span class="n">transfer_type</span><span class="p">,</span>
                        <span class="s">'source_ip'</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
                        <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="p">}</span>
                    
                    <span class="c1"># Add original folder name if it's a folder
</span>                    <span class="k">if</span> <span class="n">is_folder</span><span class="p">:</span>
                        <span class="n">file_data</span><span class="p">[</span><span class="s">'original_folder_name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'original_folder_name'</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    
                    <span class="bp">self</span><span class="p">.</span><span class="n">data_callback</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
            
            <span class="c1"># Complete progress tracking
</span>            <span class="k">if</span> <span class="n">total_size</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'complete_transfer'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                    <span class="s">'success'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s">'error_msg'</span><span class="p">:</span> <span class="bp">None</span>
                <span class="p">})</span>
                    
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[RECEIVER] Client error from </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">total_size</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'complete_transfer'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                    <span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s">'error_msg'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">client_socket</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
                
    <span class="k">def</span> <span class="nf">_receive_with_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">progress_start</span><span class="p">):</span>
        <span class="s">"""Receive data with progress tracking"""</span>
        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>
        <span class="n">bytes_received</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_progress_update</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="n">chunk</span>
                <span class="n">bytes_received</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                
                <span class="c1"># Update progress periodically
</span>                <span class="k">if</span> <span class="n">total_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_progress_update</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">/</span> <span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="k">if</span> <span class="n">progress</span> <span class="o">-</span> <span class="n">last_progress_update</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">bytes_received</span> <span class="o">%</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'update_progress'</span><span class="p">,</span> <span class="p">{</span>
                            <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                            <span class="s">'bytes_transferred'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                        <span class="p">})</span>
                        <span class="n">last_progress_update</span> <span class="o">=</span> <span class="n">progress</span>
                
            <span class="k">except</span> <span class="n">socket</span><span class="p">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">data</span>
        
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Stop server"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">server_socket</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">server_socket</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="s">"[RECEIVER] Server stopped"</span><span class="p">)</span>

<span class="c1"># ------------------ TCP Client (Sender with Progress) ------------------
</span><span class="k">class</span> <span class="nc">ClipboardSender</span><span class="p">:</span>
    <span class="s">"""Send clipboard data and files with progress tracking"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_callback</span><span class="p">,</span> <span class="n">progress_callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span> <span class="o">=</span> <span class="n">log_callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span> <span class="o">=</span> <span class="n">progress_callback</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span> <span class="o">=</span> <span class="n">FileTransferManager</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">send_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="s">"""Send text to device"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">sock</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">sock</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Prepare header
</span>                <span class="n">data</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
                <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">'type'</span><span class="p">:</span> <span class="s">'text'</span><span class="p">,</span>
                    <span class="s">'size'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
                    <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
                <span class="p">}</span>
                
                <span class="n">header_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">header</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
                <span class="n">header_len</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">'!I'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_json</span><span class="p">))</span>
                
                <span class="c1"># Send header length
</span>                <span class="n">sock</span><span class="p">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">header_len</span><span class="p">)</span>
                <span class="c1"># Send header
</span>                <span class="n">sock</span><span class="p">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">header_json</span><span class="p">)</span>
                <span class="c1"># Send data
</span>                <span class="n">sock</span><span class="p">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="bp">True</span>
                
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sock</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[SENDER] Error sending to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
            
    <span class="k">def</span> <span class="nf">send_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">is_folder</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">transfer_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""Send any file to device with progress tracking"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"File does not exist"</span>
            
            <span class="c1"># Get file info
</span>            <span class="n">file_info</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">error</span>
            
            <span class="c1"># Create transfer ID if not provided
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">transfer_id</span><span class="p">:</span>
                <span class="n">transfer_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"send_</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">"</span>
            
            <span class="c1"># Start progress tracking
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'start_transfer'</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                <span class="s">'filename'</span><span class="p">:</span> <span class="n">filepath</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">'total_size'</span><span class="p">:</span> <span class="n">file_info</span><span class="p">[</span><span class="s">'size'</span><span class="p">],</span>
                <span class="s">'transfer_type'</span><span class="p">:</span> <span class="s">'send'</span><span class="p">,</span>
                <span class="s">'destination_ip'</span><span class="p">:</span> <span class="n">ip</span>
            <span class="p">})</span>
            
            <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[SENDER] Starting transfer: </span><span class="si">{</span><span class="n">filepath</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="s">'size'</span><span class="p">])</span><span class="si">}</span><span class="s">) to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Read file in chunks for progress tracking
</span>            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">sock</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">sock</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Prepare header
</span>                <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">'type'</span><span class="p">:</span> <span class="s">'file'</span><span class="p">,</span>
                    <span class="s">'size'</span><span class="p">:</span> <span class="n">file_info</span><span class="p">[</span><span class="s">'size'</span><span class="p">],</span>
                    <span class="s">'filename'</span><span class="p">:</span> <span class="n">filepath</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s">'mime_type'</span><span class="p">:</span> <span class="n">file_info</span><span class="p">[</span><span class="s">'mime_type'</span><span class="p">],</span>
                    <span class="s">'is_folder'</span><span class="p">:</span> <span class="n">is_folder</span><span class="p">,</span>
                    <span class="s">'transfer_type'</span><span class="p">:</span> <span class="s">'single'</span><span class="p">,</span>
                    <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
                <span class="p">}</span>
                
                <span class="c1"># Add original folder name for folders
</span>                <span class="k">if</span> <span class="n">is_folder</span><span class="p">:</span>
                    <span class="n">header</span><span class="p">[</span><span class="s">'original_folder_name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">filepath</span><span class="p">.</span><span class="n">name</span>
                
                <span class="n">header_json</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">header</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
                <span class="n">header_len</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">'!I'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_json</span><span class="p">))</span>
                
                <span class="c1"># Send header length
</span>                <span class="n">sock</span><span class="p">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">header_len</span><span class="p">)</span>
                <span class="c1"># Send header
</span>                <span class="n">sock</span><span class="p">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">header_json</span><span class="p">)</span>
                
                <span class="c1"># Send file data in chunks with progress tracking
</span>                <span class="n">bytes_sent</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">last_progress_update</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                            <span class="k">break</span>
                        
                        <span class="n">sock</span><span class="p">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                        <span class="n">bytes_sent</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                        
                        <span class="c1"># Update progress periodically
</span>                        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_progress_update</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                            <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytes_sent</span> <span class="o">/</span> <span class="n">file_info</span><span class="p">[</span><span class="s">'size'</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
                            <span class="k">if</span> <span class="n">progress</span> <span class="o">-</span> <span class="n">last_progress_update</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'update_progress'</span><span class="p">,</span> <span class="p">{</span>
                                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                                    <span class="s">'bytes_transferred'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                                <span class="p">})</span>
                                <span class="n">last_progress_update</span> <span class="o">=</span> <span class="n">progress</span>
                
                <span class="c1"># Complete progress tracking
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'complete_transfer'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                    <span class="s">'success'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s">'error_msg'</span><span class="p">:</span> <span class="bp">None</span>
                <span class="p">})</span>
                
                <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[SENDER] Transfer completed: </span><span class="si">{</span><span class="n">filepath</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">None</span>
                
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sock</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[SENDER] Error sending file to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Mark transfer as failed
</span>            <span class="k">if</span> <span class="n">transfer_id</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'complete_transfer'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                    <span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s">'error_msg'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">})</span>
            
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">send_folder_as_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">,</span> <span class="n">transfer_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""Send folder as ZIP archive with progress tracking"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_path</span><span class="p">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">folder_path</span><span class="p">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"Not a valid folder"</span>
            
            <span class="c1"># Create transfer ID if not provided
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">transfer_id</span><span class="p">:</span>
                <span class="n">transfer_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"send_folder_</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">"</span>
            
            <span class="c1"># Get folder info
</span>            <span class="n">folder_info</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">error</span>
            
            <span class="c1"># Start progress tracking for preparation
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'start_transfer'</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                <span class="s">'filename'</span><span class="p">:</span> <span class="n">folder_path</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">'total_size'</span><span class="p">:</span> <span class="n">folder_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'total_size'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s">'transfer_type'</span><span class="p">:</span> <span class="s">'send'</span><span class="p">,</span>
                <span class="s">'destination_ip'</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
                <span class="s">'is_folder'</span><span class="p">:</span> <span class="bp">True</span>
            <span class="p">})</span>
            
            <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[SENDER] Preparing folder: </span><span class="si">{</span><span class="n">folder_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">folder_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'file_count'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s"> files, </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">folder_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'total_size'</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
            
            <span class="c1"># Create ZIP with progress callback
</span>            <span class="k">def</span> <span class="nf">zip_progress_callback</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'update_progress'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                    <span class="s">'bytes_transferred'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s">'message'</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                    <span class="s">'preparation_progress'</span><span class="p">:</span> <span class="n">progress</span>
                <span class="p">})</span>
            
            <span class="n">zip_path</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">zip_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">zip_progress_callback</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'complete_transfer'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                    <span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s">'error_msg'</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Failed to create ZIP: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span>
                <span class="p">})</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Failed to create ZIP: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Send ZIP file
</span>                <span class="n">success</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">send_file</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">,</span> <span class="n">is_folder</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transfer_id</span><span class="o">=</span><span class="n">transfer_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[SENDER] Folder sent successfully: </span><span class="si">{</span><span class="n">folder_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s">'complete_transfer'</span><span class="p">,</span> <span class="p">{</span>
                        <span class="s">'transfer_id'</span><span class="p">:</span> <span class="n">transfer_id</span><span class="p">,</span>
                        <span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                        <span class="s">'error_msg'</span><span class="p">:</span> <span class="n">error</span>
                    <span class="p">})</span>
                
                <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">error</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Clean up temp ZIP
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">log_callback</span><span class="p">(</span><span class="sa">f</span><span class="s">"[SENDER] Error sending folder to </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="c1"># ------------------ Circular Progress Dialog ------------------
</span><span class="k">class</span> <span class="nc">CircularProgressDialog</span><span class="p">:</span>
    <span class="s">"""Modal dialog showing circular progress indicator"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">transfer_type</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">total_size</span> <span class="o">=</span> <span class="n">total_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transfer_type</span> <span class="o">=</span> <span class="n">transfer_type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">destination</span>
        
        <span class="c1"># Create dialog
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Toplevel</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="s">'Sending'</span> <span class="k">if</span> <span class="n">transfer_type</span> <span class="o">==</span> <span class="s">'send'</span> <span class="k">else</span> <span class="s">'Receiving'</span><span class="si">}</span><span class="s"> File"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">geometry</span><span class="p">(</span><span class="s">"400x250"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">resizable</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">transient</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">grab_set</span><span class="p">()</span>
        
        <span class="c1"># Center dialog
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">update_idletasks</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">winfo_x</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">winfo_width</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">200</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">winfo_y</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">winfo_height</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">125</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">geometry</span><span class="p">(</span><span class="sa">f</span><span class="s">"+</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">+</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># Create widgets
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_create_widgets</span><span class="p">()</span>
        
        <span class="c1"># Start time
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_create_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Create dialog widgets"""</span>
        <span class="c1"># Main frame
</span>        <span class="n">main_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">main_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Title
</span>        <span class="n">title_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="s">'Sending'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_type</span> <span class="o">==</span> <span class="s">'send'</span> <span class="k">else</span> <span class="s">'Receiving'</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">filename</span><span class="si">}</span><span class="s">"</span>
        <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">main_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">title_text</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">'TkDefaultFont'</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="s">'bold'</span><span class="p">)).</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">W</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Destination
</span>        <span class="n">dest_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="s">'To'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_type</span> <span class="o">==</span> <span class="s">'send'</span> <span class="k">else</span> <span class="s">'From'</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">destination</span><span class="si">}</span><span class="s">"</span>
        <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">main_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">dest_text</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">W</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Size info
</span>        <span class="n">size_str</span> <span class="o">=</span> <span class="n">FileTransferManager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">total_size</span><span class="p">)</span>
        <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">main_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s">"Size: </span><span class="si">{</span><span class="n">size_str</span><span class="si">}</span><span class="s">"</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">W</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Progress frame
</span>        <span class="n">progress_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">main_frame</span><span class="p">)</span>
        <span class="n">progress_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Circular progress indicator
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">progress_circle</span> <span class="o">=</span> <span class="n">CircularProgress</span><span class="p">(</span><span class="n">progress_frame</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">progress_circle</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">progress_circle</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="c1"># Status label
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">status_label</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">progress_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Transfer in progress..."</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">status_label</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="c1"># Cancel button
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">cancel_button</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">main_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Cancel"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">cancel</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">cancel_button</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percentage</span><span class="p">,</span> <span class="n">current_size</span><span class="p">,</span> <span class="n">total_size</span><span class="p">):</span>
        <span class="s">"""Update progress display - simplified for circular progress"""</span>
        <span class="c1"># Update status text occasionally
</span>        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentage</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_str</span> <span class="o">=</span> <span class="n">FileTransferManager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">current_size</span><span class="p">)</span>
            <span class="n">total_str</span> <span class="o">=</span> <span class="n">FileTransferManager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">status_label</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">current_str</span><span class="si">}</span><span class="s"> of </span><span class="si">{</span><span class="n">total_str</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
        <span class="c1"># Update dialog
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""Mark transfer as complete"""</span>
        <span class="c1"># Stop the circular animation
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">progress_circle</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="c1"># Change to success color (green)
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">progress_circle</span><span class="p">.</span><span class="n">set_color</span><span class="p">(</span><span class="s">"#4CAF50"</span><span class="p">)</span>
            
            <span class="c1"># Draw a checkmark
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">status_label</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">"Transfer complete!"</span><span class="p">)</span>
            
            <span class="c1"># Change cancel button to close
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">cancel_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">"Close"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">destroy</span><span class="p">)</span>
            
            <span class="c1"># Auto-close after 2 seconds
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">destroy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Change to error color (red)
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">progress_circle</span><span class="p">.</span><span class="n">set_color</span><span class="p">(</span><span class="s">"#F44336"</span><span class="p">)</span>
            
            <span class="c1"># Show error message
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">status_label</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s">"Error: </span><span class="si">{</span><span class="n">error_msg</span><span class="p">[</span><span class="si">:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s">..."</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">cancel_button</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">"Close"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">destroy</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Cancel the transfer"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">destroy</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">is_cancelled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Check if dialog was closed"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">dialog</span><span class="p">.</span><span class="n">winfo_exists</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

<span class="c1"># ------------------ Main Application GUI ------------------
</span><span class="k">class</span> <span class="nc">PyShineClipboardApp</span><span class="p">:</span>
    <span class="s">"""Main application with progress tracking - Direct Connection Version"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s">"PyShine Clipboard Pro - v1.0"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">geometry</span><span class="p">(</span><span class="s">"1000x850"</span><span class="p">)</span>
        
        <span class="c1"># Configure styles
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Style</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">theme_use</span><span class="p">(</span><span class="s">'clam'</span><span class="p">)</span>
        <span class="c1"># Initialize primary_received_dir
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">primary_received_dir</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Variables
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">auto_sync_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">BooleanVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">notify_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">BooleanVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">"192.168.1.100"</span><span class="p">)</span>  <span class="c1"># Default target IP
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">"6000"</span><span class="p">)</span>  <span class="c1"># Default port
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">local_ip_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
        
        <span class="c1"># Data storage
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">received_files</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Progress tracking
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">progress_dialogs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">progress_manager</span> <span class="o">=</span> <span class="n">ProgressManager</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_progress_callback</span><span class="p">)</span>
        
        <span class="c1"># Clipboard state
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">last_received_hash</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">is_processing</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="c1"># Create queues
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">log_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">progress_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>
        
        <span class="c1"># Load cached IP if available
</span>        <span class="n">cached_ip</span><span class="p">,</span> <span class="n">cached_port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_load_cached_ip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cached_ip</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">cached_ip</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_port</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">cached_port</span><span class="p">)</span>
        
        <span class="c1"># Initialize components
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_init_components</span><span class="p">()</span>
        
        <span class="c1"># Start services
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_start_services</span><span class="p">()</span>
        
        <span class="c1"># Start GUI update loop
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_update_gui_loop</span><span class="p">()</span>
        
        <span class="c1"># Setup window close handler - CRITICAL FIX
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">protocol</span><span class="p">(</span><span class="s">"WM_DELETE_WINDOW"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">on_closing</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"="</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"PyShine Clipboard Pro - v1.0"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"Device ID: </span><span class="si">{</span><span class="n">DEVICE_ID</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"Platform: </span><span class="si">{</span><span class="n">HOST_OS</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"Clipboard Backend: </span><span class="si">{</span><span class="n">CLIPBOARD_BACKEND</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"Mode: DIRECT CONNECTION BETWEEN TWO PCs"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"Enter target IP and port to connect"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"="</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="c1"># Get and display local IP
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_update_local_ip</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_get_cache_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Get path to cache file"""</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">".pyshine_clipboard"</span>
        <span class="n">cache_dir</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache_dir</span> <span class="o">/</span> <span class="s">"last_connection.cache"</span>

    <span class="k">def</span> <span class="nf">_load_cached_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Load cached IP and port from file"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cache_file</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_cache_path</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cache_file</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                        <span class="c1"># Format: "IP:PORT"
</span>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">ip</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">port</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">return</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">"6000"</span>  <span class="c1"># Default port
</span>        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to load cached IP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_save_cached_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""Save current IP and port to cache file"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ip</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="c1"># Validate
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ip</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
                <span class="k">return</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">validate_ip_address</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
                <span class="k">return</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">is_valid_port</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
                <span class="k">return</span>
            
            <span class="c1"># Save to cache
</span>            <span class="n">cache_file</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_cache_path</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"Cached connection: </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to cache IP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_update_local_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Update local IP display"""</span>
        <span class="n">local_ip</span> <span class="o">=</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">get_local_ip</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">local_ip_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="sa">f</span><span class="s">"Enter the IP address of Target"</span><span class="p">)</span>
        <span class="c1"># self._log(f"Local IP: {local_ip}")
</span>
    <span class="k">def</span> <span class="nf">_init_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Initialize GUI components"""</span>
        <span class="c1"># Main container
</span>        <span class="n">main_container</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">PanedWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
        <span class="n">main_container</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="c1"># Left panel - Connection and controls
</span>        <span class="n">left_panel</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">main_container</span><span class="p">)</span>
        <span class="n">main_container</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">left_panel</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Connection frame
</span>        <span class="n">connection_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">LabelFrame</span><span class="p">(</span><span class="n">left_panel</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Direct Connection"</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">connection_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Local IP display
</span>        <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">connection_frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">local_ip_var</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">'TkDefaultFont'</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">'bold'</span><span class="p">)).</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">W</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Target IP entry
</span>        <span class="n">ip_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">connection_frame</span><span class="p">)</span>
        <span class="n">ip_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">ip_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Target IP:"</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_entry</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">ip_frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_entry</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="c1"># Port entry
</span>        <span class="n">port_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">connection_frame</span><span class="p">)</span>
        <span class="n">port_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">port_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Port:"</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">target_port_entry</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Entry</span><span class="p">(</span><span class="n">port_frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">target_port_entry</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">port_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"(Default: 6000)"</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>
        
        <span class="c1"># Connection buttons frame
</span>        <span class="n">btn_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">connection_frame</span><span class="p">)</span>
        <span class="n">btn_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">btn_frame</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"Connection"</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_test_connection</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">15</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">btn_frame</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"Refresh Local IP"</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_update_local_ip</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">15</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>
        
        <span class="c1"># Connection status
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">"Not connected"</span><span class="p">)</span>
        <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">connection_frame</span><span class="p">,</span> <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">connection_status_var</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">'TkDefaultFont'</span><span class="p">,</span> <span class="mi">9</span><span class="p">)).</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">W</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="c1"># Transfer controls
</span>        <span class="n">transfer_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">LabelFrame</span><span class="p">(</span><span class="n">left_panel</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Transfer Controls"</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">transfer_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Buttons grid
</span>        <span class="n">btn_grid</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">transfer_frame</span><span class="p">)</span>
        <span class="n">btn_grid</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">)</span>
        
        <span class="c1"># Row 1
</span>        <span class="n">row1</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">btn_grid</span><span class="p">)</span>
        <span class="n">row1</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">row1</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"📄 Send File..."</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_send_file_dialog</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">18</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">row1</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"📁 Send Folder..."</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_send_folder_dialog</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">18</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>
        
        <span class="c1"># Row 2
</span>        <span class="n">row2</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">btn_grid</span><span class="p">)</span>
        <span class="n">row2</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">row2</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"🎬 Send Video..."</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_send_video_dialog</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">18</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">row2</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"📋 Sync Clipboard"</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_sync_clipboard</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">18</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>
        
        <span class="c1"># Row 3 - Clipboard sync controls
</span>        <span class="n">row3</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">btn_grid</span><span class="p">)</span>
        <span class="n">row3</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">row3</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"🔄 Start Sync"</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_start_clipboard_sync</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">18</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">row3</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"⏸️ Stop Sync"</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_stop_clipboard_sync</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">18</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>
        
        <span class="c1"># Settings frame
</span>        <span class="n">settings_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">LabelFrame</span><span class="p">(</span><span class="n">left_panel</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Settings"</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">settings_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">)</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Checkbutton</span><span class="p">(</span>
            <span class="n">settings_frame</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"Auto-sync clipboard text"</span><span class="p">,</span>
            <span class="n">variable</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">auto_sync_var</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_toggle_auto_sync</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">W</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Checkbutton</span><span class="p">(</span>
            <span class="n">settings_frame</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"Show notifications"</span><span class="p">,</span>
            <span class="n">variable</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">notify_var</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">W</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Right panel - Clipboard and logs
</span>        <span class="n">right_panel</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">main_container</span><span class="p">)</span>
        <span class="n">main_container</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">right_panel</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Clipboard display
</span>        <span class="n">clipboard_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">LabelFrame</span><span class="p">(</span><span class="n">right_panel</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Current Clipboard"</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">clipboard_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_text</span> <span class="o">=</span> <span class="n">scrolledtext</span><span class="p">.</span><span class="n">ScrolledText</span><span class="p">(</span>
            <span class="n">clipboard_frame</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">wrap</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">WORD</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">'TkDefaultFont'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_text</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'disabled'</span><span class="p">)</span>
        
        <span class="c1"># Active transfers frame
</span>        <span class="n">transfers_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">LabelFrame</span><span class="p">(</span><span class="n">right_panel</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Active Transfers"</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">transfers_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Transfers list
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">transfers_text</span> <span class="o">=</span> <span class="n">scrolledtext</span><span class="p">.</span><span class="n">ScrolledText</span><span class="p">(</span>
            <span class="n">transfers_frame</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">wrap</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">WORD</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">'Courier'</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transfers_text</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transfers_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'disabled'</span><span class="p">)</span>
        
        <span class="c1"># Log display
</span>        <span class="n">log_frame</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">LabelFrame</span><span class="p">(</span><span class="n">right_panel</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Activity Log"</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">log_frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span> <span class="o">=</span> <span class="n">scrolledtext</span><span class="p">.</span><span class="n">ScrolledText</span><span class="p">(</span>
            <span class="n">log_frame</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">wrap</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">WORD</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">'Courier'</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'disabled'</span><span class="p">)</span>
        
        <span class="c1"># Log controls
</span>        <span class="n">log_controls</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">log_frame</span><span class="p">)</span>
        <span class="n">log_controls</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">log_controls</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"Clear Log"</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_clear_log</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">log_controls</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"Copy Log"</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_copy_log</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="n">ttk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">log_controls</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s">"Open Received"</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_open_received_folder</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">12</span>
        <span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">RIGHT</span><span class="p">)</span>
        
        <span class="c1"># Status bar
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">relief</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">SUNKEN</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">status_bar</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">BOTTOM</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">X</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">StringVar</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">"Ready | Enter target IP and port"</span><span class="p">)</span>
        <span class="n">status_label</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">status_bar</span><span class="p">,</span>
            <span class="n">textvariable</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">,</span>
            <span class="n">anchor</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">W</span>
        <span class="p">)</span>
        <span class="n">status_label</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="c1"># Circular progress indicator in status bar
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">status_progress</span> <span class="o">=</span> <span class="n">CircularProgress</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">status_bar</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"#2196F3"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">status_progress</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">status_progress</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_icon</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">status_bar</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"🔴"</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">'TkDefaultFont'</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_icon</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_start_services</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Start all background services"""</span>
        <span class="c1"># Get port from entry or use default
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">TCP_PORT</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">receiver</span> <span class="o">=</span> <span class="n">ClipboardReceiver</span><span class="p">(</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_clipboard_received</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log_callback</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_progress_callback</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_monitor</span> <span class="o">=</span> <span class="n">ClipboardMonitor</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_clipboard_changed</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log_callback</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">ClipboardSender</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_log_callback</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_progress_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_manager</span> <span class="o">=</span> <span class="n">ClipboardManager</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_log_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span> <span class="o">=</span> <span class="n">FileTransferManager</span><span class="p">()</span>
        
        <span class="c1"># Start services
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_monitor</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_test_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Test connection to target"""</span>
        <span class="n">target_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">target_port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_ip</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s">"No IP"</span><span class="p">,</span> <span class="s">"Please enter target IP address"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_port</span><span class="p">:</span>
            <span class="n">target_port</span> <span class="o">=</span> <span class="s">"6000"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        
        <span class="c1"># Validate IP address
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">validate_ip_address</span><span class="p">(</span><span class="n">target_ip</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid IP"</span><span class="p">,</span> <span class="s">"Please enter a valid IP address (e.g., 192.168.1.100)"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Validate port
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">is_valid_port</span><span class="p">(</span><span class="n">target_port</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid Port"</span><span class="p">,</span> <span class="s">"Please enter a valid port number (1-65535)"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">target_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"🔧 Testing connection to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="sa">f</span><span class="s">"Testing connection to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">"Testing connection..."</span><span class="p">)</span>
            
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">sock</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">))</span>
            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            
            <span class="n">sock</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅ Connection successful to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="si">}</span><span class="s">ms)"</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="sa">f</span><span class="s">"Connected to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="sa">f</span><span class="s">"Connected to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_icon</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">"🟢"</span><span class="p">)</span>
                <span class="c1"># Save to cache
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">_save_cached_ip</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">)</span>
                
                <span class="c1"># Test clipboard sync
</span>                <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_test_clipboard_sync</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Connection failed to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="sa">f</span><span class="s">"Connection failed to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="sa">f</span><span class="s">"Connection failed"</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_icon</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">"🔴"</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Connection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="sa">f</span><span class="s">"Connection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">"Connection error"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">connection_status_icon</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">"🔴"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_test_clipboard_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">):</span>
        <span class="s">"""Test clipboard synchronization"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Send a test message
</span>            <span class="n">test_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Clipboard sync test from </span><span class="si">{</span><span class="n">DEVICE_ID</span><span class="si">}</span><span class="s"> at </span><span class="si">{</span><span class="n">time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%H</span><span class="si">:</span><span class="o">%</span><span class="n">M</span><span class="si">:</span><span class="o">%</span><span class="n">S</span><span class="s">')</span><span class="si">}</span><span class="s">"</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">send_text</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">test_message</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅ Clipboard sync test successful"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"⚠️ Clipboard sync test failed"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"⚠️ Clipboard test error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_sync_clipboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Manually sync clipboard to target"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">auto_sync_var</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">return</span>
        
        <span class="n">target_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">target_port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_ip</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s">"No IP"</span><span class="p">,</span> <span class="s">"Please enter target IP address"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_port</span><span class="p">:</span>
            <span class="n">target_port</span> <span class="o">=</span> <span class="s">"6000"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        
        <span class="c1"># Validate IP address
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">validate_ip_address</span><span class="p">(</span><span class="n">target_ip</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid IP"</span><span class="p">,</span> <span class="s">"Please enter a valid IP address"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Validate port
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">is_valid_port</span><span class="p">(</span><span class="n">target_port</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid Port"</span><span class="p">,</span> <span class="s">"Please enter a valid port number"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">target_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get current clipboard text
</span>            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_manager</span><span class="p">.</span><span class="n">get_clipboard_text</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">text</span><span class="p">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">send_text</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📤 Sent clipboard to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_update_clipboard_display</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to send clipboard"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"📋 Clipboard is empty"</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Clipboard sync error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_start_clipboard_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Start automatic clipboard synchronization"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">auto_sync_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"🔄 Auto-sync enabled"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">"Auto-sync enabled"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_stop_clipboard_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Stop automatic clipboard synchronization"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">auto_sync_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"⏸️ Auto-sync disabled"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">"Auto-sync disabled"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_clipboard_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clipboard_item</span><span class="p">):</span>
        <span class="s">"""Handle local clipboard changes"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">auto_sync_var</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_processing</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">target_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">target_port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_ip</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target_port</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Validate IP and port
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">validate_ip_address</span><span class="p">(</span><span class="n">target_ip</span><span class="p">):</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">clipboard_item</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'hash'</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">last_received_hash</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📋 Clipboard changed (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clipboard_item</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span><span class="si">}</span><span class="s"> chars)"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_update_clipboard_display</span><span class="p">(</span><span class="n">clipboard_item</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
        
        <span class="c1"># Send to target
</span>        <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_send_to_target</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">clipboard_item</span><span class="p">),</span>
            <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">).</span><span class="n">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_send_to_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">clipboard_item</span><span class="p">):</span>
        <span class="s">"""Send clipboard item to target"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">send_text</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">clipboard_item</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📤 Sent to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to send to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Send error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_clipboard_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="s">"""Handle received clipboard data"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">is_processing</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'text'</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">]</span>
                <span class="n">source_ip</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'source_ip'</span><span class="p">,</span> <span class="s">'Unknown'</span><span class="p">)</span>
                <span class="n">source_port</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'source_port'</span><span class="p">,</span> <span class="s">'Unknown'</span><span class="p">)</span>
                
                <span class="n">text_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="n">encode</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">text_hash</span> <span class="o">==</span> <span class="bp">self</span><span class="p">.</span><span class="n">last_received_hash</span><span class="p">:</span>
                    <span class="k">return</span>
                    
                <span class="bp">self</span><span class="p">.</span><span class="n">last_received_hash</span> <span class="o">=</span> <span class="n">text_hash</span>
                
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_manager</span><span class="p">.</span><span class="n">set_clipboard_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_update_clipboard_display</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📥 Received text from </span><span class="si">{</span><span class="n">source_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">source_port</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">notify_var</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">_show_notification</span><span class="p">(</span><span class="sa">f</span><span class="s">"Clipboard updated from </span><span class="si">{</span><span class="n">source_ip</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"❌ Failed to set clipboard"</span><span class="p">)</span>
                    
            <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'file'</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_save_received_file</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">is_processing</span> <span class="o">=</span> <span class="bp">False</span>
    
    
    <span class="k">def</span> <span class="nf">_save_received_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="s">"""Save received file or folder with robust permission handling and fallbacks"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get file information from data
</span>            <span class="n">filename</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'filename'</span><span class="p">,</span> <span class="sa">f</span><span class="s">'received_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
            <span class="n">is_folder</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'is_folder'</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">transfer_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'transfer_type'</span><span class="p">,</span> <span class="s">'single'</span><span class="p">)</span>
            <span class="n">source_ip</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'source_ip'</span><span class="p">,</span> <span class="s">'Unknown'</span><span class="p">)</span>
            
            <span class="c1"># ===== STEP 1: DETERMINE SAVE LOCATION WITH FALLBACKS =====
</span>            <span class="n">received_dir</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">save_location_type</span> <span class="o">=</span> <span class="s">"Unknown"</span>
            
            <span class="c1"># Try multiple locations in order of preference
</span>            <span class="n">possible_locations</span> <span class="o">=</span> <span class="p">[</span>
                <span class="c1"># 1. Primary location in user's home directory
</span>                <span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"ClipboardReceived"</span><span class="p">,</span> <span class="s">"Home Directory"</span><span class="p">),</span>
                <span class="c1"># 2. Downloads folder (usually has write access)
</span>                <span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"Downloads"</span> <span class="o">/</span> <span class="s">"ClipboardReceived"</span><span class="p">,</span> <span class="s">"Downloads"</span><span class="p">),</span>
                <span class="c1"># 3. Desktop (user-visible location)
</span>                <span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"Desktop"</span> <span class="o">/</span> <span class="s">"ClipboardReceived"</span><span class="p">,</span> <span class="s">"Desktop"</span><span class="p">),</span>
                <span class="c1"># 4. Documents folder
</span>                <span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"Documents"</span> <span class="o">/</span> <span class="s">"ClipboardReceived"</span><span class="p">,</span> <span class="s">"Documents"</span><span class="p">),</span>
                <span class="c1"># 5. Application Support (macOS convention)
</span>                <span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"Library"</span> <span class="o">/</span> <span class="s">"Application Support"</span> <span class="o">/</span> <span class="s">"PyShineClipboard"</span> <span class="o">/</span> <span class="s">"Received"</span><span class="p">,</span> <span class="s">"Application Support"</span><span class="p">),</span>
                <span class="c1"># 6. Last resort: Temporary directory
</span>                <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="n">gettempdir</span><span class="p">())</span> <span class="o">/</span> <span class="s">"PyShineClipboard_Received"</span><span class="p">,</span> <span class="s">"Temporary"</span><span class="p">)</span>
            <span class="p">]</span>
            
            <span class="c1"># Try each location until we find one we can write to
</span>            <span class="k">for</span> <span class="n">location</span><span class="p">,</span> <span class="n">location_name</span> <span class="ow">in</span> <span class="n">possible_locations</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create directory if it doesn't exist
</span>                    <span class="n">location</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    
                    <span class="c1"># Test if we can write to this directory
</span>                    <span class="n">test_file</span> <span class="o">=</span> <span class="n">location</span> <span class="o">/</span> <span class="s">".write_test"</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test_file</span><span class="p">.</span><span class="n">touch</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="c1"># Write something to the file
</span>                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"test"</span><span class="p">)</span>
                        <span class="n">test_file</span><span class="p">.</span><span class="n">unlink</span><span class="p">()</span>  <span class="c1"># Clean up
</span>                        
                        <span class="c1"># If we get here, we can write to this location
</span>                        <span class="n">received_dir</span> <span class="o">=</span> <span class="n">location</span>
                        
                        
                        <span class="n">save_location_type</span> <span class="o">=</span> <span class="n">location_name</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✓ Using </span><span class="si">{</span><span class="n">location_name</span><span class="si">}</span><span class="s"> for saving: </span><span class="si">{</span><span class="n">received_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                        <span class="k">break</span>
                        
                    <span class="k">except</span> <span class="p">(</span><span class="n">PermissionError</span><span class="p">,</span> <span class="nb">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✗ Cannot write to </span><span class="si">{</span><span class="n">location_name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                        <span class="k">continue</span>
                        
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✗ Failed to access </span><span class="si">{</span><span class="n">location_name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">continue</span>
            
            <span class="c1"># If all automatic locations failed, ask the user
</span>            <span class="k">if</span> <span class="n">received_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"⚠️ All automatic save locations failed. Asking user..."</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_ask_for_save_location</span><span class="p">)</span>
                <span class="c1"># Wait a bit for user response (non-blocking in real app)
</span>                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># Check if user provided a location (you'll need to implement _get_user_save_location)
</span>                <span class="n">user_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_user_save_location</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">user_dir</span><span class="p">:</span>
                    <span class="n">received_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">user_dir</span><span class="p">)</span>
                    <span class="n">save_location_type</span> <span class="o">=</span> <span class="s">"User Selected"</span>
                    <span class="n">received_dir</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"❌ No save location available. File not saved."</span><span class="p">)</span>
                    <span class="k">return</span>
            
            <span class="c1"># ===== STEP 2: SAVE THE ACTUAL FILE/FOLDER =====
</span>            <span class="k">if</span> <span class="n">is_folder</span><span class="p">:</span>
                <span class="c1"># It's a folder (ZIP file)
</span>                <span class="n">original_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'original_folder_name'</span><span class="p">,</span> <span class="n">filename</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'.zip'</span><span class="p">,</span> <span class="s">''</span><span class="p">))</span>
                
                <span class="c1"># Save ZIP file
</span>                <span class="n">zip_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">.zip"</span>
                <span class="n">zip_path</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="n">zip_filename</span>
                
                <span class="c1"># Write ZIP data
</span>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
                
                <span class="c1"># Create extract path
</span>                <span class="n">extract_path</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="n">original_name</span>
                
                <span class="c1"># Avoid overwriting - add number if folder exists
</span>                <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">extract_path</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">extract_path</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s">"</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="n">extract_path</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                
                <span class="c1"># Extract ZIP
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                        <span class="c1"># Get list of files for progress reporting
</span>                        <span class="n">file_list</span> <span class="o">=</span> <span class="n">zipf</span><span class="p">.</span><span class="n">namelist</span><span class="p">()</span>
                        <span class="n">total_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span>
                        
                        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📦 Extracting </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="s"> files from </span><span class="si">{</span><span class="n">zip_filename</span><span class="si">}</span><span class="s">..."</span><span class="p">)</span>
                        
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">zipf</span><span class="p">.</span><span class="n">extract</span><span class="p">(</span><span class="n">file_info</span><span class="p">,</span> <span class="n">extract_path</span><span class="p">)</span>
                            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"⚠️ Failed to extract </span><span class="si">{</span><span class="n">file_info</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                                <span class="k">continue</span>
                            
                            <span class="c1"># Log progress for large archives
</span>                            <span class="k">if</span> <span class="n">total_files</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total_files</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">total_files</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"   Extracting... </span><span class="si">{</span><span class="n">progress</span><span class="si">:</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="si">}</span><span class="s">% (</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
                    
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅ Extraction complete: </span><span class="si">{</span><span class="n">extract_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    
                <span class="k">except</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">BadZipFile</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Error: </span><span class="si">{</span><span class="n">zip_filename</span><span class="si">}</span><span class="s"> is not a valid ZIP file"</span><span class="p">)</span>
                    <span class="c1"># Try to save the raw file anyway
</span>                    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s">.zip"</span>
                    <span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="n">raw_path</span><span class="p">)</span>
                    <span class="n">extract_path</span> <span class="o">=</span> <span class="n">raw_path</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"💾 Saved as raw file instead: </span><span class="si">{</span><span class="n">raw_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Clean up ZIP file after successful extraction
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">zip_path</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="n">zip_path</span><span class="p">.</span><span class="n">unlink</span><span class="p">()</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"🧹 Cleaned up ZIP file: </span><span class="si">{</span><span class="n">zip_filename</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># Don't worry if we can't delete the zip
</span>                
                <span class="n">final_path</span> <span class="o">=</span> <span class="n">extract_path</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📁 Folder saved: </span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s"> → </span><span class="si">{</span><span class="n">save_location_type</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Regular file
</span>                <span class="c1"># Handle duplicate filenames
</span>                <span class="n">filepath</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="n">filename</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">name_parts</span> <span class="o">=</span> <span class="n">filename</span><span class="p">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="k">while</span> <span class="n">filepath</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">new_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">name_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">"</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s">"</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="n">new_filename</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Safety limit
</span>                        <span class="n">filepath</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">"</span>
                        <span class="k">break</span>
                
                <span class="c1"># Save the file
</span>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
                
                <span class="n">final_path</span> <span class="o">=</span> <span class="n">filepath</span>
                <span class="n">file_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
                <span class="n">size_str</span> <span class="o">=</span> <span class="n">FileTransferManager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">file_size</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📄 File saved: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">size_str</span><span class="si">}</span><span class="s">) → </span><span class="si">{</span><span class="n">save_location_type</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># ===== STEP 3: POST-SAVE ACTIONS =====
</span>            <span class="c1"># Add to recent transfers list
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">received_files</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">'path'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_path</span><span class="p">),</span>
                <span class="s">'name'</span><span class="p">:</span> <span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">'is_folder'</span><span class="p">:</span> <span class="n">is_folder</span><span class="p">,</span>
                <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="s">'size'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">]),</span>
                <span class="s">'location'</span><span class="p">:</span> <span class="n">save_location_type</span><span class="p">,</span>
                <span class="s">'source'</span><span class="p">:</span> <span class="n">source_ip</span>
            <span class="p">})</span>
            
            <span class="c1"># Update transfers list display
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">_update_transfers_list</span><span class="p">()</span>
            
            <span class="c1"># Show notification if enabled
</span>            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">notify_var</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">is_folder</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_show_notification</span><span class="p">(</span><span class="sa">f</span><span class="s">"📁 Folder received from </span><span class="si">{</span><span class="n">source_ip</span><span class="si">}</span><span class="s"> "</span> <span class="o">+</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s">Saved to: </span><span class="si">{</span><span class="n">save_location_type</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_show_notification</span><span class="p">(</span><span class="sa">f</span><span class="s">"📄 File received from </span><span class="si">{</span><span class="n">source_ip</span><span class="si">}</span><span class="s"> "</span> <span class="o">+</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s">Saved to: </span><span class="si">{</span><span class="n">save_location_type</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># ===== STEP 4: ASK USER WHAT TO DO =====
</span>            <span class="k">def</span> <span class="nf">ask_user_action</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">is_folder</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">messagebox</span><span class="p">.</span><span class="n">askyesnocancel</span><span class="p">(</span>
                        <span class="s">"Folder Received"</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s">"Received folder: </span><span class="si">{</span><span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n\n</span><span class="s">"</span>
                        <span class="sa">f</span><span class="s">"Location: </span><span class="si">{</span><span class="n">save_location_type</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
                        <span class="sa">f</span><span class="s">"From: </span><span class="si">{</span><span class="n">source_ip</span><span class="si">}</span><span class="se">\n\n</span><span class="s">"</span>
                        <span class="s">"What would you like to do?"</span><span class="p">,</span>
                        <span class="n">detail</span><span class="o">=</span><span class="s">"Yes: Open folder</span><span class="se">\n</span><span class="s">No: Show in Finder</span><span class="se">\n</span><span class="s">Cancel: Do nothing"</span>
                    <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>  <span class="c1"># Yes - Open folder
</span>                        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">open_folder</span><span class="p">(</span><span class="n">final_path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to open folder: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>  <span class="c1"># No - Show in Finder
</span>                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Darwin"</span><span class="p">:</span>
                                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'open'</span><span class="p">,</span> <span class="s">'-R'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_path</span><span class="p">)])</span>
                            <span class="k">elif</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span><span class="p">:</span>
                                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'explorer'</span><span class="p">,</span> <span class="s">'/select,'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_path</span><span class="p">)])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'xdg-open'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_path</span><span class="p">.</span><span class="n">parent</span><span class="p">)])</span>
                        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to show in file manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Regular file
</span>                    <span class="n">response</span> <span class="o">=</span> <span class="n">messagebox</span><span class="p">.</span><span class="n">askyesnocancel</span><span class="p">(</span>
                        <span class="s">"File Received"</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s">"Received file: </span><span class="si">{</span><span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n\n</span><span class="s">"</span>
                        <span class="sa">f</span><span class="s">"Location: </span><span class="si">{</span><span class="n">save_location_type</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
                        <span class="sa">f</span><span class="s">"From: </span><span class="si">{</span><span class="n">source_ip</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
                        <span class="sa">f</span><span class="s">"Size: </span><span class="si">{</span><span class="n">FileTransferManager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">]))</span><span class="si">}</span><span class="se">\n\n</span><span class="s">"</span>
                        <span class="s">"Open the file?"</span><span class="p">,</span>
                        <span class="n">detail</span><span class="o">=</span><span class="s">"Yes: Open file</span><span class="se">\n</span><span class="s">No: Show in Finder</span><span class="se">\n</span><span class="s">Cancel: Do nothing"</span>
                    <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>  <span class="c1"># Yes - Open file
</span>                        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">final_path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to open file: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>  <span class="c1"># No - Show in Finder
</span>                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Darwin"</span><span class="p">:</span>
                                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'open'</span><span class="p">,</span> <span class="s">'-R'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_path</span><span class="p">)])</span>
                            <span class="k">elif</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span><span class="p">:</span>
                                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'explorer'</span><span class="p">,</span> <span class="s">'/select,'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_path</span><span class="p">)])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'xdg-open'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_path</span><span class="p">.</span><span class="n">parent</span><span class="p">)])</span>
                        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to show in file manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Ask user in main thread
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">ask_user_action</span><span class="p">)</span>
            
            <span class="c1"># Log success
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅ Successfully saved to: </span><span class="si">{</span><span class="n">final_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="c1"># Store the parent directory for future "Open Received" clicks
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">primary_received_dir</span> <span class="o">=</span> <span class="n">final_path</span><span class="p">.</span><span class="n">parent</span>  <span class="c1"># &lt;-- ADD THIS LINE
</span>            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Critical error saving file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">traceback</span><span class="p">.</span><span class="n">print_exc</span><span class="p">()</span>
            
            <span class="c1"># Last resort: save to desktop with timestamp
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">emergency_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"Desktop"</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"CLIPBOARD_EMERGENCY_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">.dat"</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">emergency_path</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"🚨 Emergency save to Desktop: </span><span class="si">{</span><span class="n">emergency_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">final_e</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"💥 All save attempts failed: </span><span class="si">{</span><span class="n">final_e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ask_for_save_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Ask user for save location (called from main thread)"""</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">filedialog</span><span class="p">.</span><span class="n">askdirectory</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">"Select folder to save received files"</span><span class="p">,</span>
            <span class="n">initialdir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_user_save_location</span> <span class="o">=</span> <span class="n">save_path</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📁 User selected save location: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_user_save_location</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_get_user_save_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Get the user-selected save location"""</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">'_user_save_location'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">__save_received_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="s">"""Save received file or folder"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create received directory
</span>            <span class="n">received_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"ClipboardReceived"</span>
            <span class="n">received_dir</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="n">filename</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'filename'</span><span class="p">,</span> <span class="sa">f</span><span class="s">'received_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
            <span class="n">is_folder</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'is_folder'</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">transfer_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'transfer_type'</span><span class="p">,</span> <span class="s">'single'</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">is_folder</span><span class="p">:</span>
                <span class="c1"># It's a folder (ZIP file)
</span>                <span class="n">original_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'original_folder_name'</span><span class="p">,</span> <span class="n">filename</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'.zip'</span><span class="p">,</span> <span class="s">''</span><span class="p">))</span>
                
                <span class="c1"># Save ZIP file
</span>                <span class="n">zip_path</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="n">filename</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
                
                <span class="c1"># Extract ZIP
</span>                <span class="n">extract_path</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="n">original_name</span>
                <span class="n">extract_path</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                
                <span class="k">with</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                    <span class="n">zipf</span><span class="p">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_path</span><span class="p">)</span>
                
                <span class="c1"># Clean up ZIP
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="n">final_path</span> <span class="o">=</span> <span class="n">extract_path</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📁 Folder received: </span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Regular file
</span>                <span class="n">filepath</span> <span class="o">=</span> <span class="n">received_dir</span> <span class="o">/</span> <span class="n">filename</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
                
                <span class="n">final_path</span> <span class="o">=</span> <span class="n">filepath</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📄 File received: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Add to recent transfers list
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">received_files</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">'path'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_path</span><span class="p">),</span>
                <span class="s">'name'</span><span class="p">:</span> <span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">'is_folder'</span><span class="p">:</span> <span class="n">is_folder</span><span class="p">,</span>
                <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="s">'size'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
            <span class="p">})</span>
            
            <span class="c1"># Update files list
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">_update_transfers_list</span><span class="p">()</span>
            
            <span class="n">source_ip</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'source_ip'</span><span class="p">,</span> <span class="s">'Unknown'</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">notify_var</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">is_folder</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_show_notification</span><span class="p">(</span><span class="sa">f</span><span class="s">"Folder received from </span><span class="si">{</span><span class="n">source_ip</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_show_notification</span><span class="p">(</span><span class="sa">f</span><span class="s">"File received from </span><span class="si">{</span><span class="n">source_ip</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Ask to open
</span>            <span class="k">if</span> <span class="n">is_folder</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">messagebox</span><span class="p">.</span><span class="n">askyesno</span><span class="p">(</span><span class="s">"Folder Received"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Received folder: </span><span class="si">{</span><span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n\n</span><span class="s">Open folder?"</span><span class="p">):</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">open_folder</span><span class="p">(</span><span class="n">final_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">messagebox</span><span class="p">.</span><span class="n">askyesno</span><span class="p">(</span><span class="s">"File Received"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Received file: </span><span class="si">{</span><span class="n">final_path</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n\n</span><span class="s">Open file?"</span><span class="p">):</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">final_path</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Error saving file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_send_file_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Send any file to target"""</span>
        <span class="n">target_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">target_port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_ip</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s">"No Target"</span><span class="p">,</span> <span class="s">"Please enter target IP address"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_port</span><span class="p">:</span>
            <span class="n">target_port</span> <span class="o">=</span> <span class="s">"6000"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        
        <span class="c1"># Validate IP and port
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">validate_ip_address</span><span class="p">(</span><span class="n">target_ip</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid IP"</span><span class="p">,</span> <span class="s">"Please enter a valid IP address"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">is_valid_port</span><span class="p">(</span><span class="n">target_port</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid Port"</span><span class="p">,</span> <span class="s">"Please enter a valid port number"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">target_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        
        <span class="n">filepaths</span> <span class="o">=</span> <span class="n">filedialog</span><span class="p">.</span><span class="n">askopenfilenames</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">"Select files to send"</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s">"All files"</span><span class="p">,</span> <span class="s">"*.*"</span><span class="p">),</span>
                <span class="p">(</span><span class="s">"Videos"</span><span class="p">,</span> <span class="s">"*.mp4 *.avi *.mov *.mkv *.wmv *.flv *.webm"</span><span class="p">),</span>
                <span class="p">(</span><span class="s">"Images"</span><span class="p">,</span> <span class="s">"*.png *.jpg *.jpeg *.gif *.bmp *.tiff *.webp"</span><span class="p">),</span>
                <span class="p">(</span><span class="s">"Documents"</span><span class="p">,</span> <span class="s">"*.pdf *.doc *.docx *.txt *.rtf *.odt"</span><span class="p">),</span>
                <span class="p">(</span><span class="s">"Audio"</span><span class="p">,</span> <span class="s">"*.mp3 *.wav *.flac *.aac *.ogg *.m4a"</span><span class="p">),</span>
                <span class="p">(</span><span class="s">"Archives"</span><span class="p">,</span> <span class="s">"*.zip *.rar *.7z *.tar *.gz"</span><span class="p">),</span>
                <span class="p">(</span><span class="s">"Code"</span><span class="p">,</span> <span class="s">"*.py *.js *.html *.css *.java *.cpp *.c *.php"</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepaths</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">_send_files</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">filepaths</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_send_folder_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Send folder to target"""</span>
        <span class="n">target_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">target_port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_ip</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s">"No Target"</span><span class="p">,</span> <span class="s">"Please enter target IP address"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_port</span><span class="p">:</span>
            <span class="n">target_port</span> <span class="o">=</span> <span class="s">"6000"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        
        <span class="c1"># Validate IP and port
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">validate_ip_address</span><span class="p">(</span><span class="n">target_ip</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid IP"</span><span class="p">,</span> <span class="s">"Please enter a valid IP address"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">is_valid_port</span><span class="p">(</span><span class="n">target_port</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid Port"</span><span class="p">,</span> <span class="s">"Please enter a valid port number"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">target_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        
        <span class="n">folder_path</span> <span class="o">=</span> <span class="n">filedialog</span><span class="p">.</span><span class="n">askdirectory</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">"Select folder to send"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_path</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Get folder info
</span>        <span class="n">folder_info</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Error"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Invalid folder: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Confirm transfer
</span>        <span class="n">file_count</span> <span class="o">=</span> <span class="n">folder_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'file_count'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="n">folder_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'total_size'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">confirm</span> <span class="o">=</span> <span class="n">messagebox</span><span class="p">.</span><span class="n">askyesno</span><span class="p">(</span>
            <span class="s">"Confirm Folder Transfer"</span><span class="p">,</span>
            <span class="sa">f</span><span class="s">"Folder: </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">).</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
            <span class="sa">f</span><span class="s">"Files: </span><span class="si">{</span><span class="n">file_count</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
            <span class="sa">f</span><span class="s">"Total size: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s">"</span>
            <span class="sa">f</span><span class="s">"Send to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">?"</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">confirm</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_send_folder</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_send_video_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Send video files"""</span>
        <span class="n">target_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_ip_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">target_port</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_ip</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s">"No Target"</span><span class="p">,</span> <span class="s">"Please enter target IP address"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_port</span><span class="p">:</span>
            <span class="n">target_port</span> <span class="o">=</span> <span class="s">"6000"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">target_port_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        
        <span class="c1"># Validate IP and port
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">validate_ip_address</span><span class="p">(</span><span class="n">target_ip</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid IP"</span><span class="p">,</span> <span class="s">"Please enter a valid IP address"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NetworkUtils</span><span class="p">.</span><span class="n">is_valid_port</span><span class="p">(</span><span class="n">target_port</span><span class="p">):</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Invalid Port"</span><span class="p">,</span> <span class="s">"Please enter a valid port number"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">target_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_port</span><span class="p">)</span>
        <span class="c1"># Save to cache
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_save_cached_ip</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">)</span>
        
        <span class="n">filepaths</span> <span class="o">=</span> <span class="n">filedialog</span><span class="p">.</span><span class="n">askopenfilenames</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">"Select video files to send"</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s">"Video files"</span><span class="p">,</span> <span class="s">"*.mp4 *.avi *.mov *.mkv *.wmv *.flv *.webm *.m4v *.mpg *.mpeg"</span><span class="p">),</span>
                <span class="p">(</span><span class="s">"All files"</span><span class="p">,</span> <span class="s">"*.*"</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepaths</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">_send_files</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">filepaths</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_send_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">filepaths</span><span class="p">):</span>
        <span class="s">"""Send multiple files"""</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">:</span>
            <span class="n">file_info</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Error with </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">).</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="c1"># Show progress dialog for large files
</span>            <span class="k">if</span> <span class="n">file_info</span><span class="p">[</span><span class="s">'size'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># &gt; 10MB
</span>                <span class="n">transfer_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"send_</span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">"</span>
                
                <span class="c1"># Create circular progress dialog
</span>                <span class="n">dialog</span> <span class="o">=</span> <span class="n">CircularProgressDialog</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
                    <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">).</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">file_info</span><span class="p">[</span><span class="s">'size'</span><span class="p">],</span>
                    <span class="s">'send'</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span>
                <span class="p">)</span>
                
                <span class="c1"># Store dialog reference
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">progress_dialogs</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dialog</span>
                
                <span class="c1"># Start transfer in background thread
</span>                <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_send_file_with_progress</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">dialog</span><span class="p">),</span>
                    <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span>
                <span class="p">).</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Small file, send without progress dialog
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📤 Sending </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">).</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="s">'size'</span><span class="p">])</span><span class="si">}</span><span class="s">) to </span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">..."</span><span class="p">)</span>
                
                <span class="n">success</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">send_file</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅ Sent: </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">).</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to send </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">).</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_send_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">):</span>
        <span class="s">"""Send folder as ZIP"""</span>
        <span class="c1"># Get folder info
</span>        <span class="n">folder_info</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Error"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Invalid folder: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Create progress dialog
</span>        <span class="n">transfer_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"send_folder_</span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">"</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">CircularProgressDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">).</span><span class="n">name</span><span class="p">,</span>
            <span class="n">folder_info</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'total_size'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s">'send'</span><span class="p">,</span>
            <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">target_ip</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">target_port</span><span class="si">}</span><span class="s">"</span>
        <span class="p">)</span>
        
        <span class="c1"># Store dialog reference
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">progress_dialogs</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dialog</span>
        
        <span class="c1"># Start transfer in background thread
</span>        <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_send_folder_with_progress</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">dialog</span><span class="p">),</span>
            <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">).</span><span class="n">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_send_file_with_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">is_folder</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">dialog</span><span class="p">):</span>
        <span class="s">"""Send file with circular progress dialog"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">send_file</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">is_folder</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">)</span>
            
            <span class="c1"># Update dialog on completion
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">dialog</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅ Sent: </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">).</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to send </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">).</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">dialog</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Error sending </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">).</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Remove dialog reference after a delay
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_remove_dialog</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_send_folder_with_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">dialog</span><span class="p">):</span>
        <span class="s">"""Send folder with circular progress dialog"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">send_folder_as_zip</span><span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">target_port</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">)</span>
            
            <span class="c1"># Update dialog on completion
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">dialog</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅ Folder sent: </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">).</span><span class="n">name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to send folder: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">dialog</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Error sending folder: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Remove dialog reference after a delay
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_remove_dialog</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_remove_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">):</span>
        <span class="s">"""Remove progress dialog reference"""</span>
        <span class="k">if</span> <span class="n">transfer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">progress_dialogs</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">.</span><span class="n">progress_dialogs</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_toggle_auto_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Toggle auto-sync"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">auto_sync_var</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"Auto-sync enabled"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"Auto-sync disabled"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_show_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="s">"""Show notification"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">notify_var</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📢 </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__open_received_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Open received files folder"""</span>
        <span class="n">received_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"ClipboardReceived"</span>
        <span class="n">received_dir</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">open_folder</span><span class="p">(</span><span class="n">received_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to open folder: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_open_received_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Open the folder where files are actually being saved"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 1. Try to use the directory from the most recent save
</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">'primary_received_dir'</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">primary_received_dir</span><span class="p">:</span>
                <span class="n">received_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">primary_received_dir</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📂 Opening from recent save location: </span><span class="si">{</span><span class="n">received_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># 2. Fallback: check received_files list for last saved file
</span>            <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">received_files</span><span class="p">:</span>
                <span class="n">last_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">received_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'path'</span><span class="p">])</span>
                <span class="n">received_dir</span> <span class="o">=</span> <span class="n">last_file_path</span><span class="p">.</span><span class="n">parent</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📂 Opening from last received file: </span><span class="si">{</span><span class="n">received_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="c1"># Update primary for next time
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">primary_received_dir</span> <span class="o">=</span> <span class="n">received_dir</span>
            
            <span class="c1"># 3. Ultimate fallback: default location
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="n">received_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"ClipboardReceived"</span>
                <span class="n">received_dir</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📂 Opening default folder (no files received yet): </span><span class="si">{</span><span class="n">received_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">primary_received_dir</span> <span class="o">=</span> <span class="n">received_dir</span>
            
            <span class="c1"># Ensure the directory exists
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">received_dir</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">received_dir</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"📁 Created missing directory: </span><span class="si">{</span><span class="n">received_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Open it
</span>            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">open_folder</span><span class="p">(</span><span class="n">received_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Failed to open folder </span><span class="si">{</span><span class="n">received_dir</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Error in _open_received_folder: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="c1"># Emergency fallback
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">fallback</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"ClipboardReceived"</span>
                <span class="n">fallback</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">open_folder</span><span class="p">(</span><span class="n">fallback</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Nothing more we can do
</span>    
    <span class="k">def</span> <span class="nf">_update_clipboard_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="s">"""Update clipboard display"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_update_clipboard_display_threadsafe</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_update_clipboard_display_threadsafe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="s">"""Thread-safe UI update"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'normal'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_text</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tk</span><span class="p">.</span><span class="n">END</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_text</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># No truncation
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'disabled'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_update_transfers_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Update active transfers list"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_update_transfers_list_threadsafe</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_update_transfers_list_threadsafe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Thread-safe transfers list update"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transfers_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'normal'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transfers_text</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tk</span><span class="p">.</span><span class="n">END</span><span class="p">)</span>
        
        <span class="c1"># Get active transfers from progress manager
</span>        <span class="n">active_transfers</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">progress_manager</span><span class="p">.</span><span class="n">get_active_transfers</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active_transfers</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">transfers_text</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">"No active transfers"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">transfer</span> <span class="ow">in</span> <span class="n">active_transfers</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'filename'</span><span class="p">]</span>
                <span class="n">current_size</span> <span class="o">=</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'current_size'</span><span class="p">]</span>
                <span class="n">total_size</span> <span class="o">=</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'total_size'</span><span class="p">]</span>
                <span class="n">transfer_type</span> <span class="o">=</span> <span class="s">"Sending"</span> <span class="k">if</span> <span class="n">transfer</span><span class="p">[</span><span class="s">'transfer_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'send'</span> <span class="k">else</span> <span class="s">"Receiving"</span>
                
                <span class="c1"># Show size instead of percentage
</span>                <span class="n">current_str</span> <span class="o">=</span> <span class="n">FileTransferManager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">current_size</span><span class="p">)</span>
                <span class="n">total_str</span> <span class="o">=</span> <span class="n">FileTransferManager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span>
                
                <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">transfer_type</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">current_str</span><span class="si">}</span><span class="s"> / </span><span class="si">{</span><span class="n">total_str</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">transfers_text</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="p">.</span><span class="n">END</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">transfers_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'disabled'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="s">"""Add message to log"""</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%H:%M:%S"</span><span class="p">)</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_log_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="s">"""Callback for logging from threads"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_progress_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="s">"""Handle progress updates from transfers"""</span>
        <span class="c1"># Put in queue for thread-safe GUI update
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">progress_queue</span><span class="p">.</span><span class="n">put</span><span class="p">((</span><span class="n">event_type</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_update_gui_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Update GUI periodically"""</span>
        <span class="c1"># Process log queue
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">log_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">log_queue</span><span class="p">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'normal'</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="p">.</span><span class="n">END</span><span class="p">,</span> <span class="n">log_entry</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">see</span><span class="p">(</span><span class="n">tk</span><span class="p">.</span><span class="n">END</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'disabled'</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="s">'end-1c'</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="s">'500'</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">'2.0'</span><span class="p">)</span>
                    
        <span class="k">except</span> <span class="n">queue</span><span class="p">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c1"># Process progress queue
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">event_type</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">progress_queue</span><span class="p">.</span><span class="n">get_nowait</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s">'transfer_started'</span><span class="p">:</span>
                    <span class="n">transfer_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'transfer_id'</span><span class="p">]</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                    
                    <span class="c1"># Update status bar
</span>                    <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="s">'Sending'</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">'transfer_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'send'</span> <span class="k">else</span> <span class="s">'Receiving'</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s">'filename'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    
                <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s">'progress_updated'</span><span class="p">:</span>
                    <span class="n">transfer_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'transfer_id'</span><span class="p">]</span>
                    
                    <span class="c1"># Update active transfer
</span>                    <span class="k">if</span> <span class="n">transfer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">].</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    
                    <span class="c1"># Update progress dialog if exists
</span>                    <span class="k">if</span> <span class="n">transfer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">progress_dialogs</span><span class="p">:</span>
                        <span class="n">dialog</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">progress_dialogs</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dialog</span><span class="p">.</span><span class="n">is_cancelled</span><span class="p">():</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">dialog</span><span class="p">.</span><span class="n">update_progress</span><span class="p">(</span>
                                <span class="n">data</span><span class="p">[</span><span class="s">'percentage'</span><span class="p">],</span>
                                <span class="n">data</span><span class="p">[</span><span class="s">'current_size'</span><span class="p">],</span>
                                <span class="n">data</span><span class="p">[</span><span class="s">'total_size'</span><span class="p">]</span>
                            <span class="p">))</span>
                    
                <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s">'transfer_completed'</span><span class="p">:</span>
                    <span class="n">transfer_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'transfer_id'</span><span class="p">]</span>
                    
                    <span class="c1"># Remove from active transfers
</span>                    <span class="k">if</span> <span class="n">transfer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="p">.</span><span class="n">active_transfers</span><span class="p">[</span><span class="n">transfer_id</span><span class="p">]</span>
                    
                    <span class="c1"># Update status bar
</span>                    <span class="bp">self</span><span class="p">.</span><span class="n">status_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">"Ready"</span><span class="p">)</span>
                    
                    <span class="c1"># Log completion
</span>                    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">'success'</span><span class="p">]:</span>
                        <span class="n">time_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s">'total_time'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">s"</span>
                        <span class="n">size_str</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transfer_manager</span><span class="p">.</span><span class="n">format_size</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'total_size'</span><span class="p">])</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"✅ Transfer completed: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s">'filename'</span><span class="p">]</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">size_str</span><span class="si">}</span><span class="s">) in </span><span class="si">{</span><span class="n">time_str</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"❌ Transfer failed: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s">'filename'</span><span class="p">]</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s">'error_msg'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="c1"># Update transfers list
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">_update_transfers_list</span><span class="p">()</span>
                    
        <span class="k">except</span> <span class="n">queue</span><span class="p">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c1"># Schedule next update
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_update_gui_loop</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_clear_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Clear log"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'normal'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tk</span><span class="p">.</span><span class="n">END</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">'disabled'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_copy_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Copy log to clipboard"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_content</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">log_text</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tk</span><span class="p">.</span><span class="n">END</span><span class="p">)</span>
            <span class="n">pyperclip</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">log_content</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"Log copied to clipboard"</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    
    <span class="c1"># ====== CRITICAL FIX: Enhanced on_closing method ======
</span>    <span class="k">def</span> <span class="nf">on_closing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Handle application closing - FIXED for proper termination"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"[SHUTDOWN] Application shutdown initiated..."</span><span class="p">)</span>
            
            <span class="c1"># Ask for confirmation
</span>            <span class="k">if</span> <span class="n">messagebox</span><span class="p">.</span><span class="n">askokcancel</span><span class="p">(</span><span class="s">"Quit"</span><span class="p">,</span> <span class="s">"Do you want to quit?"</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"[SHUTDOWN] Shutting down services..."</span><span class="p">)</span>
                
                <span class="c1"># Stop all services
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_monitor</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
                
                <span class="c1"># Call stop methods
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                    
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">clipboard_monitor</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="c1"># Wait a moment for threads to stop
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_force_shutdown</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s">"[SHUTDOWN] Error during shutdown: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="c1"># Force shutdown anyway
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">_force_shutdown</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_force_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Force shutdown of the application"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Destroy all windows
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">destroy</span><span class="p">()</span>
            
            <span class="c1"># Force exit - this is CRITICAL for PyInstaller
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">_log</span><span class="p">(</span><span class="s">"[SHUTDOWN] Forcing application exit..."</span><span class="p">)</span>
            
            <span class="c1"># Kill the process
</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">'_exit'</span><span class="p">):</span>
                <span class="n">os</span><span class="p">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Immediate termination, bypassing Python cleanup
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Fallback
</span>                
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Ultimate fallback
</span>            <span class="kn">import</span> <span class="nn">ctypes</span>
            <span class="n">ctypes</span><span class="p">.</span><span class="n">windll</span><span class="p">.</span><span class="n">user32</span><span class="p">.</span><span class="n">PostQuitMessage</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="n">os</span><span class="p">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># ------------------ Resource Path Helper ------------------
</span><span class="k">def</span> <span class="nf">get_resource_path</span><span class="p">(</span><span class="n">relative_path</span><span class="p">):</span>
    <span class="s">"""Get the correct path for resources whether running as script or PyInstaller executable"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># PyInstaller creates a temp folder and stores path in _MEIPASS
</span>        <span class="n">base_path</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">_MEIPASS</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="c1"># Running as normal Python script
</span>        <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">"."</span><span class="p">)</span>
    
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
    
    <span class="c1"># Check if file exists, if not try other common locations
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># Try parent directory
</span>        <span class="n">alt_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">alt_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">alt_path</span>
        
        <span class="c1"># Try current working directory
</span>        <span class="n">alt_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">alt_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">alt_path</span>
        
        <span class="c1"># Try the actual executable directory (for PyInstaller)
</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'frozen'</span><span class="p">):</span>
            <span class="n">exe_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">)</span>
            <span class="n">alt_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">exe_dir</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">alt_path</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">alt_path</span>
    
    <span class="k">return</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">load_application_icon</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="s">"""Simple wrapper for backward compatibility"""</span>
    <span class="k">return</span> <span class="n">setup_application_icon</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_load_application_icon</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="s">"""Load application icon with multiple fallbacks, including PyInstaller bundle"""</span>
    <span class="c1"># First, try the icon that PyInstaller might have embedded
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'_MEIPASS'</span><span class="p">):</span>
            <span class="c1"># Running as PyInstaller bundle
</span>            <span class="n">bundle_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">_MEIPASS</span><span class="p">)</span>
            <span class="n">icon_path</span> <span class="o">=</span> <span class="n">bundle_dir</span> <span class="o">/</span> <span class="s">"icon_clean.png"</span>
            <span class="k">if</span> <span class="n">icon_path</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">icon</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">icon_path</span><span class="p">))</span>
                <span class="n">root</span><span class="p">.</span><span class="n">iconphoto</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">icon</span><span class="p">)</span>
                <span class="n">root</span><span class="p">.</span><span class="n">_icon</span> <span class="o">=</span> <span class="n">icon</span>  <span class="c1"># Keep reference
</span>                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Icon loaded from bundle: </span><span class="si">{</span><span class="n">icon_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to load icon from bundle: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="c1"># Try multiple icon formats and locations
</span>    <span class="n">icon_formats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"icon_clean.png"</span><span class="p">,</span>
        <span class="s">"icon.png"</span><span class="p">,</span>
        <span class="s">"logo.png"</span><span class="p">,</span>
        <span class="s">"app.ico"</span><span class="p">,</span>
        <span class="s">"logo.ico"</span><span class="p">,</span>
        <span class="s">"icon.ico"</span><span class="p">,</span>
    <span class="p">]</span>
    
    <span class="c1"># Check multiple possible locations
</span>    <span class="n">search_paths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Path</span><span class="p">.</span><span class="n">cwd</span><span class="p">(),</span>  <span class="c1"># Current working directory
</span>        <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">).</span><span class="n">parent</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'frozen'</span><span class="p">)</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="n">__file__</span><span class="p">).</span><span class="n">parent</span><span class="p">,</span>  <span class="c1"># Executable directory
</span>        <span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"Downloads"</span><span class="p">,</span>
        <span class="n">Path</span><span class="p">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s">"Desktop"</span><span class="p">,</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">icon_file</span> <span class="ow">in</span> <span class="n">icon_formats</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">search_path</span> <span class="ow">in</span> <span class="n">search_paths</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">icon_path</span> <span class="o">=</span> <span class="n">search_path</span> <span class="o">/</span> <span class="n">icon_file</span>
                <span class="k">if</span> <span class="n">icon_path</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Trying icon: </span><span class="si">{</span><span class="n">icon_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">icon_file</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.ico'</span><span class="p">):</span>
                        <span class="c1"># For Windows .ico files
</span>                        <span class="k">if</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span><span class="p">:</span>
                            <span class="n">root</span><span class="p">.</span><span class="n">iconbitmap</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">icon_path</span><span class="p">))</span>
                            <span class="k">return</span> <span class="bp">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># On non-Windows, try to load as image
</span>                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageTk</span><span class="p">,</span> <span class="n">Image</span>
                                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">icon_path</span><span class="p">)</span>
                                <span class="n">photo</span> <span class="o">=</span> <span class="n">ImageTk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                                <span class="n">root</span><span class="p">.</span><span class="n">iconphoto</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">photo</span><span class="p">)</span>
                                <span class="n">root</span><span class="p">.</span><span class="n">_icon</span> <span class="o">=</span> <span class="n">photo</span>
                                <span class="k">return</span> <span class="bp">True</span>
                            <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
                                <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># For PNG/GIF files
</span>                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">icon</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">icon_path</span><span class="p">))</span>
                            <span class="n">root</span><span class="p">.</span><span class="n">iconphoto</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">icon</span><span class="p">)</span>
                            <span class="n">root</span><span class="p">.</span><span class="n">_icon</span> <span class="o">=</span> <span class="n">icon</span>
                            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Icon loaded successfully: </span><span class="si">{</span><span class="n">icon_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                            <span class="k">return</span> <span class="bp">True</span>
                        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to load </span><span class="si">{</span><span class="n">icon_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                            <span class="k">continue</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error checking </span><span class="si">{</span><span class="n">icon_file</span><span class="si">}</span><span class="s"> in </span><span class="si">{</span><span class="n">search_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">continue</span>
    
    <span class="k">print</span><span class="p">(</span><span class="s">"No icon found, using default Tkinter icon"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_load_application_icon</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="s">"""Load application icon with multiple fallbacks"""</span>
    <span class="n">icon_formats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"icon_clean.png"</span><span class="p">,</span>
        <span class="s">"icon.png"</span><span class="p">,</span>
        <span class="s">"logo.png"</span><span class="p">,</span>
        <span class="s">"app.ico"</span><span class="p">,</span>
        <span class="s">"logo.ico"</span><span class="p">,</span>
        <span class="s">"icon.ico"</span><span class="p">,</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">icon_file</span> <span class="ow">in</span> <span class="n">icon_formats</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">icon_path</span> <span class="o">=</span> <span class="n">get_resource_path</span><span class="p">(</span><span class="n">icon_file</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">icon_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">icon_file</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.ico'</span><span class="p">):</span>
                    <span class="c1"># For Windows .ico files
</span>                    <span class="k">if</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span><span class="p">:</span>
                        <span class="n">root</span><span class="p">.</span><span class="n">iconbitmap</span><span class="p">(</span><span class="n">icon_path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># On non-Windows, try to load as image
</span>                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageTk</span><span class="p">,</span> <span class="n">Image</span>
                            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">icon_path</span><span class="p">)</span>
                            <span class="n">photo</span> <span class="o">=</span> <span class="n">ImageTk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                            <span class="n">root</span><span class="p">.</span><span class="n">iconphoto</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">photo</span><span class="p">)</span>
                            <span class="c1"># Keep reference to prevent garbage collection
</span>                            <span class="n">root</span><span class="p">.</span><span class="n">_icon</span> <span class="o">=</span> <span class="n">photo</span>
                            <span class="k">return</span> <span class="bp">True</span>
                        <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For PNG/GIF files
</span>                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">icon</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">icon_path</span><span class="p">)</span>
                        <span class="n">root</span><span class="p">.</span><span class="n">iconphoto</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">icon</span><span class="p">)</span>
                        <span class="c1"># Keep reference to prevent garbage collection
</span>                        <span class="n">root</span><span class="p">.</span><span class="n">_icon</span> <span class="o">=</span> <span class="n">icon</span>
                        <span class="k">return</span> <span class="bp">True</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
    
    <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># ------------------ Installation ------------------
</span><span class="k">def</span> <span class="nf">install_dependencies</span><span class="p">():</span>
    <span class="s">"""Install required dependencies"""</span>
    <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s">'pyperclip'</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Darwin"</span><span class="p">:</span>
        <span class="n">required</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'pyclip'</span><span class="p">)</span>  <span class="c1"># Better for macOS
</span>        <span class="n">required</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'netifaces'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span><span class="p">:</span>
        <span class="c1"># required.append('pywin32')
</span>        <span class="n">required</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'netifaces'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Linux
</span>        <span class="n">required</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'xclip'</span><span class="p">)</span>  <span class="c1"># For Linux clipboard
</span>        <span class="n">required</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'netifaces'</span><span class="p">)</span>
    
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s">'xclip'</span><span class="p">:</span>
                <span class="c1"># Check if xclip command exists on Linux
</span>                <span class="k">if</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Linux"</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">([</span><span class="s">'which'</span><span class="p">,</span> <span class="s">'xclip'</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">missing</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'xclip (system package)'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'-'</span><span class="p">,</span> <span class="s">'_'</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
            <span class="n">missing</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Installing missing dependencies..."</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">subprocess</span>
            <span class="n">pip_install</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span> <span class="k">if</span> <span class="s">'(system package)'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pip_install</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="p">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">'-m'</span><span class="p">,</span> <span class="s">'pip'</span><span class="p">,</span> <span class="s">'install'</span><span class="p">]</span> <span class="o">+</span> <span class="n">pip_install</span><span class="p">)</span>
            
            <span class="c1"># Print system package instructions
</span>            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">'(system package)'</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">For </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s">, install system package:"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Linux"</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  sudo apt-get install </span><span class="si">{</span><span class="n">m</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error installing dependencies: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Please install manually:"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"  pip install"</span><span class="p">,</span> <span class="s">" "</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span> <span class="k">if</span> <span class="s">'(system package)'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">check_firewall</span><span class="p">():</span>
    <span class="s">"""Check firewall settings"""</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"FIREWALL CONFIGURATION"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Windows"</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"1. Allow Python through Windows Defender Firewall"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"2. Allow port 6000 (TCP)"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"3. Run as Administrator if needed"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Darwin"</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"1. System Settings &gt; Privacy &amp; Security &gt; Firewall"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"2. Click 'Firewall Options'"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"3. Allow Python/terminal"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Clipboard Access:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"4. System Settings &gt; Privacy &amp; Security &gt; Privacy"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"5. Select 'Automation' or 'Accessibility'"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"6. Add Terminal/iTerm and grant clipboard access"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"If using ufw:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"  sudo ufw allow 6000/tcp"</span><span class="p">)</span>
    
    <span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># ------------------ Main ------------------
</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="s">"""Main entry point"""</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"PyShine Clipboard Pro - v1.0"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Features:"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"• DIRECT CONNECTION BETWEEN TWO PCs"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"• Enter target IP and port (default: 6000)"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"• Auto-sync clipboard text"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"• Send ANY file type (videos, images, documents, etc.)"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"• Send complete folders with structure"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"• Circular progress indicators"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"• Cross-platform (Windows, macOS, Linux)"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">HOW TO USE:"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"1. Enter target IP address"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"2. Enter target port (default: 6000)"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"3. Click 'Connection' to verify"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"4. Use 'Send File/Folder' to transfer files"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"5. Enable 'Auto-sync' for automatic clipboard sharing"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="c1"># Install dependencies
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">install_dependencies</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Warning: Could not install all dependencies: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="c1"># Check firewall
</span>    <span class="n">check_firewall</span><span class="p">()</span>
    
    <span class="c1"># Initialize mimetypes
</span>    <span class="n">mimetypes</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
    
    <span class="c1"># Create and run application
</span>    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Tk</span><span class="p">()</span>
    
    <span class="c1"># Load icon dynamically
</span>    <span class="n">load_application_icon</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">PyShineClipboardApp</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    
    <span class="c1"># Center window
</span>    <span class="n">root</span><span class="p">.</span><span class="n">update_idletasks</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="n">winfo_width</span><span class="p">()</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="n">winfo_height</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">winfo_screenwidth</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">winfo_screenheight</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">root</span><span class="p">.</span><span class="n">geometry</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s">x</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s">+</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s">+</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    
    <span class="c1"># Start main loop
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">root</span><span class="p">.</span><span class="n">mainloop</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Shutting down..."</span><span class="p">)</span>
        <span class="c1"># Force exit on Ctrl+C
</span>        <span class="n">os</span><span class="p">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</code></pre></div></div>

<h2 id="privacy-first">Privacy First</h2>

<ul>
  <li>No cloud servers</li>
  <li>No accounts</li>
  <li>No telemetry</li>
  <li>Your data stays on your network</li>
</ul>

<hr />

<h2 id="support--updates">Support &amp; Updates</h2>

<ul>
  <li>Website: https://www.pyshine.com</li>
</ul>

<hr />

<p>Made with ❤️ by <strong>PyShine</strong></p>]]></content><author><name>PyShine Team</name></author><summary type="html"><![CDATA[A free App that lets you connect two computers and copy paste text and transfer files over the network]]></summary></entry><entry><title type="html">Visualizing Pascal’s Law with Python and Pygame</title><link href="http://localhost:4000/Pascals-Law-Simulation-in-Python/" rel="alternate" type="text/html" title="Visualizing Pascal’s Law with Python and Pygame" /><published>2026-01-10T00:00:00+08:00</published><updated>2026-01-10T00:00:00+08:00</updated><id>http://localhost:4000/Pascals-Law-Simulation-in-Python</id><content type="html" xml:base="http://localhost:4000/Pascals-Law-Simulation-in-Python/"><![CDATA[<h1 id="visualizing-pascals-law-with-python-and-pygame">Visualizing Pascal’s Law with Python and Pygame</h1>

<p>This project demonstrates <strong>Pascal’s Law</strong>, a fundamental principle of fluid mechanics, using an interactive <strong>Pygame simulation</strong>. By dragging pistons and adjusting areas, users can visually and numerically understand how pressure and force behave in a confined fluid.</p>

<div class="video-container">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/1LPkqUvLulU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
  </iframe>
</div>

<hr />

<h2 id="what-is-pascals-law">What Is Pascal’s Law?</h2>

<p><strong>Pascal’s Law</strong> states:</p>

<blockquote>
  <p><em>Pressure applied to a confined fluid is transmitted equally in all directions throughout the fluid.</em></p>
</blockquote>

<p>Mathematically:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P = F / A
</code></pre></div></div>

<p>Where:</p>
<ul>
  <li><strong>P</strong> = Pressure (Pascals, Pa)</li>
  <li><strong>F</strong> = Force (Newtons, N)</li>
  <li><strong>A</strong> = Area (square meters, m²)</li>
</ul>

<p>This principle is the reason <strong>hydraulic presses, car brakes, lifts, and excavators</strong> can multiply force.</p>

<hr />

<h2 id="what-this-simulation-shows">What This Simulation Shows</h2>

<p>This program visually simulates a <strong>hydraulic system</strong> with:</p>

<ul>
  <li>A <strong>small input piston</strong> (left)</li>
  <li>A <strong>large output piston</strong> (right)</li>
  <li>A <strong>U-shaped fluid pipe</strong> connecting them</li>
</ul>

<h3 id="key-features">Key Features</h3>

<ul>
  <li>Real-time fluid visualization</li>
  <li>Mouse-controlled piston movement</li>
  <li>Adjustable output piston area</li>
  <li>Automatic force multiplication</li>
  <li>Live display of SI units (N, m², Pa)</li>
</ul>

<hr />

<h2 id="technologies-used">Technologies Used</h2>

<ul>
  <li><strong>Python 3</strong></li>
  <li><strong>Pygame</strong> (graphics + interaction)</li>
  <li><strong>Physics equations</strong> (real SI units)</li>
</ul>

<hr />

<h2 id="physics-model-used">Physics Model Used</h2>

<h3 id="pressure-calculation">Pressure Calculation</h3>

<p>Pressure is calculated using fluid depth:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P = ρ g h
</code></pre></div></div>

<p>Where:</p>
<ul>
  <li><strong>ρ</strong> = fluid density (1000 kg/m³ for water)</li>
  <li><strong>g</strong> = gravity (9.81 m/s²)</li>
  <li><strong>h</strong> = depth of piston (meters)</li>
</ul>

<hr />

<h3 id="force-transmission">Force Transmission</h3>

<p>Because pressure is equal everywhere:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>F_in / A_small = F_out / A_big
</code></pre></div></div>

<p>So:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>F_out = F_in × (A_big / A_small)
</code></pre></div></div>

<p>This is why <strong>small force on a small piston creates large force on a large piston</strong>.</p>

<hr />

<h2 id="understanding-the-code-structure">Understanding the Code Structure</h2>

<h3 id="1-window-setup-portrait-mode">1. Window Setup (Portrait Mode)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">650</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">))</span>
</code></pre></div></div>

<p>A tall window helps visualize vertical piston motion.</p>

<hr />

<h3 id="2-si-units-configuration">2. SI Units Configuration</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">A_small</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># m²
</span><span class="n">A_big</span> <span class="o">=</span> <span class="mf">0.08</span>    <span class="c1"># m²
</span><span class="n">fluid_density</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>
</code></pre></div></div>

<p>All calculations are done using <strong>real physics units</strong>.</p>

<hr />

<h3 id="3-area-to-width-scaling">3. Area-to-Width Scaling</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">big_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">A_big</span> <span class="o">/</span> <span class="n">A_small</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
</code></pre></div></div>

<p>Why square root?</p>

<p>Because:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Area ∝ width²
</code></pre></div></div>

<p>So width must scale with √area to remain visually correct.</p>

<hr />

<h3 id="4-constant-fluid-volume-constraint">4. Constant Fluid Volume Constraint</h3>

<p>To simulate incompressible fluid:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">initial_fluid_area</span> <span class="o">=</span> <span class="n">calculate_fluid_area</span><span class="p">(...)</span>
</code></pre></div></div>

<p>When one piston moves down, the other <strong>must rise</strong> to conserve volume.</p>

<hr />

<h3 id="5-mouse-interaction">5. Mouse Interaction</h3>

<ul>
  <li>Drag <strong>left piston</strong> → increases pressure</li>
  <li>Drag <strong>right handle</strong> → changes piston area</li>
</ul>

<p>This lets users <strong>experiment freely</strong>.</p>

<hr />

<h3 id="complete-code">Complete code</h3>
<style>
  .copy-code-button {
	box-shadow:inset 0px 1px 0px 0px #bbdaf7;
	background:linear-gradient(to bottom, #79bbff 5%, #378de5 100%);
	background-color:#79bbff;
	border-radius:6px;
	border:1px solid #84bbf3;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #528ecc;
}
.copy-code-button:hover {
	background:linear-gradient(to bottom, #378de5 5%, #79bbff 100%);
	background-color:#378de5;
}
.copy-code-button:active {
	position:relative;
	top:1px;
}
</style>

<div class="code-header">
  <button class="copy-code-button">
    Copy code to clipboard
  </button>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""This demonstrates Pascal's Law:
that pressure applied to a confined fluid is transmitted 
equally throughout the fluid.

Key Features:
Real-time piston movement and corresponding pressure/force change.
Adjustable output piston area via mouse drag tovisualize force multiplication.
Realistic SI units (Force in N, Area in meter-square., Pressure in Pa).
Dynamic info panel displaying Pascal's law and live values.
visit www.pyshine.com for more details
"""</span>

<span class="kn">import</span> <span class="nn">pygame</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="nn">pygame.draw</span> <span class="kn">import</span> <span class="n">rect</span><span class="p">,</span> <span class="n">lines</span>
<span class="kn">from</span> <span class="nn">pygame</span> <span class="kn">import</span> <span class="n">Rect</span>
<span class="n">pygame</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>

<span class="c1">#Portrait window setup
</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">650</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">))</span>
<span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s">"Hydraulic Pressure"</span><span class="p">)</span>

<span class="n">font</span> <span class="o">=</span> <span class="n">pygame</span><span class="p">.</span><span class="n">font</span><span class="p">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s">"Arial"</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">BLUE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">GRAY</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
<span class="n">DARK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">WHITE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">OUTLINE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">HANDLE_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">ORANGE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># New color for dragging
</span>
<span class="c1">#SI Units Setup
# Areas in m^2, 
# Pressure in Pa (Pascals), 
# Force in N (Newtons)
</span><span class="n">A_small</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># 0.01 m^2 = 100 cm^2(small piston)
</span><span class="n">A_big</span> <span class="o">=</span> <span class="mf">0.08</span>          <span class="c1"># 0.08 m^2 = 800 cm^2 (big piston)
</span><span class="n">fluid_density</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># kg/m³ (water density)
</span><span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>              <span class="c1"># m/s² (gravity)
</span>
<span class="c1">#Geometry
</span><span class="n">left_x</span><span class="p">,</span> <span class="n">right_x</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">350</span>
<span class="n">pipe_top</span><span class="p">,</span> <span class="n">pipe_bottom</span> <span class="o">=</span> <span class="mi">440</span><span class="p">,</span> <span class="mi">450</span>
<span class="n">shaft_len</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">piston_height</span> <span class="o">=</span> <span class="mi">25</span>

<span class="c1"># Calculate widths based on areas to 
# maintain visual equality
</span><span class="n">base_width</span> <span class="o">=</span> <span class="mi">40</span>  <span class="c1"># base width for A_small 
</span><span class="n">piston_width</span> <span class="o">=</span> <span class="n">base_width</span>
<span class="c1"># cylinder is 10px wider than piston
</span><span class="n">cylinder_w</span> <span class="o">=</span> <span class="n">base_width</span> <span class="o">+</span> <span class="mi">10</span>  

<span class="c1"># Calculate big piston width to be 
# visually proportional to area
</span><span class="n">big_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">A_big</span> <span class="o">/</span> <span class="n">A_small</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>  
<span class="n">big_h</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">piston_y</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">dragging</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">area_drag</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">offset_y</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">410</span>

<span class="c1"># Calculate initial total blue fluid area 
# (all three regions)
</span><span class="k">def</span> <span class="nf">calculate_fluid_area</span><span class="p">(</span><span class="n">left_y</span><span class="p">,</span> <span class="n">right_y</span><span class="p">,</span> <span class="n">big_width</span><span class="p">):</span>
    <span class="s">"""Calculate total blue fluid area including
    all three regions"""</span>
    <span class="c1"># 1. Left cylinder blue area 
</span>    <span class="c1"># (from piston to pipe bottom)
</span>    <span class="n">left_area</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">*</span> <span class="p">(</span><span class="n">pipe_bottom</span> <span class="o">-</span> <span class="n">left_y</span><span class="p">)</span>
    
    <span class="c1"># 2. Pipe region blue area 
</span>    <span class="c1"># (horizontal U-shaped part)
</span>    <span class="n">pipe_area</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">*</span> <span class="p">(</span><span class="n">pipe_bottom</span> <span class="o">-</span> <span class="n">pipe_top</span><span class="p">)</span>
    
    <span class="c1"># 3. Right cylinder blue area 
</span>    <span class="c1"># (from piston to pipe bottom)
</span>    <span class="n">right_area</span> <span class="o">=</span> <span class="n">big_width</span> <span class="o">*</span> \
        <span class="p">(</span><span class="n">pipe_bottom</span> <span class="o">-</span> <span class="p">(</span><span class="n">right_y</span> <span class="o">+</span> <span class="n">big_h</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">left_area</span> <span class="o">+</span> <span class="n">pipe_area</span> <span class="o">+</span> <span class="n">right_area</span>
<span class="k">def</span> <span class="nf">input_pressure</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="s">"""Pressure applied by left piston in Pascals"""</span>
    <span class="c1"># Convert pixels to meters (100px = 1m)
</span>    <span class="n">depth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">fluid_density</span> <span class="o">*</span> <span class="n">g</span>  <span class="c1"># Pressure
</span><span class="k">def</span> <span class="nf">calculate_right_piston_position</span><span class="p">(</span><span class="n">left_y</span><span class="p">,</span> <span class="n">big_width</span><span class="p">):</span>
    <span class="s">"""Calculate right piston position to maintain 
    constant total fluid area"""</span>
    <span class="c1"># Current left and pipe areas 
</span>    <span class="c1"># (these change with left piston movement)
</span>    <span class="n">current_left_area</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">*</span> <span class="p">(</span><span class="n">pipe_bottom</span> <span class="o">-</span> <span class="n">left_y</span><span class="p">)</span>
    <span class="n">current_pipe_area</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">*</span> <span class="p">(</span><span class="n">pipe_bottom</span> <span class="o">-</span> <span class="n">pipe_top</span><span class="p">)</span>  
    
    <span class="c1"># Calculate required right area to maintain 
</span>    <span class="c1"># constant total
</span>    <span class="n">required_right_area</span> <span class="o">=</span> <span class="n">initial_fluid_area</span> <span class="o">-</span> \
                          <span class="n">current_left_area</span> <span class="o">-</span> \
                          <span class="n">current_pipe_area</span>
    
    <span class="c1"># Calculate right piston position from required 
</span>    <span class="c1"># right area
</span>    <span class="k">if</span> <span class="n">big_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">right_fluid_height</span> <span class="o">=</span> <span class="n">required_right_area</span> <span class="o">/</span> \
                            <span class="n">big_width</span>
        <span class="n">right_y</span> <span class="o">=</span> <span class="n">pipe_bottom</span> <span class="o">-</span> <span class="n">right_fluid_height</span> <span class="o">-</span>\
                            <span class="n">big_h</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">right_y</span> <span class="o">=</span> <span class="n">initial_right_y</span>
    
    <span class="c1"># Ensure the piston stays within bounds
</span>    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">right_y</span><span class="p">))</span>

<span class="c1"># Initial fluid area calculation
</span><span class="n">initial_right_y</span> <span class="o">=</span> <span class="mi">400</span>
<span class="n">initial_fluid_area</span> <span class="o">=</span> <span class="n">calculate_fluid_area</span><span class="p">(</span>
                    <span class="n">piston_y</span><span class="p">,</span><span class="n">initial_right_y</span><span class="p">,</span> <span class="n">big_w</span><span class="p">)</span>
<span class="c1"># Main Loop
# visit www.pyshine.com for more details
</span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">pygame</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="p">.</span><span class="n">QUIT</span><span class="p">:</span> 
            <span class="n">pygame</span><span class="p">.</span><span class="n">quit</span><span class="p">();</span> <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="p">.</span><span class="n">MOUSEBUTTONDOWN</span><span class="p">:</span>
            <span class="c1"># Left piston drag
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="n">piston_width</span><span class="o">//</span><span class="mi">2</span> <span class="o">&lt;</span> \
                <span class="n">e</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">left_x</span> <span class="o">+</span> <span class="n">piston_width</span><span class="o">//</span><span class="mi">2</span>
                <span class="ow">and</span> <span class="n">piston_y</span> <span class="o">-</span> <span class="n">piston_height</span><span class="o">//</span><span class="mi">2</span> <span class="o">&lt;</span> \
                <span class="n">e</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">piston_y</span> <span class="o">+</span> <span class="n">piston_height</span><span class="p">):</span>
                
                <span class="n">dragging</span><span class="p">,</span> <span class="n">offset_y</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> \
                <span class="n">e</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">piston_y</span>
            <span class="c1"># Right piston area handle drag
</span>            <span class="n">handle_rect</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">right_x</span> <span class="o">+</span> 
                          <span class="n">big_w</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handle_rect</span><span class="p">.</span><span class="n">collidepoint</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">pos</span><span class="p">):</span>
                <span class="n">area_drag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="p">.</span><span class="n">MOUSEBUTTONUP</span><span class="p">:</span>
            <span class="n">dragging</span> <span class="o">=</span> <span class="n">area_drag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="p">.</span><span class="n">MOUSEMOTION</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dragging</span><span class="p">:</span>
                <span class="n">piston_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> 
                        <span class="nb">min</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">offset_y</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">area_drag</span><span class="p">:</span>
                <span class="c1"># Change big piston area and 
</span>                <span class="c1"># update width accordingly
</span>                <span class="n">new_big_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> 
                    <span class="nb">min</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">right_x</span><span class="o">+</span><span class="n">big_w</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">A_big</span> <span class="o">=</span> <span class="n">A_small</span> <span class="o">*</span> \
                    <span class="p">(</span><span class="n">new_big_w</span> <span class="o">/</span> <span class="n">base_width</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>  
                <span class="n">big_w</span> <span class="o">=</span> <span class="n">new_big_w</span>

    <span class="c1">#Physics
</span>    <span class="n">P_in</span> <span class="o">=</span> <span class="n">input_pressure</span><span class="p">(</span><span class="n">piston_y</span><span class="p">)</span>  <span class="c1"># Pressure Pascals
</span>    <span class="n">P_out</span> <span class="o">=</span> <span class="n">P_in</span>  <span class="c1"># Same pressure (Pascal's principle)
</span>    <span class="n">F_in</span> <span class="o">=</span> <span class="n">P_in</span> <span class="o">*</span> <span class="n">A_small</span>  <span class="c1"># Force in Newtons
</span>    <span class="n">F_out</span> <span class="o">=</span> <span class="n">P_out</span> <span class="o">*</span> <span class="n">A_big</span>  <span class="c1"># Force in Newtons
</span>    
    <span class="c1"># Calculate mechanical advantage safely
</span>    <span class="n">mechanical_advantage</span> <span class="o">=</span> <span class="n">F_out</span> <span class="o">/</span> <span class="n">F_in</span> <span class="k">if</span> \
                            <span class="n">F_in</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1"># Calculate right piston position to maintain 
</span>    <span class="c1"># constant total fluid area
</span>    <span class="n">right_y</span> <span class="o">=</span> <span class="n">calculate_right_piston_position</span><span class="p">(</span>
                            <span class="n">piston_y</span><span class="p">,</span> <span class="n">big_w</span><span class="p">)</span>
    
    <span class="c1"># Calculate current total fluid area for display
</span>    <span class="n">current_fluid_area</span> <span class="o">=</span> <span class="n">calculate_fluid_area</span><span class="p">(</span>
                            <span class="n">piston_y</span><span class="p">,</span> <span class="n">right_y</span><span class="p">,</span> <span class="n">big_w</span><span class="p">)</span>

    <span class="c1">#Drawing
</span>    <span class="n">S</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">DARK</span><span class="p">)</span>

    <span class="c1"># U-shaped pipe - ALL THREE BLUE REGIONS:
</span>    <span class="c1"># 1. Horizontal pipe region (constant)
</span>    <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">,</span> <span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> 
                   <span class="n">pipe_top</span><span class="p">,</span> 
                   <span class="n">right_x</span> <span class="o">-</span> <span class="n">left_x</span> <span class="o">+</span> <span class="mi">40</span><span class="p">,</span> 
                   <span class="n">pipe_bottom</span> <span class="o">-</span> <span class="n">pipe_top</span><span class="p">))</span>
    <span class="c1"># 2. Left cylinder blue region (changes with piston)
</span>    <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">,</span> <span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> 
                   <span class="n">piston_y</span><span class="p">,</span> 
                   <span class="mi">40</span><span class="p">,</span> 
                   <span class="n">pipe_bottom</span> <span class="o">-</span> <span class="n">piston_y</span><span class="p">))</span>
    <span class="c1"># 3. Right cylinder blue region (changes with piston)
</span>    <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">,</span> <span class="p">(</span><span class="n">right_x</span> <span class="o">-</span> <span class="n">big_w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> 
                   <span class="n">right_y</span> <span class="o">+</span> <span class="n">big_h</span><span class="p">,</span> 
                   <span class="n">big_w</span><span class="p">,</span> 
                   <span class="n">pipe_bottom</span> <span class="o">-</span> <span class="p">(</span><span class="n">right_y</span> <span class="o">+</span> <span class="n">big_h</span><span class="p">)))</span>

    <span class="c1"># Left cylinder outline
</span>    <span class="n">cyl_rect</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="n">cylinder_w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> 
                           <span class="n">y_min</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> 
                           <span class="n">cylinder_w</span><span class="p">,</span> 
                           <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">OUTLINE</span><span class="p">,</span> <span class="n">cyl_rect</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Left piston shaft + T-head - CHANGE COLOR 
</span>    <span class="k">if</span> <span class="n">dragging</span><span class="p">:</span>
        <span class="c1"># Use ORANGE when dragging
</span>        <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">ORANGE</span><span class="p">,</span> 
             <span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> 
              <span class="n">piston_y</span> <span class="o">-</span> <span class="n">shaft_len</span><span class="p">,</span> 
              <span class="mi">10</span><span class="p">,</span> 
              <span class="n">shaft_len</span><span class="p">))</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="n">piston_width</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> 
                    <span class="n">piston_y</span><span class="p">,</span> 
                    <span class="n">piston_width</span><span class="p">,</span> 
                    <span class="n">piston_height</span><span class="p">)</span>
        <span class="n">top_bar</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="n">piston_width</span><span class="p">,</span> 
                       <span class="n">piston_y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> 
                       <span class="n">piston_width</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> 
                       <span class="mi">10</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">ORANGE</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">ORANGE</span><span class="p">,</span> <span class="n">top_bar</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use GRAY when not dragging
</span>        <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">GRAY</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                <span class="n">piston_y</span> <span class="o">-</span> <span class="n">shaft_len</span><span class="p">,</span> 
                <span class="mi">10</span><span class="p">,</span> 
                <span class="n">shaft_len</span><span class="p">))</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="n">piston_width</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> 
                           <span class="n">piston_y</span><span class="p">,</span> 
                           <span class="n">piston_width</span><span class="p">,</span> 
                           <span class="n">piston_height</span><span class="p">)</span>
        <span class="n">top_bar</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="n">piston_width</span><span class="p">,</span> 
                              <span class="n">piston_y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> 
                              <span class="n">piston_width</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> 
                              <span class="mi">10</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">GRAY</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">GRAY</span><span class="p">,</span> <span class="n">top_bar</span><span class="p">)</span>

    <span class="c1"># Right piston
</span>    <span class="n">right_rect</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">right_x</span> <span class="o">-</span> <span class="n">big_w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> 
                      <span class="n">right_y</span><span class="p">,</span> 
                      <span class="n">big_w</span><span class="p">,</span> 
                      <span class="n">big_h</span><span class="p">)</span>
    <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">GRAY</span><span class="p">,</span> <span class="n">right_rect</span><span class="p">)</span>
    <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">OUTLINE</span><span class="p">,</span> <span class="n">right_rect</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Handle to drag width/area - 
</span>    <span class="c1"># CHANGE COLOR WHEN DRAGGING
</span>    <span class="n">handle_rect</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">right_x</span> <span class="o">+</span> <span class="n">big_w</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> 
                       <span class="mi">350</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">area_drag</span><span class="p">:</span>
        <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">ORANGE</span><span class="p">,</span> <span class="n">handle_rect</span><span class="p">)</span>  <span class="c1"># Orange dragging
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">rect</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">HANDLE_COLOR</span><span class="p">,</span> <span class="n">handle_rect</span><span class="p">)</span>  <span class="c1"># Normal color
</span>
    <span class="c1"># Pipe outline
</span>    <span class="n">lines</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="n">pipe_top</span><span class="p">),</span>
        <span class="p">(</span><span class="n">left_x</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="n">pipe_bottom</span><span class="p">),</span>
        <span class="p">(</span><span class="n">right_x</span> <span class="o">+</span> <span class="n">big_w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">pipe_bottom</span><span class="p">),</span>
        <span class="p">(</span><span class="n">right_x</span> <span class="o">+</span> <span class="n">big_w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">pipe_top</span><span class="p">)</span>
    <span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Pascal's Law formula and explanation added to the info panel
</span>    <span class="n">info_lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"Pascal's Law:"</span><span class="p">,</span>
        <span class="s">"Pressure applied to confined fluid is transmitted equally"</span><span class="p">,</span>
        <span class="s">"Formula: P = F / A (Pressure = Force divided by Area)"</span><span class="p">,</span>
        <span class="s">""</span><span class="p">,</span>
        <span class="sa">f</span><span class="s">"Input Force: </span><span class="si">{</span><span class="n">F_in</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> N | Output Force: </span><span class="si">{</span><span class="n">F_out</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> N"</span><span class="p">,</span>
        <span class="sa">f</span><span class="s">"Input Area: </span><span class="si">{</span><span class="n">A_small</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> m² | Output Area: </span><span class="si">{</span><span class="n">A_big</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> m²"</span><span class="p">,</span>
        <span class="s">"From Pascal's law: F_in / A_small = F_out/A_big"</span><span class="p">,</span>
        <span class="sa">f</span><span class="s">"Input Pressure: </span><span class="si">{</span><span class="n">F_in</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> N / </span><span class="si">{</span><span class="n">A_small</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> m² = </span><span class="si">{</span><span class="n">P_in</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> Pa"</span><span class="p">,</span>
        <span class="sa">f</span><span class="s">"Output Pressure: </span><span class="si">{</span><span class="n">F_out</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> N / </span><span class="si">{</span><span class="n">A_big</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> m² = </span><span class="si">{</span><span class="n">P_out</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> Pa"</span>
            <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info_lines</span><span class="p">):</span>
        <span class="n">S</span><span class="p">.</span><span class="n">blit</span><span class="p">(</span><span class="n">font</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">),</span> 
               <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">22</span><span class="p">))</span>

    <span class="n">pygame</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">flip</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="live-information-panel">Live Information Panel</h2>

<p>The top panel displays:</p>

<ul>
  <li>Pascal’s Law explanation</li>
  <li>Input &amp; output forces</li>
  <li>Input &amp; output areas</li>
  <li>Pressure equality proof</li>
</ul>

<p>Example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Input Pressure: 981 Pa
Output Pressure: 981 Pa
</code></pre></div></div>

<hr />

<h2 id="educational-use-cases">Educational Use Cases</h2>

<p>This simulation is excellent for:</p>

<ul>
  <li>Physics classrooms</li>
  <li>STEM demonstrations</li>
  <li>Engineering intuition</li>
  <li>Interactive learning projects</li>
  <li>Educational games</li>
</ul>

<hr />

<h2 id="real-world-applications-of-pascals-law">Real-World Applications of Pascal’s Law</h2>

<ul>
  <li>Hydraulic car jacks</li>
  <li>Excavators</li>
  <li>Aircraft brakes</li>
  <li>Industrial presses</li>
  <li>Power steering systems</li>
</ul>

<hr />

<h2 id="common-questions-faq">Common Questions (FAQ)</h2>

<h3 id="why-doesnt-force-stay-the-same">Why doesn’t force stay the same?</h3>
<p>Because <strong>area changes</strong>. Pressure stays constant, not force.</p>

<hr />

<h3 id="why-is-the-output-piston-larger">Why is the output piston larger?</h3>
<p>To demonstrate <strong>force multiplication</strong>.</p>

<hr />

<h3 id="why-is-gravity-included">Why is gravity included?</h3>
<p>It converts piston depth into <strong>real pressure values</strong>.</p>

<hr />

<h3 id="is-this-physically-accurate">Is this physically accurate?</h3>
<p>Yes for <strong>ideal fluids</strong> (incompressible, no losses).</p>

<hr />

<h2 id="possible-extensions">Possible Extensions</h2>

<ul>
  <li>Add pressure gauges</li>
  <li>Animate fluid particles</li>
  <li>Add oil vs water density</li>
  <li>Add real hydraulic ratios</li>
  <li>Export data graphs</li>
</ul>

<hr />

<h2 id="conclusion">Conclusion</h2>

<p>This Pygame project transforms Pascal’s Law from a formula into a <strong>hands-on visual experience</strong>. By interacting with pistons and areas, users gain an intuitive understanding of pressure, force, and mechanical advantage.</p>

<p>If you can <em>see</em> physics, you can <em>understand</em> it.</p>

<hr />

<p>Happy learning!</p>]]></content><author><name>PyShine Team</name></author><summary type="html"><![CDATA[A detailed beginner-to-intermediate tutorial explaining Pascal’s Law using an interactive Pygame hydraulic press simulation.]]></summary></entry><entry><title type="html">Interactive 3D PSO with a Draggable Target in Python</title><link href="http://localhost:4000/How-to-make-3D-PSO-simulation/" rel="alternate" type="text/html" title="Interactive 3D PSO with a Draggable Target in Python" /><published>2025-12-23T00:00:00+08:00</published><updated>2025-12-23T00:00:00+08:00</updated><id>http://localhost:4000/How-to-make-3D-PSO-simulation</id><content type="html" xml:base="http://localhost:4000/How-to-make-3D-PSO-simulation/"><![CDATA[<h1 id="interactive-3d-pso-with-a-draggable-target-in-python">Interactive 3D PSO with a Draggable Target in Python</h1>

<p>This tutorial explains <strong>two Python scripts working together</strong>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Draggable.py</code> → an interactive 2D window where you drag a target and adjust its <strong>Z value</strong></li>
  <li><code class="language-plaintext highlighter-rouge">main.py</code> → a <strong>3D Particle Swarm Optimization (PSO)</strong> simulation that continuously chases that target</li>
</ul>

<p>This is a powerful example of <strong>interactive optimization</strong>, <strong>real-time visualization</strong>, and <strong>process communication</strong> in Python.</p>

<hr />

<h2 id="big-picture-how-everything-works">Big Picture: How Everything Works</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mouse / Keyboard
      ↓
Draggable.py  ──► target.csv  ──► main.py (PSO)
      ↑                                   ↓
   Visual UI                    3D Particles Follow Target
</code></pre></div></div>

<ul>
  <li>You drag a point in 2D (X, Y)</li>
  <li>Press <strong>U / D</strong> to move Z up or down</li>
  <li>The target position is written to <code class="language-plaintext highlighter-rouge">target.csv</code></li>
  <li>The PSO loop continuously reads that file</li>
  <li>Particles move toward the live target</li>
</ul>

<p>This pattern is extremely useful for <strong>human-in-the-loop optimization</strong>.</p>

<hr />

<h2 id="file-1-draggablepy-interactive-target-controller">File 1: Draggable.py (Interactive Target Controller)</h2>

<h3 id="purpose">Purpose</h3>
<ul>
  <li>Lets the user <strong>drag a target with the mouse</strong></li>
  <li>Shows live <strong>X, Y, Z values</strong> on screen</li>
  <li>Writes the target position to a CSV file</li>
</ul>

<h3 id="key-concepts-used">Key Concepts Used</h3>
<ul>
  <li>Matplotlib mouse events</li>
  <li>Keyboard events</li>
  <li>Text overlays</li>
  <li>Safe exit handling</li>
</ul>

<h3 id="important-sections-explained">Important Sections Explained</h3>

<h4 id="1-clean-exit-handling">1. Clean Exit Handling</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="s">"all"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>
<p>This ensures the window closes cleanly when you press <strong>Ctrl+C</strong> or close the app.</p>

<hr />

<h4 id="2-interactive-target">2. Interactive Target</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
</code></pre></div></div>
<p>This represents <strong>X, Y, Z</strong>. Only X &amp; Y are draggable; Z is controlled by keys.</p>

<hr />

<h4 id="3-mouse-drag-logic">3. Mouse Drag Logic</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">on_motion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pressed</span> <span class="ow">or</span> <span class="n">event</span><span class="p">.</span><span class="n">inaxes</span> <span class="o">!=</span> <span class="n">ax</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">ydata</span>
    <span class="n">update</span><span class="p">()</span>
</code></pre></div></div>
<p>This allows smooth dragging inside the plot area.</p>

<hr />

<h4 id="4-keyboard-control-for-z-axis">4. Keyboard Control for Z Axis</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">on_key</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">'u'</span><span class="p">:</span>
        <span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10</span>
    <span class="k">elif</span> <span class="n">event</span><span class="p">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">'d'</span><span class="p">:</span>
        <span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">10</span>
    <span class="n">update</span><span class="p">()</span>
</code></pre></div></div>
<p>This adds <strong>3D control using a 2D UI</strong>.</p>

<hr />

<h4 id="5-live-text-overlay">5. Live Text Overlay</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">txt</span><span class="p">.</span><span class="n">set_text</span><span class="p">(</span>
    <span class="sa">f</span><span class="s">"x: </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
    <span class="sa">f</span><span class="s">"y: </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
    <span class="sa">f</span><span class="s">"z: </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">"</span>
<span class="p">)</span>
</code></pre></div></div>
<p>Users always see exact coordinates — extremely helpful for debugging and demos.</p>

<hr />

<h2 id="file-2-mainpy-interactive-pso-engine">File 2: main.py (Interactive PSO Engine)</h2>

<h3 id="purpose-1">Purpose</h3>
<ul>
  <li>Runs a <strong>3D Particle Swarm Optimization</strong> loop</li>
  <li>Continuously reads the target from <code class="language-plaintext highlighter-rouge">target.csv</code></li>
  <li>Visualizes particles chasing a moving target</li>
</ul>

<hr />

<h2 id="what-is-pso-quick-theory">What is PSO (Quick Theory)</h2>

<p>Particle Swarm Optimization is inspired by <strong>bird flocks and fish schools</strong>.</p>

<p>Each particle:</p>
<ul>
  <li>Has a position</li>
  <li>Has a velocity</li>
  <li>Moves toward a target using momentum + attraction</li>
</ul>

<p>Formula intuition:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new_velocity = inertia + attraction_to_target
new_position = old_position + new_velocity
</code></pre></div></div>

<hr />

<h2 id="particle-class-explained">Particle Class Explained</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Particle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">)</span>
</code></pre></div></div>
<p>Each particle computes <strong>distance to the target</strong>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">self</span><span class="p">.</span><span class="n">vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">random</span><span class="p">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">w</code> → inertia (smooth motion)</li>
  <li><code class="language-plaintext highlighter-rouge">c</code> → attraction strength</li>
</ul>

<hr />

<h2 id="why-csv-is-used-and-why-its-smart">Why CSV Is Used (And Why It’s Smart)</h2>

<p>Using <code class="language-plaintext highlighter-rouge">target.csv</code> is:</p>

<p>✔ Simple
✔ Debuggable
✔ Language-agnostic
✔ Easy to visualize</p>

<p>This technique is common in:</p>
<ul>
  <li>Robotics</li>
  <li>Simulation systems</li>
  <li>Multi-process AI experiments</li>
</ul>

<hr />

<h2 id="why-this-project-is-important">Why This Project Is Important</h2>

<p>This is <strong>not just a demo</strong> — it teaches:</p>

<ul>
  <li>Event-driven programming</li>
  <li>Real-time visualization</li>
  <li>Optimization algorithms</li>
  <li>Inter-process communication</li>
  <li>Human-in-the-loop control</li>
</ul>

<p>Many beginners never see these ideas combined.</p>

<hr />

<h2 id="practical-use-cases">Practical Use Cases</h2>

<ol>
  <li><strong>AI parameter tuning with human guidance</strong></li>
  <li><strong>Robotics target following simulations</strong></li>
  <li><strong>Game AI movement systems</strong></li>
  <li><strong>Research demos &amp; visual explanations</strong></li>
  <li><strong>Teaching optimization interactively</strong></li>
</ol>

<hr />

<h2 id="complete-code">Complete Code</h2>

<h3 id="draggablepy">Draggable.py</h3>

<style>
  .copy-code-button {
	box-shadow:inset 0px 1px 0px 0px #bbdaf7;
	background:linear-gradient(to bottom, #79bbff 5%, #378de5 100%);
	background-color:#79bbff;
	border-radius:6px;
	border:1px solid #84bbf3;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #528ecc;
}
.copy-code-button:hover {
	background:linear-gradient(to bottom, #378de5 5%, #79bbff 100%);
	background-color:#378de5;
}
.copy-code-button:active {
	position:relative;
	top:1px;
}
</style>

<div class="code-header">
  <button class="copy-code-button">
    Copy code to clipboard
  </button>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Welcome to PyShine
</span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">signal</span><span class="p">,</span> <span class="n">sys</span>

<span class="n">TARGET_FILE</span> <span class="o">=</span> <span class="s">"target.csv"</span>

<span class="c1">#  CLEAN EXIT 
</span><span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="s">"all"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">cleanup</span><span class="p">)</span>
<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">cleanup</span><span class="p">)</span>

<span class="c1">#  FIGURE 
</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">fig</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s">"white"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s">"white"</span><span class="p">)</span>

<span class="n">ax</span><span class="p">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">"Drag Target | U / D = Z"</span><span class="p">)</span>

<span class="c1">#  TARGET 
</span><span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

<span class="n">pt</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">[</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
    <span class="s">'ko'</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>

<span class="c1"># TEXT OVERLAY (TOP-LEFT, AXES COORDS)
</span><span class="n">txt</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="n">text</span><span class="p">(</span>
    <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span>
    <span class="s">""</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="p">.</span><span class="n">transAxes</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">verticalalignment</span><span class="o">=</span><span class="s">"top"</span><span class="p">,</span>
    <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s">"white"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s">"none"</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">#  FILE WRITE 
</span><span class="k">def</span> <span class="nf">write_target</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TARGET_FILE</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">""</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">csv</span><span class="p">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="n">writerow</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="c1">#  UPDATE 
</span><span class="k">def</span> <span class="nf">update</span><span class="p">():</span>
    <span class="n">pt</span><span class="p">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>   <span class="c1"># sequence-safe
</span>    <span class="n">txt</span><span class="p">.</span><span class="n">set_text</span><span class="p">(</span>
        <span class="sa">f</span><span class="s">"x: </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
        <span class="sa">f</span><span class="s">"y: </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
        <span class="sa">f</span><span class="s">"z: </span><span class="si">{</span><span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">"</span>
    <span class="p">)</span>
    <span class="n">write_target</span><span class="p">()</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">draw_idle</span><span class="p">()</span>

<span class="c1"># initial write + text
</span><span class="n">update</span><span class="p">()</span>

<span class="c1">#  EVENTS 
</span><span class="n">pressed</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">on_press</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">pressed</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="n">inaxes</span> <span class="o">==</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">pressed</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">on_release</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">pressed</span>
    <span class="n">pressed</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">on_motion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pressed</span> <span class="ow">or</span> <span class="n">event</span><span class="p">.</span><span class="n">inaxes</span> <span class="o">!=</span> <span class="n">ax</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="n">xdata</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">event</span><span class="p">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">ydata</span>
    <span class="n">update</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">on_key</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">'u'</span><span class="p">:</span>
        <span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10</span>
    <span class="k">elif</span> <span class="n">event</span><span class="p">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">'d'</span><span class="p">:</span>
        <span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">10</span>
    <span class="n">update</span><span class="p">()</span>

<span class="c1">#  CONNECT 
</span><span class="n">fig</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">"button_press_event"</span><span class="p">,</span> <span class="n">on_press</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">"button_release_event"</span><span class="p">,</span> <span class="n">on_release</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">"motion_notify_event"</span><span class="p">,</span> <span class="n">on_motion</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">"key_press_event"</span><span class="p">,</span> <span class="n">on_key</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div></div>

<h3 id="mainpy">main.py</h3>

<style>
  .copy-code-button {
	box-shadow:inset 0px 1px 0px 0px #bbdaf7;
	background:linear-gradient(to bottom, #79bbff 5%, #378de5 100%);
	background-color:#79bbff;
	border-radius:6px;
	border:1px solid #84bbf3;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #528ecc;
}
.copy-code-button:hover {
	background:linear-gradient(to bottom, #378de5 5%, #79bbff 100%);
	background-color:#378de5;
}
.copy-code-button:active {
	position:relative;
	top:1px;
}
</style>

<div class="code-header">
  <button class="copy-code-button">
    Copy code to clipboard
  </button>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Welcome to PyShine
</span><span class="kn">import</span> <span class="nn">random</span><span class="p">,</span> <span class="n">csv</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">_thread</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1">#  SAFETY 
</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">running</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Figure closed — breaking loop"</span><span class="p">)</span>
    <span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"target.csv"</span><span class="p">,</span><span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"0,0,0"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">start_drag</span><span class="p">():</span>
    <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">"python Draggable.py"</span><span class="p">)</span>

<span class="n">_thread</span><span class="p">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">start_drag</span><span class="p">,</span> <span class="p">())</span>

<span class="c1">#  UTILS 
</span><span class="k">def</span> <span class="nf">getXYZ</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv</span><span class="p">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

<span class="k">def</span> <span class="nf">fitness</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
    <span class="n">tx</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="n">getXYZ</span><span class="p">(</span><span class="s">"target.csv"</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tx</span><span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ty</span><span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tz</span><span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

<span class="c1">#  PARTICLE 
</span><span class="k">class</span> <span class="nc">Particle</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">initial</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">vel</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">initial</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">id</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">'inf'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Particle </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="nb">id</span><span class="si">:</span><span class="mi">02</span><span class="n">d</span><span class="si">}</span><span class="s"> ERROR -----&gt; </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">error</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">error</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">1.8</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">)):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">random</span><span class="p">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">.</span><span class="n">vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1">#  PSO 
</span><span class="k">class</span> <span class="nc">Interactive_PSO</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">num_particles</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s">"hsv"</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">running</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">num_particles</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_particles</span><span class="p">)]</span>

        <span class="n">swarm</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Particle</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_particles</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">ion</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s">'3d'</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">"close_event"</span><span class="p">,</span> <span class="n">on_close</span><span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">running</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>

            <span class="n">target</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">getXYZ</span><span class="p">(</span><span class="s">"target.csv"</span><span class="p">))</span>

            <span class="n">global_best_error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">'inf'</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">=== ITERATION </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s"> ==="</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"TARGET ---&gt; </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">swarm</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">evaluate</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="n">global_best_error</span><span class="p">:</span>
                    <span class="n">global_best_error</span> <span class="o">=</span> <span class="n">err</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">swarm</span><span class="p">:</span>
                <span class="n">p</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">color</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">'k'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span>
                <span class="s">"PyShine Interactive PSO (3D) | Particles:{} | Error:{:.2f}"</span>
                <span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">num_particles</span><span class="p">,</span> <span class="n">global_best_error</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">plt</span><span class="p">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Results"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Final Target:"</span><span class="p">,</span> <span class="n">getXYZ</span><span class="p">(</span><span class="s">"target.csv"</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Final Best Error:"</span><span class="p">,</span> <span class="n">global_best_error</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="s">'all'</span><span class="p">)</span>

<span class="c1">#  RUN 
</span><span class="n">Interactive_PSO</span><span class="p">(</span>
    <span class="n">initial</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mi">800</span><span class="p">,</span><span class="mi">800</span><span class="p">)]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">num_particles</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>     <span class="c1"># any number
</span>    <span class="n">colormap</span><span class="o">=</span><span class="s">"hsv"</span>
<span class="p">)</span>

</code></pre></div></div>

<h2 id="common-questions-faq">Common Questions (FAQ)</h2>

<h3 id="q-why-not-use-sockets-or-shared-memory">Q: Why not use sockets or shared memory?</h3>
<p>CSV is simpler, safer, and perfect for teaching concepts first.</p>

<hr />

<h3 id="q-can-this-be-extended-to-real-ai-models">Q: Can this be extended to real AI models?</h3>
<p>Yes. Replace <code class="language-plaintext highlighter-rouge">fitness()</code> with a real evaluation function.</p>

<hr />

<h3 id="q-can-i-control-velocity-or-pso-parameters-live">Q: Can I control velocity or PSO parameters live?</h3>
<p>Absolutely — add keyboard bindings just like Z control.</p>

<hr />

<h3 id="q-why-is-this-powerful">Q: Why is this powerful?</h3>
<p>Because <strong>you are steering an optimizer in real time</strong>.</p>

<hr />

<h2 id="final-thoughts">Final Thoughts</h2>

<p>This project beautifully combines:</p>

<ul>
  <li>Visualization</li>
  <li>Optimization</li>
  <li>Interaction</li>
  <li>Clean Python design</li>
</ul>

<p>It’s an excellent <strong>advanced-beginner to intermediate</strong> Python project and a great foundation for AI demos.</p>

<hr />

<p>Happy coding!</p>

<p>Built with ❤️ by PyShine</p>]]></content><author><name>PyShine Team</name></author><summary type="html"><![CDATA[A beginner-friendly tutorial explaining how to build an interactive 3D Particle Swarm Optimization (PSO) demo using Matplotlib, keyboard & mouse events, and inter-process communication via CSV.]]></summary></entry><entry><title type="html">Automatically Free a Busy Port in Python Using psutil</title><link href="http://localhost:4000/How-to-fix-Address-already-in-use-problem/" rel="alternate" type="text/html" title="Automatically Free a Busy Port in Python Using psutil" /><published>2025-12-13T00:00:00+08:00</published><updated>2025-12-13T00:00:00+08:00</updated><id>http://localhost:4000/How-to-fix-Address-already-in-use-problem</id><content type="html" xml:base="http://localhost:4000/How-to-fix-Address-already-in-use-problem/"><![CDATA[<h1 id="automatically-free-a-busy-port-in-python-using-psutil">Automatically Free a Busy Port in Python Using psutil</h1>

<p>If you’ve ever tried to start a Python server and received an error like <strong>“Address already in use”</strong>, this tutorial is for you. We’ll learn how to <strong>detect which process is using a port and safely terminate it</strong> using Python and the <code class="language-plaintext highlighter-rouge">psutil</code> library.</p>

<p>This guide is written for <strong>Python beginners</strong>, with clear explanations, examples, and real-world use cases.</p>

<hr />

<h2 id="what-problem-does-this-solve">What Problem Does This Solve?</h2>

<p>When running a server (TCP, HTTP, Flask, FastAPI, etc.), the program needs exclusive access to a port (like <code class="language-plaintext highlighter-rouge">12345</code> or <code class="language-plaintext highlighter-rouge">8000</code>).</p>

<p>Sometimes:</p>
<ul>
  <li>A previous server didn’t shut down correctly</li>
  <li>Another application is already using the port</li>
  <li>A crashed process is still running in the background</li>
</ul>

<p>This causes errors such as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OSError: [Errno 48] Address already in use
</code></pre></div></div>
<p>or in Windows operating system</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OSError: [WinError 10048] Only one usage of each socket address (protocol/network address/port) is normally permitted
</code></pre></div></div>

<p>This script <strong>automatically finds and kills the process using the port</strong>, then starts the server cleanly.</p>

<hr />

<h2 id="installing-required-library">Installing Required Library</h2>

<p>We use the <code class="language-plaintext highlighter-rouge">psutil</code> library to inspect running processes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>psutil
</code></pre></div></div>

<hr />

<h2 id="full-working-code">Full Working Code</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install psutil
</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">psutil</span>


<span class="k">def</span> <span class="nf">scan_and_terminate</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="s">"""
    Check if a process is using the given port.
    If yes, terminate that process.
    Returns True if a process was killed.
    """</span>
    <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">proc</span><span class="p">.</span><span class="n">connections</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">"inet"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">conn</span><span class="p">.</span><span class="n">laddr</span><span class="p">.</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="s">"name"</span><span class="p">],</span> <span class="n">proc</span><span class="p">.</span><span class="n">pid</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[INFO] Port </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s"> busy!"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[INFO] Terminating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> (PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
            <span class="n">proc</span><span class="p">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">terminate_process_on_port</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
    <span class="s">"""
    Scan all running processes and terminate
    the one holding the given port.
    """</span>
    <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">psutil</span><span class="p">.</span><span class="n">process_iter</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s">"pid"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scan_and_terminate</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">psutil</span><span class="p">.</span><span class="n">AccessDenied</span><span class="p">,</span> <span class="n">psutil</span><span class="p">.</span><span class="n">NoSuchProcess</span><span class="p">):</span>
            <span class="k">pass</span>


<span class="k">def</span> <span class="nf">start_server</span><span class="p">():</span>
    <span class="s">"""
    Start a TCP server after freeing the port
    """</span>
    <span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">12345</span>

    <span class="c1"># Ensure port is free
</span>    <span class="n">terminate_process_on_port</span><span class="p">(</span><span class="n">PORT</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
    <span class="n">s</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[INFO] Server running on </span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">PORT</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">start_server</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h2 id="code-explanation-beginner-friendly">Code Explanation (Beginner Friendly)</h2>

<h3 id="1-scanning-processes-for-port-usage">1. Scanning Processes for Port Usage</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proc</span><span class="p">.</span><span class="n">connections</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">"inet"</span><span class="p">)</span>
</code></pre></div></div>

<p>This checks all <strong>network connections</strong> of a process (TCP &amp; UDP).</p>

<p>We compare the local port:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">conn</span><span class="p">.</span><span class="n">laddr</span><span class="p">.</span><span class="n">port</span> <span class="o">==</span> <span class="n">port</span><span class="p">:</span>
</code></pre></div></div>

<p>If it matches, the process is using the port.</p>

<hr />

<h3 id="2-terminating-the-process">2. Terminating the Process</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proc</span><span class="p">.</span><span class="n">kill</span><span class="p">()</span>
</code></pre></div></div>

<p>This forcefully stops the process holding the port.</p>

<p>We then pause briefly:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div></div>

<p>This gives the OS time to release the port.</p>

<hr />

<h3 id="3-iterating-over-all-running-processes">3. Iterating Over All Running Processes</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">psutil</span><span class="p">.</span><span class="n">process_iter</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s">"pid"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">])</span>
</code></pre></div></div>

<p>This safely loops over <strong>all running processes</strong> without crashing if access is denied.</p>

<hr />

<h3 id="4-starting-the-tcp-server">4. Starting the TCP Server</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
</code></pre></div></div>

<p>Once the port is free, the server starts successfully.</p>

<hr />

<h2 id="why-this-code-is-important">Why This Code Is Important</h2>

<ul>
  <li>Prevents <strong>“Address already in use”</strong> errors</li>
  <li>Automates cleanup during development</li>
  <li>Makes scripts <strong>self-healing</strong></li>
  <li>Saves time restarting servers manually</li>
</ul>

<hr />

<h2 id="real-world-use-cases">Real-World Use Cases</h2>

<h3 id="-development-servers">✅ Development Servers</h3>
<ul>
  <li>Flask / FastAPI</li>
  <li>Socket servers</li>
  <li>Local testing environments</li>
</ul>

<h3 id="-game-servers">✅ Game Servers</h3>
<ul>
  <li>Multiplayer socket-based games</li>
</ul>

<h3 id="-embedded--iot-systems">✅ Embedded &amp; IoT Systems</h3>
<ul>
  <li>Restarting services automatically</li>
</ul>

<h3 id="-cicd--automation">✅ CI/CD &amp; Automation</h3>
<ul>
  <li>Ensure ports are free before deployment</li>
</ul>

<hr />

<h2 id="safety-notes">Safety Notes</h2>

<ul>
  <li>This script <strong>kills processes forcefully</strong></li>
  <li>Use only in <strong>development environments</strong></li>
  <li>Avoid running as root unless necessary</li>
  <li>Never blindly kill ports on production machines</li>
</ul>

<hr />

<h2 id="common-questions-faq">Common Questions (FAQ)</h2>

<p><strong>Q: Will this work on macOS, Linux, and Windows?</strong><br />
Yes. <code class="language-plaintext highlighter-rouge">psutil</code> is cross-platform.</p>

<p><strong>Q: Can I terminate multiple processes on the same port?</strong><br />
Ports are exclusive—only one process can bind to a port at a time.</p>

<p><strong>Q: Can I make it safer?</strong><br />
Yes! You can prompt the user before killing the process.</p>

<hr />

<h2 id="beginner-exercise">Beginner Exercise</h2>

<p>Try modifying the script to:</p>
<ul>
  <li>Ask the user before terminating a process</li>
  <li>Log killed processes to a file</li>
  <li>Support multiple ports</li>
</ul>

<hr />

<h2 id="conclusion">Conclusion</h2>

<p>This script is a powerful example of how Python can interact with the operating system to solve real-world problems. Learning <code class="language-plaintext highlighter-rouge">psutil</code> opens the door to system monitoring, automation, and professional-grade tools.</p>

<p>Happy hacking!</p>]]></content><author><name>PyShine</name></author><category term="Python" /><category term="Networking" /><category term="python" /><category term="psutil" /><category term="sockets" /><category term="tcp" /><category term="dev-tools" /><summary type="html"><![CDATA[How to detect and safely terminate processes occupying a TCP port in Python using psutil. A beginner-friendly, real-world tutorial.]]></summary></entry><entry><title type="html">AnimeGANv3 ONNX GUI – Complete Beginner’s Guide</title><link href="http://localhost:4000/Tkinter-AnimeGanv3-ONNX-GUI/" rel="alternate" type="text/html" title="AnimeGANv3 ONNX GUI – Complete Beginner’s Guide" /><published>2025-11-27T00:00:00+08:00</published><updated>2025-11-27T00:00:00+08:00</updated><id>http://localhost:4000/Tkinter-AnimeGanv3-ONNX-GUI</id><content type="html" xml:base="http://localhost:4000/Tkinter-AnimeGanv3-ONNX-GUI/"><![CDATA[<h2 id="introduction">Introduction</h2>

<p>AnimeGANv3 allows you to transform images into anime-style artwork using pre-trained ONNX models.In this tutorial, we will build a <strong>Tkinter GUI application</strong> that:</p>

<ul>
  <li>Automatically installs required Python packages</li>
  <li>Lets you select an image</li>
  <li>Converts it into anime style using ONNX models</li>
  <li>Allows you to view, save, or revert to the original image</li>
</ul>

<div class="video-container">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/18NOZhaZpSU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
  </iframe>
</div>

<p>No prior experience with ONNX or GUI programming is needed.</p>

<hr />

<h2 id="understanding-the-requirements">Understanding the Requirements</h2>

<h3 id="required-packages">Required Packages:</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Pillow&gt;=10</code> – for image processing</li>
  <li><code class="language-plaintext highlighter-rouge">numpy</code> – numerical operations</li>
  <li><code class="language-plaintext highlighter-rouge">opencv-contrib-python</code> – image manipulation</li>
  <li><code class="language-plaintext highlighter-rouge">onnxruntime</code> – run ONNX models</li>
  <li><code class="language-plaintext highlighter-rouge">tkinter</code> – GUI (usually comes with Python)</li>
</ul>

<p>Our app will:</p>

<ul>
  <li>Ensure required packages are installed automatically</li>
  <li>Download AnimeGANv3 models if missing</li>
  <li>Resize images for GUI display</li>
  <li>Transform images to anime style</li>
  <li>Save results to your disk</li>
</ul>

<hr />

<h2 id="step-1-setting-up-the-environment">Step 1: Setting Up the Environment</h2>

<p>It is recommended to use Python &gt;=3.8 and &lt;=3.11. Open your terminal and install packages manually (optional, automatic installer included in code):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>Pillow&gt;<span class="o">=</span>10 numpy opencv-contrib-python onnxruntime
</code></pre></div></div>

<hr />

<h2 id="step-2-automatic-package-installer">Step 2: Automatic Package Installer</h2>

<p>Our code automatically installs missing packages:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">required_packages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"Pillow&gt;=10"</span><span class="p">,</span>
    <span class="s">"numpy"</span><span class="p">,</span>
    <span class="s">"opencv-contrib-python"</span><span class="p">,</span>
    <span class="s">"onnxruntime"</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">install_package</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[INFO] Installing </span><span class="si">{</span><span class="n">pkg</span><span class="si">}</span><span class="s"> ..."</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="p">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">"-m"</span><span class="p">,</span> <span class="s">"pip"</span><span class="p">,</span> <span class="s">"install"</span><span class="p">,</span> <span class="s">"--upgrade"</span><span class="p">,</span> <span class="n">pkg</span><span class="p">])</span>

<span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">required_packages</span><span class="p">:</span>
    <span class="n">pkg_name</span> <span class="o">=</span> <span class="n">pkg</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'&gt;='</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
        <span class="n">install_package</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="step-3-loading-and-downloading-onnx-models">Step 3: Loading and Downloading ONNX Models</h2>

<p>AnimeGANv3 comes with two styles: <strong>Hayao</strong> and <strong>Shinkai</strong>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="n">STYLE_MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"Hayao"</span><span class="p">:</span> <span class="s">"AnimeGANv3_Hayao_36.onnx"</span><span class="p">,</span>
    <span class="s">"Shinkai"</span><span class="p">:</span> <span class="s">"AnimeGANv3_Shinkai_37.onnx"</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s">"https://github.com/TachibanaYoshino/AnimeGANv3/releases/download/v1.1.0/"</span>
<span class="n">MAX_DISPLAY_SIZE</span> <span class="o">=</span> <span class="mi">512</span>

<span class="k">def</span> <span class="nf">get_model_path</span><span class="p">(</span><span class="n">style_name</span><span class="p">):</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">STYLE_MODELS</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">style_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">"models"</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_model</span><span class="p">(</span><span class="n">style_name</span><span class="p">):</span>
    <span class="n">model_path</span> <span class="o">=</span> <span class="n">get_model_path</span><span class="p">(</span><span class="n">style_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s">"models"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BASE_URL</span> <span class="o">+</span> <span class="n">STYLE_MODELS</span><span class="p">[</span><span class="n">style_name</span><span class="p">]</span>
        <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[INFO] Downloaded </span><span class="si">{</span><span class="n">style_name</span><span class="si">}</span><span class="s"> model to </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model_path</span>
</code></pre></div></div>

<hr />

<h2 id="step-4-onnxanime-wrapper-class">Step 4: ONNXAnime Wrapper Class</h2>

<p>This class handles image transformation:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span> <span class="k">as</span> <span class="n">ort</span>

<span class="k">class</span> <span class="nc">ONNXAnime</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onnx_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">ort</span><span class="p">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">onnx_path</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">inp</span><span class="p">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">inp</span><span class="p">.</span><span class="n">shape</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_bgr_or_rgba</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img_bgr_or_rgba</span>
        <span class="k">if</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGRA2BGR</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">target_h</span><span class="p">,</span> <span class="n">target_w</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">img_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">target_w</span><span class="p">,</span> <span class="n">target_h</span><span class="p">))</span>
        <span class="n">img_resized</span> <span class="o">=</span> <span class="n">img_resized</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span><span class="o">/</span><span class="mf">127.5</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img_resized</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">{</span><span class="bp">self</span><span class="p">.</span><span class="n">input_name</span><span class="p">:</span> <span class="n">tensor</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out_img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">((</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="mf">127.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">out_img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="step-5-building-the-tkinter-gui">Step 5: Building the Tkinter GUI</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="n">tk</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">filedialog</span><span class="p">,</span> <span class="n">messagebox</span><span class="p">,</span> <span class="n">ttk</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageTk</span>

<span class="k">class</span> <span class="nc">AnimeApp</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span>
        <span class="n">master</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"PyShine Anime GUI"</span><span class="p">)</span>
        <span class="n">master</span><span class="p">.</span><span class="n">geometry</span><span class="p">(</span><span class="s">"450x700"</span><span class="p">)</span>

        <span class="n">tk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Select image → choose style → Convert"</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="n">frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Select Image"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">load_image</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">style_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">"Hayao"</span><span class="p">)</span>
        <span class="n">ttk</span><span class="p">.</span><span class="n">OptionMenu</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">style_var</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">style_var</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">"Hayao"</span><span class="p">,</span> <span class="s">"Shinkai"</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Convert"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">convert</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Save"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">save</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>
        <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Original"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">show_original</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">MAX_DISPLAY_SIZE</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">MAX_DISPLAY_SIZE</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s">"gray"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">input_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output_img</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">orig_img_pil</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div>

<hr />

<h2 id="step-6-loading-and-displaying-images">Step 6: Loading and Displaying Images</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">filedialog</span><span class="p">.</span><span class="n">askopenfilename</span><span class="p">(</span><span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s">"Image files"</span><span class="p">,</span> <span class="s">"*.jpg *.jpeg *.png"</span><span class="p">)])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span> <span class="k">return</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">input_path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">"RGB"</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">orig_img_pil</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">display_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">width</span><span class="o">*</span><span class="n">MAX_DISPLAY_SIZE</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="n">img</span><span class="p">.</span><span class="n">height</span><span class="p">))</span>
    <span class="n">display_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">height</span><span class="o">*</span><span class="n">MAX_DISPLAY_SIZE</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="n">img</span><span class="p">.</span><span class="n">height</span><span class="p">))</span>
    <span class="n">img_display</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="n">display_w</span><span class="p">,</span> <span class="n">display_h</span><span class="p">),</span> <span class="n">Image</span><span class="p">.</span><span class="n">Resampling</span><span class="p">.</span><span class="n">LANCZOS</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span> <span class="o">=</span> <span class="n">ImageTk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">img_display</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">display_w</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">display_h</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">display_w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">display_h</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="step-7-converting-images">Step 7: Converting Images</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_path</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">style_var</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">model_path</span> <span class="o">=</span> <span class="n">ensure_model</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">input_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_UNCHANGED</span><span class="p">)</span>
    <span class="n">anime</span> <span class="o">=</span> <span class="n">ONNXAnime</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">anime</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">output_img</span> <span class="o">=</span> <span class="n">out</span>
    <span class="n">out_display</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">))</span>
    <span class="n">out_display</span> <span class="o">=</span> <span class="n">out_display</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">winfo_width</span><span class="p">(),</span> <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">winfo_height</span><span class="p">()),</span> <span class="n">Image</span><span class="p">.</span><span class="n">Resampling</span><span class="p">.</span><span class="n">LANCZOS</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span> <span class="o">=</span> <span class="n">ImageTk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">out_display</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">winfo_width</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">winfo_height</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="step-8-saving-and-showing-original-image">Step 8: Saving and Showing Original Image</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">output_img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">filedialog</span><span class="p">.</span><span class="n">asksaveasfilename</span><span class="p">(</span><span class="n">defaultextension</span><span class="o">=</span><span class="s">".png"</span><span class="p">,</span> <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s">"PNG"</span><span class="p">,</span><span class="s">"*.png"</span><span class="p">),(</span><span class="s">"JPEG"</span><span class="p">,</span><span class="s">"*.jpg"</span><span class="p">)])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">output_img</span><span class="p">)</span>
    <span class="n">messagebox</span><span class="p">.</span><span class="n">showinfo</span><span class="p">(</span><span class="s">"Saved"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Saved to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_original</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">orig_img_pil</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">img_display</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">orig_img_pil</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">winfo_width</span><span class="p">(),</span> <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">winfo_height</span><span class="p">()),</span> <span class="n">Image</span><span class="p">.</span><span class="n">Resampling</span><span class="p">.</span><span class="n">LANCZOS</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span> <span class="o">=</span> <span class="n">ImageTk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">img_display</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">winfo_width</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">winfo_height</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="step-9-running-the-app">Step 9: Running the App</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="n">AnimeApp</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">root</span><span class="p">.</span><span class="n">mainloop</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h2 id="sample-images">Sample Images</h2>

<p><img src="http://localhost:4000/assets/img/posts/samples/image1.png" alt="image1" /></p>

<hr />

<p><img src="http://localhost:4000/assets/img/posts/samples/image2.png" alt="image2" /></p>

<hr />

<p><img src="http://localhost:4000/assets/img/posts/samples/image3.png" alt="image3" /></p>

<h2 id="complete-code">Complete Code</h2>

<style>
  .copy-code-button {
	box-shadow:inset 0px 1px 0px 0px #bbdaf7;
	background:linear-gradient(to bottom, #79bbff 5%, #378de5 100%);
	background-color:#79bbff;
	border-radius:6px;
	border:1px solid #84bbf3;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #528ecc;
}
.copy-code-button:hover {
	background:linear-gradient(to bottom, #378de5 5%, #79bbff 100%);
	background-color:#378de5;
}
.copy-code-button:active {
	position:relative;
	top:1px;
}
</style>

<div class="code-header">
  <button class="copy-code-button">
    Copy code to clipboard
  </button>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="c1"># Fail-safe automatic installer for bare env
</span><span class="n">required_packages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"Pillow&gt;=10"</span><span class="p">,</span>
    <span class="s">"numpy"</span><span class="p">,</span>
    <span class="s">"opencv-contrib-python"</span><span class="p">,</span>
    <span class="s">"onnxruntime"</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">install_package</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[INFO] Installing </span><span class="si">{</span><span class="n">pkg</span><span class="si">}</span><span class="s"> ..."</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="p">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">"-m"</span><span class="p">,</span> <span class="s">"pip"</span><span class="p">,</span> <span class="s">"install"</span><span class="p">,</span> <span class="s">"--upgrade"</span><span class="p">,</span> <span class="n">pkg</span><span class="p">])</span>

<span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">required_packages</span><span class="p">:</span>
    <span class="n">pkg_name</span> <span class="o">=</span> <span class="n">pkg</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'&gt;='</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">__import__</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
        <span class="n">install_package</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>


<span class="c1"># Import all after installation
</span><span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="n">tk</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">filedialog</span><span class="p">,</span> <span class="n">messagebox</span><span class="p">,</span> <span class="n">ttk</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageTk</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span> <span class="k">as</span> <span class="n">ort</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="c1"># Ensure Pillow has Resampling.LANCZOS
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">Resampling</span><span class="p">.</span><span class="n">LANCZOS</span>
<span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[INFO] Pillow version is too old, upgrading..."</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="p">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="s">"-m"</span><span class="p">,</span> <span class="s">"pip"</span><span class="p">,</span> <span class="s">"install"</span><span class="p">,</span> <span class="s">"--upgrade"</span><span class="p">,</span> <span class="s">"Pillow&gt;=10"</span><span class="p">])</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageTk</span>

<span class="k">print</span><span class="p">(</span><span class="s">"[INFO] All required packages are installed and imported successfully!"</span><span class="p">)</span>


<span class="c1"># AnimeGANv3 ONNX Model Config
</span><span class="n">STYLE_MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"Hayao"</span><span class="p">:</span> <span class="s">"AnimeGANv3_Hayao_36.onnx"</span><span class="p">,</span>
    <span class="s">"Shinkai"</span><span class="p">:</span> <span class="s">"AnimeGANv3_Shinkai_37.onnx"</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s">"https://github.com/TachibanaYoshino/AnimeGANv3/releases/download/v1.1.0/"</span>

<span class="n">MAX_DISPLAY_SIZE</span> <span class="o">=</span> <span class="mi">512</span>  <span class="c1"># Max width/height for GUI display
</span>
<span class="k">def</span> <span class="nf">get_model_path</span><span class="p">(</span><span class="n">style_name</span><span class="p">):</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">STYLE_MODELS</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">style_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">"models"</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_model</span><span class="p">(</span><span class="n">style_name</span><span class="p">):</span>
    <span class="n">model_path</span> <span class="o">=</span> <span class="n">get_model_path</span><span class="p">(</span><span class="n">style_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s">"models"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BASE_URL</span> <span class="o">+</span> <span class="n">STYLE_MODELS</span><span class="p">[</span><span class="n">style_name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[INFO] Downloaded </span><span class="si">{</span><span class="n">style_name</span><span class="si">}</span><span class="s"> model to </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Download error"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Could not download </span><span class="si">{</span><span class="n">style_name</span><span class="si">}</span><span class="s"> model:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">model_path</span>

<span class="k">def</span> <span class="nf">safe_dim</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="nb">TypeError</span><span class="p">,</span> <span class="nb">ValueError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">default</span>


<span class="c1"># ONNX AnimeGANv3 Wrapper
</span><span class="k">class</span> <span class="nc">ONNXAnime</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onnx_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">ort</span><span class="p">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">onnx_path</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">get_inputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">inp</span><span class="p">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">inp</span><span class="p">.</span><span class="n">shape</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[INFO] Model expects input shape:"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_bgr_or_rgba</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img_bgr_or_rgba</span>
        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Input image is None"</span><span class="p">)</span>

        <span class="n">orig_h</span><span class="p">,</span> <span class="n">orig_w</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[DEBUG] Original input image shape: </span><span class="si">{</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGRA2BGR</span><span class="p">)</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Unsupported model input shape: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># Determine target height/width
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># NCHW
</span>            <span class="n">target_h</span> <span class="o">=</span> <span class="n">safe_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">target_w</span> <span class="o">=</span> <span class="n">safe_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># NHWC
</span>            <span class="n">target_h</span> <span class="o">=</span> <span class="n">safe_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">target_w</span> <span class="o">=</span> <span class="n">safe_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Unsupported model input shape: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[DEBUG] Resizing input for model: (</span><span class="si">{</span><span class="n">target_h</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">target_w</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
        <span class="n">img_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">target_w</span><span class="p">,</span> <span class="n">target_h</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
        <span class="n">img_resized</span> <span class="o">=</span> <span class="n">img_resized</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">127.5</span> <span class="o">-</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># NCHW
</span>            <span class="n">tensor</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img_resized</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># NHWC
</span>            <span class="n">tensor</span> <span class="o">=</span> <span class="n">img_resized</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">{</span><span class="bp">self</span><span class="p">.</span><span class="n">input_name</span><span class="p">:</span> <span class="n">tensor</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[DEBUG] Raw model output shape: </span><span class="si">{</span><span class="n">out</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span><span class="p">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">out</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># NCHW
</span>            <span class="n">out_img</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">out</span><span class="p">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">out</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># NHWC
</span>            <span class="n">out_img</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Unsupported model output shape: </span><span class="si">{</span><span class="n">out</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="n">out_img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">((</span><span class="n">out_img</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">127.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">out_bgr</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">out_img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[DEBUG] Converted output image shape (before GUI resize): </span><span class="si">{</span><span class="n">out_bgr</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_bgr</span>


<span class="c1"># GUI App
</span><span class="k">class</span> <span class="nc">AnimeApp</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span>
        <span class="n">master</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"PyShine Anime GUI"</span><span class="p">)</span>
        <span class="n">master</span><span class="p">.</span><span class="n">geometry</span><span class="p">(</span><span class="s">"450x700"</span><span class="p">)</span>

        <span class="n">tk</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Select image → choose style → Convert"</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">master</span><span class="p">)</span>
        <span class="n">frame</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

      
        <span class="c1"># OptionMenu for style selection 
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">style_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">StringVar</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">style_var</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">"Hayao"</span><span class="p">)</span>  <span class="c1"># default value
</span>        <span class="n">ttk</span><span class="p">.</span><span class="n">OptionMenu</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">style_var</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">style_var</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">*</span><span class="n">STYLE_MODELS</span><span class="p">.</span><span class="n">keys</span><span class="p">()).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Select"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">load_image</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Convert"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">convert</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Save"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">save</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tk</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Original"</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">show_original</span><span class="p">).</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tk</span><span class="p">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Canvas for image display 
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">MAX_DISPLAY_SIZE</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">MAX_DISPLAY_SIZE</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="s">"gray"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Variables 
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">input_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output_img</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">orig_img_pil</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># original PIL image for showing anytime
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">orig_w</span> <span class="o">=</span> <span class="mi">512</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">orig_h</span> <span class="o">=</span> <span class="mi">512</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">display_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># reference to Tkinter image
</span>

    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">filedialog</span><span class="p">.</span><span class="n">askopenfilename</span><span class="p">(</span><span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s">"Image files"</span><span class="p">,</span> <span class="s">"*.jpg *.jpeg *.png"</span><span class="p">)])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">input_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">"RGB"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">orig_img_pil</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># save original for Show Original
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">orig_w</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">orig_h</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">size</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_DISPLAY_SIZE</span><span class="o">/</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_w</span><span class="p">,</span> <span class="n">MAX_DISPLAY_SIZE</span><span class="o">/</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_h</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">display_scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="n">display_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_w</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">display_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_h</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>

        <span class="n">img_display</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="n">display_w</span><span class="p">,</span> <span class="n">display_h</span><span class="p">),</span> <span class="n">Image</span><span class="p">.</span><span class="n">Resampling</span><span class="p">.</span><span class="n">LANCZOS</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span> <span class="o">=</span> <span class="n">ImageTk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">img_display</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">display_w</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">display_h</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">display_w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">display_h</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[DEBUG] GUI displaying input image shape: </span><span class="si">{</span><span class="n">display_w</span><span class="si">}</span><span class="s">x</span><span class="si">{</span><span class="n">display_h</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">show_original</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">orig_img_pil</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s">"No image"</span><span class="p">,</span> <span class="s">"Please load an image first."</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">display_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_w</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">display_scale</span><span class="p">)</span>
        <span class="n">display_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_h</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">display_scale</span><span class="p">)</span>
        <span class="n">img_display</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">orig_img_pil</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="n">display_w</span><span class="p">,</span> <span class="n">display_h</span><span class="p">),</span> <span class="n">Image</span><span class="p">.</span><span class="n">Resampling</span><span class="p">.</span><span class="n">LANCZOS</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span> <span class="o">=</span> <span class="n">ImageTk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">img_display</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">display_w</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">display_h</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">display_w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">display_h</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[DEBUG] GUI displaying original input image shape: </span><span class="si">{</span><span class="n">display_w</span><span class="si">}</span><span class="s">x</span><span class="si">{</span><span class="n">display_h</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">input_path</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s">"No image"</span><span class="p">,</span> <span class="s">"Please select an image first."</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">style_var</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">ensure_model</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_path</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">input_path</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_UNCHANGED</span><span class="p">)</span>
            <span class="n">anime</span> <span class="o">=</span> <span class="n">ONNXAnime</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">anime</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">output_img</span> <span class="o">=</span> <span class="n">out</span>

            <span class="c1"># Resize to original image for saving
</span>            <span class="n">out_display</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_w</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">orig_h</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">INTER_AREA</span><span class="p">)</span>

            <span class="c1"># Resize for GUI display
</span>            <span class="n">display_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_w</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">display_scale</span><span class="p">)</span>
            <span class="n">display_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_h</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">display_scale</span><span class="p">)</span>
            <span class="n">out_display_pil</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">out_display</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">))</span>
            <span class="n">out_display_pil</span> <span class="o">=</span> <span class="n">out_display_pil</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="n">display_w</span><span class="p">,</span> <span class="n">display_h</span><span class="p">),</span> <span class="n">Image</span><span class="p">.</span><span class="n">Resampling</span><span class="p">.</span><span class="n">LANCZOS</span><span class="p">)</span>

            <span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span> <span class="o">=</span> <span class="n">ImageTk</span><span class="p">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">out_display_pil</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">config</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">display_w</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">display_h</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">canvas</span><span class="p">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">display_w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">display_h</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">tk_img</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[DEBUG] GUI displaying output image shape: </span><span class="si">{</span><span class="n">display_w</span><span class="si">}</span><span class="s">x</span><span class="si">{</span><span class="n">display_h</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showerror</span><span class="p">(</span><span class="s">"Failed to convert image"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">output_img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">messagebox</span><span class="p">.</span><span class="n">showwarning</span><span class="p">(</span><span class="s">"No output"</span><span class="p">,</span> <span class="s">"No anime image to save."</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">filedialog</span><span class="p">.</span><span class="n">asksaveasfilename</span><span class="p">(</span><span class="n">defaultextension</span><span class="o">=</span><span class="s">".png"</span><span class="p">,</span>
                                            <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s">"PNG"</span><span class="p">,</span><span class="s">"*.png"</span><span class="p">),(</span><span class="s">"JPEG"</span><span class="p">,</span><span class="s">"*.jpg"</span><span class="p">)])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">save_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_img</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">orig_w</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">orig_h</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[DEBUG] Saving output image resized shape: </span><span class="si">{</span><span class="n">save_img</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">save_img</span><span class="p">)</span>
        <span class="n">messagebox</span><span class="p">.</span><span class="n">showinfo</span><span class="p">(</span><span class="s">"Saved"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Saved to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


<span class="c1"># Run App
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="c1"># Define a style for the OptionMenu
</span>    <span class="n">style</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">Style</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">style</span><span class="p">.</span><span class="n">theme_use</span><span class="p">(</span><span class="s">'clam'</span><span class="p">)</span>  <span class="c1"># or 'default', 'alt'
</span>    <span class="n">style</span><span class="p">.</span><span class="n">configure</span><span class="p">(</span><span class="s">'TMenubutton'</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s">'black'</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s">'white'</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="p">(</span><span class="s">'Arial'</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

    <span class="n">style_var</span> <span class="o">=</span> <span class="n">tk</span><span class="p">.</span><span class="n">StringVar</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">"Hayao"</span><span class="p">)</span>
    <span class="n">option</span> <span class="o">=</span> <span class="n">ttk</span><span class="p">.</span><span class="n">OptionMenu</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">style_var</span><span class="p">,</span> <span class="n">style_var</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="s">"Hayao"</span><span class="p">,</span> <span class="s">"Shinkai"</span><span class="p">)</span>
    <span class="c1"># option.pack(padx=20, pady=20)
</span>    <span class="n">AnimeApp</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">root</span><span class="p">.</span><span class="n">mainloop</span><span class="p">()</span>

</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>You now have a <strong>fully functional AnimeGANv3 ONNX GUI</strong>!You learned:</p>

<ul>
  <li>Automatic package installation</li>
  <li>Downloading ONNX models</li>
  <li>Transforming images with ONNX</li>
  <li>Displaying images in Tkinter</li>
  <li>Saving results and viewing original image</li>
</ul>

<p>Experiment with different styles and images to create your own anime artwork!</p>

<hr />

<p><strong>Website:</strong> https://www.pyshine.com
<strong>Author:</strong> PyShine</p>]]></content><author><name>PyShine Team</name></author><category term="python" /><category term="animegan" /><category term="onnx" /><category term="gui" /><category term="beginner" /><category term="tutorial" /><summary type="html"><![CDATA[Step-by-step beginner-friendly tutorial to use AnimeGANv3 ONNX with a Tkinter GUI for transforming images into anime style.]]></summary></entry><entry><title type="html">High-Resolution ASCII Image Converter in Python – Beginner’s Guide</title><link href="http://localhost:4000/High-Resolution-ASCII-Image-Converter/" rel="alternate" type="text/html" title="High-Resolution ASCII Image Converter in Python – Beginner’s Guide" /><published>2025-11-26T00:00:00+08:00</published><updated>2025-11-26T00:00:00+08:00</updated><id>http://localhost:4000/High-Resolution-ASCII-Image-Converter</id><content type="html" xml:base="http://localhost:4000/High-Resolution-ASCII-Image-Converter/"><![CDATA[<h2 id="introduction">Introduction</h2>

<p>Have you ever wanted to turn your favorite images into <strong>high-resolution ASCII art</strong>?
In this tutorial, we’ll build a Python program that converts images into <strong>full-color, pixel-aligned ASCII art</strong>.</p>

<p>This guide is written for <strong>beginners</strong>, and no prior experience with image processing is required.</p>

<div class="video-container">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/Iek-azP5o1s" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
  </iframe>
</div>

<h2 id="understanding-the-requirements">Understanding the Requirements</h2>

<p>Before we start coding, let’s understand the tools and concepts:</p>

<h3 id="requirements">Requirements:</h3>

<ul>
  <li><strong>Python 3 installed</strong></li>
  <li>Basic familiarity with Python functions, lists, and loops</li>
  <li>Libraries:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">numpy</code></li>
      <li><code class="language-plaintext highlighter-rouge">opencv-python</code></li>
      <li><code class="language-plaintext highlighter-rouge">Pillow</code> (PIL)</li>
    </ul>
  </li>
</ul>

<p>The program will:</p>

<ul>
  <li>Load an image</li>
  <li>Resize it to match ASCII character grid</li>
  <li>Match each block of pixels to a character</li>
  <li>Recreate the image using ASCII characters with original colors</li>
  <li>Provide character usage statistics</li>
</ul>

<hr />

<h2 id="installing-required-libraries">Installing Required Libraries</h2>

<p>Run the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>numpy opencv-contrib-python pillow
</code></pre></div></div>

<hr />

<h2 id="creating-the-ascii-converter">Creating the ASCII Converter</h2>

<p>Create a new Python file called <strong><code class="language-plaintext highlighter-rouge">ascii_matcher_hd.py</code></strong> and start coding.</p>

<h3 id="1-import-modules">1. Import Modules</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">platform</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageFont</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageOps</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">os</code> and <code class="language-plaintext highlighter-rouge">platform</code> → to detect system fonts</li>
  <li><code class="language-plaintext highlighter-rouge">numpy</code> → efficient numerical operations</li>
  <li><code class="language-plaintext highlighter-rouge">cv2</code> → image processing</li>
  <li><code class="language-plaintext highlighter-rouge">PIL</code> → drawing ASCII characters on images</li>
</ul>

<hr />

<h3 id="2-define-ascii-characters">2. Define ASCII Characters</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ASCII</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">127</span><span class="p">)]</span>
</code></pre></div></div>

<ul>
  <li>ASCII characters from <strong>space (32)</strong> to <strong>tilde (126)</strong>.</li>
  <li>These will be used to recreate the image.</li>
</ul>

<hr />

<h3 id="3-load-a-monospace-font">3. Load a Monospace Font</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_monospace_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span>
    <span class="n">mac</span> <span class="o">=</span> <span class="p">[</span><span class="s">"/System/Library/Fonts/Menlo.ttc"</span><span class="p">,</span> <span class="s">"/System/Library/Fonts/Monaco.ttf"</span><span class="p">]</span>
    <span class="n">win</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s">"C:\Windows\Fonts\consola.ttf"</span><span class="p">,</span> <span class="sa">r</span><span class="s">"C:\Windows\Fonts\cour.ttf"</span><span class="p">]</span>
    <span class="n">linux</span> <span class="o">=</span> <span class="p">[</span><span class="s">"/usr/share/fonts/truetype/dejavu/DejaVuSansMono.ttf"</span><span class="p">,</span> <span class="s">"/usr/share/fonts/truetype/liberation/LiberationMono-Regular.ttf"</span><span class="p">]</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">mac</span> <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s">"Darwin"</span> <span class="k">else</span> <span class="n">win</span> <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s">"Windows"</span> <span class="k">else</span> <span class="n">linux</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ImageFont</span><span class="p">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"⚠ Using fallback font"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ImageFont</span><span class="p">.</span><span class="n">load_default</span><span class="p">()</span>

<span class="n">font</span> <span class="o">=</span> <span class="n">load_monospace_font</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Cross-platform font loading ensures consistent ASCII alignment.</li>
  <li>Uses a fallback if no system font is found.</li>
</ul>

<hr />

<h3 id="4-get-font-cell-size">4. Get Font Cell Size</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_font_cell</span><span class="p">(</span><span class="n">font</span><span class="p">):</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">getbbox</span><span class="p">(</span><span class="s">"M"</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">CELL</span> <span class="o">=</span> <span class="n">get_font_cell</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Font cell ="</span><span class="p">,</span> <span class="n">CELL</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Each ASCII character is drawn in a <strong>fixed cell size</strong>.</li>
  <li>Important for accurate image reconstruction.</li>
</ul>

<hr />

<h3 id="5-precompute-glyph-bitmaps">5. Precompute Glyph Bitmaps</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">glyph_bitmap</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">CELL</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s">"L"</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">d</span><span class="p">.</span><span class="n">text</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ch</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="k">return</span> <span class="n">arr</span>

<span class="n">GLYPHS</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ch</span><span class="p">,</span> <span class="n">glyph_bitmap</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">ASCII</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Precomputes grayscale representation for each ASCII character.</li>
  <li>Speeds up the matching process.</li>
</ul>

<hr />

<h3 id="6-enhance-image-contrast">6. Enhance Image Contrast</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">enhance_contrast</span><span class="p">(</span><span class="n">gray</span><span class="p">):</span>
    <span class="n">clahe</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">clipLimit</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">tileGridSize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">clahe</span><span class="p">.</span><span class="nb">apply</span><span class="p">((</span><span class="n">gray</span> <span class="o">*</span> <span class="mi">255</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">))</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.2</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Uses <strong>CLAHE</strong> for low-contrast images.</li>
  <li>Applies a gamma correction for brightness enhancement.</li>
</ul>

<hr />

<h3 id="7-convert-image-to-ascii">7. Convert Image to ASCII</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">image_to_ascii</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">brightness</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">FileNotFoundError</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">cw</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">CELL</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cw</span><span class="o">/</span><span class="n">ch</span><span class="p">))</span>
    <span class="n">target_px</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span><span class="o">*</span><span class="n">cw</span><span class="p">,</span> <span class="n">rows</span><span class="o">*</span><span class="n">ch</span><span class="p">)</span>
    <span class="n">img_small</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">target_px</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">INTER_AREA</span><span class="p">)</span>

    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_small</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">enhance_contrast</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gray</span> <span class="o">*</span> <span class="n">brightness</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s">"RGB"</span><span class="p">,</span> <span class="n">target_px</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="n">char_usage</span> <span class="o">=</span> <span class="p">{</span><span class="n">ch</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">ASCII</span><span class="p">}</span>
    <span class="n">total_used</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">cw</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">ch</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">gray</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y0</span><span class="o">+</span><span class="n">ch</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x0</span><span class="o">+</span><span class="n">cw</span><span class="p">]</span>

            <span class="n">best</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">GLYPHS</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">patch</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">best_char</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">char_usage</span><span class="p">[</span><span class="n">best_char</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">total_used</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">img_small</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y0</span><span class="o">+</span><span class="n">ch</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x0</span><span class="o">+</span><span class="n">cw</span><span class="p">].</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">draw</span><span class="p">.</span><span class="n">text</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="n">best_char</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

    <span class="n">out</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Saved:"</span><span class="p">,</span> <span class="n">out_path</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== CHARACTER USAGE REPORT ==="</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Total characters used:"</span><span class="p">,</span> <span class="n">total_used</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">char_usage</span><span class="p">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"'</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s">' : </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Resizes the image to match <strong>ASCII grid</strong>.</li>
  <li>Matches each pixel block with the <strong>best-fitting ASCII character</strong>.</li>
  <li>Draws ASCII characters using <strong>average color</strong> from the original image.</li>
  <li>Prints <strong>character usage statistics</strong>.</li>
</ul>

<hr />

<h3 id="8-example-run">8. Example Run</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">image_to_ascii</span><span class="p">(</span><span class="s">"cat.png"</span><span class="p">,</span> <span class="s">"ascii_hd.png"</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">brightness</span><span class="o">=</span><span class="mf">1.6</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Converts <code class="language-plaintext highlighter-rouge">cat.png</code> into <code class="language-plaintext highlighter-rouge">ascii_hd.png</code>.</li>
  <li>Adjust <code class="language-plaintext highlighter-rouge">cols</code> and <code class="language-plaintext highlighter-rouge">brightness</code> for different resolution and contrast.</li>
</ul>

<hr />

<h2 id="running-the-script">Running the Script</h2>

<ol>
  <li>Save your file as <code class="language-plaintext highlighter-rouge">ascii_matcher_hd.py</code>.</li>
  <li>Place an image in the same folder, e.g., <code class="language-plaintext highlighter-rouge">cat.png</code>.</li>
  <li>Run the script:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python ascii_matcher_hd.py
</code></pre></div></div>

<h2 id="complete-code">Complete code</h2>

<style>
  .copy-code-button {
	box-shadow:inset 0px 1px 0px 0px #bbdaf7;
	background:linear-gradient(to bottom, #79bbff 5%, #378de5 100%);
	background-color:#79bbff;
	border-radius:6px;
	border:1px solid #84bbf3;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #528ecc;
}
.copy-code-button:hover {
	background:linear-gradient(to bottom, #378de5 5%, #79bbff 100%);
	background-color:#378de5;
}
.copy-code-button:active {
	position:relative;
	top:1px;
}
</style>

<div class="code-header">
  <button class="copy-code-button">
    Copy code to clipboard
  </button>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">platform</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageFont</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageOps</span>


<span class="c1"># ASCII CHARSET (printables)
</span><span class="n">ASCII</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">127</span><span class="p">)]</span>


<span class="c1"># LOAD CROSS-PLATFORM MONOSPACE FONT
</span><span class="k">def</span> <span class="nf">load_monospace_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="p">.</span><span class="n">system</span><span class="p">()</span>

    <span class="n">mac</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"/System/Library/Fonts/Menlo.ttc"</span><span class="p">,</span>
        <span class="s">"/System/Library/Fonts/Monaco.ttf"</span>
    <span class="p">]</span>
    <span class="n">win</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="s">"C:\Windows\Fonts\consola.ttf"</span><span class="p">,</span>
        <span class="sa">r</span><span class="s">"C:\Windows\Fonts\cour.ttf"</span>
    <span class="p">]</span>
    <span class="n">linux</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"/usr/share/fonts/truetype/dejavu/DejaVuSansMono.ttf"</span><span class="p">,</span>
        <span class="s">"/usr/share/fonts/truetype/liberation/LiberationMono-Regular.ttf"</span>
    <span class="p">]</span>

    <span class="n">search</span> <span class="o">=</span> <span class="n">mac</span> <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s">"Darwin"</span> <span class="k">else</span> <span class="n">win</span> <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s">"Windows"</span> <span class="k">else</span> <span class="n">linux</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ImageFont</span><span class="p">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"Using fallback font"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ImageFont</span><span class="p">.</span><span class="n">load_default</span><span class="p">()</span>

<span class="n">font</span> <span class="o">=</span> <span class="n">load_monospace_font</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>


<span class="c1"># GET FONT CELL SIZE (precise height)
</span><span class="k">def</span> <span class="nf">get_font_cell</span><span class="p">(</span><span class="n">font</span><span class="p">):</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">font</span><span class="p">.</span><span class="n">getbbox</span><span class="p">(</span><span class="s">"M"</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">CELL</span> <span class="o">=</span> <span class="n">get_font_cell</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Font cell ="</span><span class="p">,</span> <span class="n">CELL</span><span class="p">)</span>


<span class="c1"># PRECOMPUTE GLYPH BITMAPS
</span><span class="k">def</span> <span class="nf">glyph_bitmap</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">CELL</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s">"L"</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">d</span><span class="p">.</span><span class="n">text</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ch</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="k">return</span> <span class="n">arr</span>

<span class="n">GLYPHS</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ch</span><span class="p">,</span> <span class="n">glyph_bitmap</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">ASCII</span><span class="p">]</span>


<span class="c1"># NORMALIZATION + CONTRAST BOOST FUNCTION
</span><span class="k">def</span> <span class="nf">enhance_contrast</span><span class="p">(</span><span class="n">gray</span><span class="p">):</span>
    <span class="c1"># CLAHE = best for low contrast images
</span>    <span class="n">clahe</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">clipLimit</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">tileGridSize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">clahe</span><span class="p">.</span><span class="nb">apply</span><span class="p">((</span><span class="n">gray</span> <span class="o">*</span> <span class="mi">255</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">))</span> <span class="o">/</span> <span class="mf">255.0</span>

    <span class="c1"># light gamma for more brightness pop
</span>    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.2</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


<span class="c1"># MAIN: HI-RES PIXEL-ALIGNED FULL-COLOR ASCII CONVERTER
</span><span class="k">def</span> <span class="nf">image_to_ascii</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">brightness</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">FileNotFoundError</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">cw</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">CELL</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cw</span><span class="o">/</span><span class="n">ch</span><span class="p">))</span>

    <span class="n">target_px</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span><span class="o">*</span><span class="n">cw</span><span class="p">,</span> <span class="n">rows</span><span class="o">*</span><span class="n">ch</span><span class="p">)</span>
    <span class="n">img_small</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">target_px</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">INTER_AREA</span><span class="p">)</span>

    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_small</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">enhance_contrast</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">gray</span> <span class="o">*</span> <span class="n">brightness</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s">"RGB"</span><span class="p">,</span> <span class="n">target_px</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

  
    <span class="c1"># CHARACTER USAGE COUNTER
</span>    <span class="n">char_usage</span> <span class="o">=</span> <span class="p">{</span><span class="n">ch</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">ASCII</span><span class="p">}</span>
    <span class="n">total_used</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>

            <span class="n">x0</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">cw</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">ch</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">gray</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y0</span><span class="o">+</span><span class="n">ch</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x0</span><span class="o">+</span><span class="n">cw</span><span class="p">]</span>

            <span class="c1"># best ASCII match by L1 distance
</span>            <span class="n">best</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">GLYPHS</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">patch</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">best_char</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">char_usage</span><span class="p">[</span><span class="n">best_char</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">total_used</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># original mean color
</span>            <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">img_small</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y0</span><span class="o">+</span><span class="n">ch</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x0</span><span class="o">+</span><span class="n">cw</span><span class="p">].</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">draw</span><span class="p">.</span><span class="n">text</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="n">best_char</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

    <span class="n">out</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Saved:"</span><span class="p">,</span> <span class="n">out_path</span><span class="p">)</span>


    <span class="c1"># PRINT CHARACTER STATISTICS
</span>    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== CHARACTER USAGE REPORT ==="</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Total characters used:"</span><span class="p">,</span> <span class="n">total_used</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">char_usage</span><span class="p">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"'</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s">' : </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">image_to_ascii</span><span class="p">(</span><span class="s">"cat.png"</span><span class="p">,</span> <span class="s">"ascii_hd.png"</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">brightness</span><span class="o">=</span><span class="mf">1.6</span><span class="p">)</span>

</code></pre></div></div>

<p>Example image via these parameters:</p>

<p><code class="language-plaintext highlighter-rouge">image_to_ascii("cat.png","ascii_hd.png",cols=400,brightness=1.6)</code></p>

<p><img src="http://localhost:4000/assets/img/posts/ascii_hd_cat.png" alt="ascii_hd_cat" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python main.py
Font cell <span class="o">=</span> <span class="o">(</span>12, 15<span class="o">)</span>
Saved: ascii_hd.png

<span class="o">===</span> CHARACTER USAGE REPORT <span class="o">===</span>
Total characters used: 128000
<span class="s1">'N'</span> : 56261
<span class="s1">' '</span> : 28717
<span class="s1">'M'</span> : 21530
<span class="s1">'U'</span> : 10621
<span class="s1">'%'</span> : 6287
<span class="s1">'|'</span> : 1990
<span class="s1">'W'</span> : 520
<span class="s1">'`'</span> : 380
<span class="s1">'0'</span> : 284
<span class="s1">'['</span> : 158
<span class="s1">'*'</span> : 154
<span class="s1">'C'</span> : 107
<span class="s1">'R'</span> : 89
<span class="s1">'J'</span> : 83
<span class="s1">'~'</span> : 81
<span class="s1">'@'</span> : 80
<span class="s1">'K'</span> : 80
<span class="s1">'B'</span> : 75
<span class="s1">'w'</span> : 65
<span class="s1">'&lt;'</span> : 40
<span class="s1">'Z'</span> : 38
<span class="s1">'#'</span> : 36
<span class="s1">'^'</span> : 34
<span class="s1">'D'</span> : 33
<span class="s1">'L'</span> : 33
<span class="s1">'r'</span> : 32
<span class="s1">'&gt;'</span> : 24
<span class="s1">'/'</span> : 14
<span class="s1">'-'</span> : 13
<span class="s1">'m'</span> : 11
<span class="s1">'q'</span> : 11
<span class="s1">'9'</span> : 10
<span class="s1">'!'</span> : 8
<span class="s1">'3'</span> : 8
<span class="s1">'2'</span> : 7
<span class="s1">'H'</span> : 7
<span class="s1">'+'</span> : 6
<span class="s1">'A'</span> : 6
<span class="s1">'a'</span> : 6
<span class="s1">'1'</span> : 5
<span class="s1">'\'</span> : 5
<span class="s1">'d'</span> : 5
<span class="s1">'k'</span> : 5
<span class="s1">'$'</span> : 4
<span class="s1">'4'</span> : 4
<span class="s1">'X'</span> : 4
<span class="s1">'u'</span> : 4
<span class="s1">'6'</span> : 3
<span class="s1">'8'</span> : 3
<span class="s1">':'</span> : 3
<span class="s1">'f'</span> : 3
<span class="s1">'e'</span> : 2
<span class="s1">'{'</span> : 2
<span class="s1">'"'</span> : 1
<span class="s1">'('</span> : 1
<span class="s1">')'</span> : 1
<span class="s1">'7'</span> : 1
<span class="s1">'P'</span> : 1
<span class="s1">'Q'</span> : 1
<span class="s1">'S'</span> : 1
<span class="s1">'o'</span> : 1
<span class="s1">'y'</span> : 1
</code></pre></div></div>

<hr />

<h2 id="conclusion">Conclusion</h2>

<p>You now have a <strong>high-resolution, full-color ASCII converter</strong> in Python!</p>

<p>This tutorial introduces:</p>

<ul>
  <li>Image resizing and processing with OpenCV</li>
  <li>Using PIL for drawing ASCII characters</li>
  <li>Precomputing glyphs for efficiency</li>
  <li>Pixel-aligned ASCII reconstruction</li>
  <li>Character usage analytics</li>
</ul>

<p>Experiment with different images, font sizes, columns, and brightness to create stunning ASCII art.</p>

<hr />

<p><strong>Website:</strong> https://www.pyshine.com
<strong>Author:</strong> PyShine</p>]]></content><author><name>PyShine Team</name></author><category term="python" /><category term="ascii" /><category term="image-processing" /><category term="beginner" /><category term="tutorial" /><summary type="html"><![CDATA[Learn how to convert images to high-resolution ASCII art in Python. Step-by-step beginner-friendly guide to build a pixel-aligned full-color ASCII converter.]]></summary></entry><entry><title type="html">Convert Images to Animated ASCII Art in Python – Beginner’s Guide</title><link href="http://localhost:4000/Image-to-ASCII/" rel="alternate" type="text/html" title="Convert Images to Animated ASCII Art in Python – Beginner’s Guide" /><published>2025-11-25T00:00:00+08:00</published><updated>2025-11-25T00:00:00+08:00</updated><id>http://localhost:4000/Image-to-ASCII</id><content type="html" xml:base="http://localhost:4000/Image-to-ASCII/"><![CDATA[<h2 id="introduction">Introduction</h2>

<p>Ever wondered how to turn an image into awesome ASCII art directly inside your terminal?
In this beginner-friendly tutorial, you’ll learn how to load an image, convert it to grayscale, map pixels to ASCII characters, and display it line-by-line with a smooth animated effect.</p>

<p>This project is perfect for beginners learning:</p>

<ul>
  <li>Basic <strong>image processing</strong></li>
  <li><strong>OpenCV</strong> fundamentals</li>
  <li>ASCII art generation</li>
  <li>Terminal animation</li>
</ul>

<hr />

<h2 id="requirements">Requirements</h2>

<p>Install the required library:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>opencv-contrib-python
</code></pre></div></div>

<p>You also need an image file named:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ia.png
</code></pre></div></div>

<p>Place it in the same folder as your script. Of course you can try any other image name but remember to change that name in the code as well.</p>

<hr />

<h2 id="understanding-the-code">Understanding the Code</h2>

<h2 id="1-importing-libraries">1. Importing Libraries</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
</code></pre></div></div>

<ul>
  <li><strong>cv2</strong> → Image loading and resizing</li>
  <li><strong>time</strong> → Adding animation timing</li>
  <li><strong>os</strong> → Optional file management</li>
</ul>

<hr />

<h2 id="2-ascii-character-set">2. ASCII Character Set</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ASCII</span> <span class="o">=</span> <span class="s">"@%#*+=-:. "</span>
</code></pre></div></div>

<p>Characters are arranged from <strong>darkest</strong> (<code class="language-plaintext highlighter-rouge">@</code>) to <strong>lightest</strong> ().
Each grayscale pixel finds its closest match in this set.</p>

<hr />

<h2 id="3-load-the-image">3. Load the Image</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">"ia.png"</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
<span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">FileNotFoundError</span><span class="p">(</span><span class="s">"Image issue!"</span><span class="p">)</span>
</code></pre></div></div>

<p>Loads the image as grayscale.
If missing → raises an error.</p>

<hr />

<h2 id="4-resize-while-keeping-aspect-ratio">4. Resize While Keeping Aspect Ratio</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
<span class="n">new_w</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">ratio</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="n">w</span>
<span class="n">new_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_w</span> <span class="o">*</span> <span class="n">ratio</span> <span class="o">*</span> <span class="mf">0.55</span><span class="p">)</span>
<span class="n">resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">new_w</span><span class="p">,</span> <span class="n">new_h</span><span class="p">))</span>
</code></pre></div></div>

<p>Why multiply by <strong>0.55</strong>?
Because terminal text cells are <strong>taller</strong> than they are <strong>wide</strong>, so we shrink vertically to maintain the correct proportions.</p>

<hr />

<h2 id="5-convert-pixels-to-ascii-with-animation">5. Convert Pixels to ASCII (With Animation!)</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resized</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">ASCII</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ASCII</span><span class="p">)</span> <span class="o">//</span> <span class="mi">256</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]))</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Converts each pixel intensity to a matching ASCII character</li>
  <li>Builds each line as a string</li>
  <li>Prints it with a short delay to create the animation effect</li>
</ul>

<hr />

<h2 id="full-source-code">Full Source Code</h2>
<style>
  .copy-code-button {
	box-shadow:inset 0px 1px 0px 0px #bbdaf7;
	background:linear-gradient(to bottom, #79bbff 5%, #378de5 100%);
	background-color:#79bbff;
	border-radius:6px;
	border:1px solid #84bbf3;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #528ecc;
}
.copy-code-button:hover {
	background:linear-gradient(to bottom, #378de5 5%, #79bbff 100%);
	background-color:#378de5;
}
.copy-code-button:active {
	position:relative;
	top:1px;
}
</style>

<div class="code-header">
  <button class="copy-code-button">
    Copy code to clipboard
  </button>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">ASCII</span> <span class="o">=</span> <span class="s">"@%#*+=-:. "</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">"ia.png"</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
<span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">FileNotFoundError</span><span class="p">(</span><span class="s">"Image issue!"</span><span class="p">)</span>

<span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
<span class="n">new_w</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">ratio</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="n">w</span>
<span class="n">new_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_w</span> <span class="o">*</span> <span class="n">ratio</span> <span class="o">*</span> <span class="mf">0.55</span><span class="p">)</span>
<span class="n">resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">new_w</span><span class="p">,</span> <span class="n">new_h</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resized</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">ASCII</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ASCII</span><span class="p">)</span> <span class="o">//</span> <span class="mi">256</span><span class="p">]</span>
                   <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]))</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="running-the-script">Running the Script</h2>

<p>Save the script as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ascii_art.py
</code></pre></div></div>

<p>Run it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python ascii_art.py
</code></pre></div></div>

<p>Your ASCII animation will begin drawing line-by-line!</p>

<hr />

<h2 id="full-source-code-colored-version">Full Source Code (Colored version)</h2>
<p>Try the following for colorful version:</p>

<style>
  .copy-code-button {
	box-shadow:inset 0px 1px 0px 0px #bbdaf7;
	background:linear-gradient(to bottom, #79bbff 5%, #378de5 100%);
	background-color:#79bbff;
	border-radius:6px;
	border:1px solid #84bbf3;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:0px 1px 0px #528ecc;
}
.copy-code-button:hover {
	background:linear-gradient(to bottom, #378de5 5%, #79bbff 100%);
	background-color:#378de5;
}
.copy-code-button:active {
	position:relative;
	top:1px;
}
</style>

<div class="code-header">
  <button class="copy-code-button">
    Copy code to clipboard
  </button>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span><span class="p">,</span> <span class="n">time</span>

<span class="n">ASCII</span> <span class="o">=</span> <span class="s">" .:-=+*#%@"</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">"ia.png"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">raise</span> <span class="nb">FileNotFoundError</span><span class="p">()</span>
<span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">new_w</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">new_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_w</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">new_w</span><span class="p">,</span> <span class="n">new_h</span><span class="p">))</span>
<span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="k">for</span> <span class="n">gy</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s">"</span><span class="se">\033</span><span class="s">[38;2;</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s">;</span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s">;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s">m</span><span class="si">{</span><span class="n">ASCII</span><span class="p">[</span><span class="n">p</span><span class="o">*</span><span class="mi">9</span><span class="o">//</span><span class="mi">255</span><span class="p">]</span><span class="si">}</span><span class="se">\033</span><span class="s">[0m"</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gy</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

</code></pre></div></div>

<h2 id="breaking-down-the-code-for-colorful-ascii-art">Breaking Down the Code for COLORFUL ASCII ART</h2>

<ol>
  <li>Importing Libraries</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span><span class="p">,</span> <span class="n">time</span>
</code></pre></div></div>
<ul>
  <li>cv2 → OpenCV library for image processing</li>
  <li>time → To add a small delay for animated printing</li>
</ul>

<ol>
  <li>ASCII Characters</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ASCII</span> <span class="o">=</span> <span class="s">" .:-=+*#%@"</span>
</code></pre></div></div>

<p>Each character represents a different brightness level</p>

<p>” “ is the lightest, “@” is the darkest</p>

<ol>
  <li>Loading the Image</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">"ia.png"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> 
    <span class="k">raise</span> <span class="nb">FileNotFoundError</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>Reads the image file</li>
  <li>Throws an error if the image is missing</li>
</ul>

<ol>
  <li>Resizing the Image</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">new_w</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">new_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_w</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">new_w</span><span class="p">,</span> <span class="n">new_h</span><span class="p">))</span>
</code></pre></div></div>

<ul>
  <li>Maintains aspect ratio</li>
  <li>Scales the width to 80 characters</li>
  <li>0.5 factor compensates for character height vs width</li>
</ul>

<ol>
  <li>Converting to Grayscale</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Converts image to grayscale</li>
  <li>Each pixel now represents brightness (0–255)</li>
</ul>

<ol>
  <li>Mapping Pixels to ASCII Characters with Color</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">gy</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s">"</span><span class="se">\033</span><span class="s">[38;2;</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s">;</span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s">;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s">m</span><span class="si">{</span><span class="n">ASCII</span><span class="p">[</span><span class="n">p</span><span class="o">*</span><span class="mi">9</span><span class="o">//</span><span class="mi">255</span><span class="p">]</span><span class="si">}</span><span class="se">\033</span><span class="s">[0m"</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gy</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>Loops over each row of pixels</li>
  <li>Maps brightness to ASCII character</li>
  <li>Colors characters using ANSI escape codes:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\033[38;2;R;G;Bm
</code></pre></div></div>

<ul>
  <li>Sets RGB foreground color</li>
  <li><code class="language-plaintext highlighter-rouge">\033[0m</code> resets formatting</li>
  <li><code class="language-plaintext highlighter-rouge">time.sleep(0.01)</code> adds a small delay to create a smooth printing effect</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>You now know how to:</p>

<ul>
  <li>Load and process images with OpenCV</li>
  <li>Convert image pixels to ASCII brightness levels</li>
  <li>Create cool terminal animations</li>
</ul>

<p>Try modifying:</p>

<ul>
  <li>The ASCII character set</li>
  <li>Image size</li>
  <li>Animation speed</li>
</ul>

<p>Tips:</p>

<ul>
  <li>Increase new_w for higher-resolution ASCII art.</li>
  <li>Use a terminal with truecolor support for best results.</li>
  <li>You can experiment with different ASCII character sets for different artistic styles.</li>
</ul>

<p>Enjoy experimenting, and happy coding!</p>

<hr />

<p><strong>Website:</strong> https://www.pyshine.com
<strong>Author:</strong> PyShine</p>]]></content><author><name>PyShine Team</name></author><category term="python" /><category term="ascii" /><category term="opencv" /><category term="terminal" /><category term="beginner" /><category term="tutorial" /><summary type="html"><![CDATA[Learn how to convert any image into animated ASCII art using Python and OpenCV. Perfect for beginners exploring image processing and terminal graphics.]]></summary></entry><entry><title type="html">FastAPI Lab 3 – Build a Simple To-Do List API</title><link href="http://localhost:4000/Lab3-FastAPI-Todo-List/" rel="alternate" type="text/html" title="FastAPI Lab 3 – Build a Simple To-Do List API" /><published>2025-11-23T00:00:00+08:00</published><updated>2025-11-23T00:00:00+08:00</updated><id>http://localhost:4000/Lab3-FastAPI-Todo-List</id><content type="html" xml:base="http://localhost:4000/Lab3-FastAPI-Todo-List/"><![CDATA[<h2 id="introduction">Introduction</h2>

<p>Have you ever wondered how apps like  <strong>Google Keep</strong> ,  <strong>Todoist</strong> , or even your phone’s reminder app manage and organize your tasks behind the scenes? In this lab, you’ll step into the world of web APIs and build your very own <strong>Simple To-Do List API</strong> using <strong>FastAPI</strong> and  <strong>Pydantic</strong> .</p>

<div class="video-container">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/EHBkr1hAfVw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
  </iframe>
</div>

<p>With this API, you’ll be able to  <strong>add tasks</strong> ,  <strong>view all tasks</strong> , and understand how data flows between clients and servers — the same concepts used in real-world apps.</p>

<p>Don’t worry if you’ve never worked with APIs before — this guide is  <strong>beginner-friendly</strong> , walks you through every step, and requires no prior experience. By the end, you’ll have a working backend that could be the foundation for your own productivity app!</p>

<hr />

<h2 id="understanding-the-requirements">Understanding the Requirements</h2>

<p>You will build an API that:</p>

<ul>
  <li>Stores tasks in memory (no database required)</li>
  <li>Allows adding tasks via POST requests</li>
  <li>Allows viewing all tasks via GET requests</li>
  <li>Uses Pydantic to validate incoming task data</li>
</ul>

<hr />

<h2 id="setting-up">Setting Up</h2>

<p>Install FastAPI and Uvicorn:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>fastapi uvicorn
</code></pre></div></div>

<hr />

<h2 id="get-requests">GET Requests</h2>

<ul>
  <li>Purpose: Retrieve or fetch data from a server.</li>
  <li>Effect on Server: Does not change server data (read-only).</li>
  <li>Data Transmission: Data is sent via URL query parameters (visible in the URL).</li>
  <li>Idempotence: Yes — making the same GET request multiple times produces the same result.</li>
  <li>Caching: GET requests can be cached by browsers and proxies.</li>
  <li>Use Case Examples:</li>
  <li>Viewing all tasks in a to-do list API</li>
  <li>Retrieving a user profile</li>
  <li>Loading a web page</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/tasks"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"tasks"</span><span class="p">:</span> <span class="n">tasks</span><span class="p">}</span>
</code></pre></div></div>

<p>Visiting <code class="language-plaintext highlighter-rouge">/tasks</code> in your browser or via curl retrieves all tasks.</p>

<h2 id="post-requests">POST Requests</h2>

<ul>
  <li>Purpose: Send data to the server to create or update resources.</li>
  <li>Effect on Server: Changes server state (e.g., adds a new record).</li>
  <li>Data Transmission: Data is sent in the request body (not visible in the URL).</li>
  <li>Idempotence: Usually no — repeating a POST request can create multiple resources.</li>
  <li>Caching: POST requests are usually not cached.</li>
  <li>Use Case Examples:</li>
  <li>Adding a new task to a to-do list</li>
  <li>Creating a new user account</li>
  <li>Submitting a form</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"/add"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_task</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Task</span><span class="p">):</span>
    <span class="n">tasks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"message"</span><span class="p">:</span> <span class="s">"Task added!"</span><span class="p">,</span> <span class="s">"task"</span><span class="p">:</span> <span class="n">item</span><span class="p">.</span><span class="n">task</span><span class="p">}</span>

</code></pre></div></div>

<h2 id="key-differences-between-get-and-post">Key Differences Between GET and POST</h2>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>GET</th>
      <th>POST</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Purpose</td>
      <td>Retrieve data</td>
      <td>Send or create data</td>
    </tr>
    <tr>
      <td>Alters Server Data</td>
      <td>No</td>
      <td>Yes</td>
    </tr>
    <tr>
      <td>Data Location</td>
      <td>URL query parameters</td>
      <td>Request body</td>
    </tr>
    <tr>
      <td>Visibility</td>
      <td>URL visible</td>
      <td>Body hidden</td>
    </tr>
    <tr>
      <td>Idempotent</td>
      <td>Yes</td>
      <td>Usually No</td>
    </tr>
    <tr>
      <td>Caching</td>
      <td>Can be cached</td>
      <td>Usually not cached</td>
    </tr>
  </tbody>
</table>

<h3 id="summary">Summary:</h3>

<ul>
  <li>Use GET to read data without changing anything.</li>
  <li>Use POST to send data or make changes to the server.</li>
</ul>

<h2 id="writing-the-to-do-api">Writing the To-Do API</h2>

<p>Create a file named <strong><code class="language-plaintext highlighter-rouge">main.py</code></strong> and add:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="c1"># In-memory "database"
</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Data model for creating tasks
</span><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">task</span><span class="p">:</span> <span class="nb">str</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"/add"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_task</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Task</span><span class="p">):</span>
    <span class="n">tasks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"message"</span><span class="p">:</span> <span class="s">"Task added!"</span><span class="p">,</span> <span class="s">"task"</span><span class="p">:</span> <span class="n">item</span><span class="p">.</span><span class="n">task</span><span class="p">}</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/tasks"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"tasks"</span><span class="p">:</span> <span class="n">tasks</span><span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="code-explanation">Code Explanation</h2>

<h3 id="1-importing-libraries">1. Importing Libraries</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">FastAPI</code> → to create API endpoints</li>
  <li><code class="language-plaintext highlighter-rouge">BaseModel</code> → to define and validate request data</li>
</ul>

<h3 id="2-creating-the-app">2. Creating the App</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="3-creating-an-in-memory-database">3. Creating an In-Memory Database</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">tasks</code> is a simple Python list that stores all task strings</li>
</ul>

<h3 id="4-defining-the-task-model">4. Defining the Task Model</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">task</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></div>

<ul>
  <li>Ensures that the incoming request contains a string field named <code class="language-plaintext highlighter-rouge">task</code></li>
</ul>

<h3 id="5-adding-tasks">5. Adding Tasks</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"/add"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_task</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Task</span><span class="p">):</span>
    <span class="n">tasks</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"message"</span><span class="p">:</span> <span class="s">"Task added!"</span><span class="p">,</span> <span class="s">"task"</span><span class="p">:</span> <span class="n">item</span><span class="p">.</span><span class="n">task</span><span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Accepts POST requests to <code class="language-plaintext highlighter-rouge">/add</code></li>
  <li>Validates the request body with Pydantic <code class="language-plaintext highlighter-rouge">Task</code> model</li>
  <li>Adds the task to the in-memory list</li>
  <li>Returns a JSON response confirming the addition</li>
</ul>

<h3 id="6-retrieving-all-tasks">6. Retrieving All Tasks</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/tasks"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"tasks"</span><span class="p">:</span> <span class="n">tasks</span><span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Accepts GET requests to <code class="language-plaintext highlighter-rouge">/tasks</code></li>
  <li>Returns all tasks stored in memory</li>
</ul>

<hr />

<h2 id="running-the-server">Running the Server</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> uvicorn main:app <span class="nt">--reload</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">--reload</code> automatically restarts the server when you edit the code</li>
</ul>

<hr />

<h2 id="testing-your-api">Testing Your API</h2>

<h3 id="add-a-task">Add a Task</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST <span class="s2">"http://127.0.0.1:8000/add"</span> <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="nt">-d</span> <span class="s1">'{"task":"Buy groceries"}'</span>
</code></pre></div></div>

<p>Response:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Task added!"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"task"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Buy groceries"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="view-all-tasks">View All Tasks</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://127.0.0.1:8000/tasks
</code></pre></div></div>

<p>Response:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"tasks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Buy groceries"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h2 id="conclusion">Conclusion</h2>

<p>You have now created a <strong>Simple To-Do List API</strong> in Python using FastAPI:</p>

<ul>
  <li>Learned to handle POST and GET requests</li>
  <li>Used Pydantic for request validation</li>
  <li>Stored data in memory</li>
  <li>Built a working backend API for tasks</li>
</ul>

<p>You can expand this lab in the future by:</p>

<ul>
  <li>Adding task deletion</li>
  <li>Adding completion status</li>
  <li>Connecting to a database</li>
</ul>

<hr />

<p><strong>Website:</strong> https://www.pyshine.com
<strong>Author:</strong> PyShine</p>]]></content><author><name>PyShine Team</name></author><category term="python" /><category term="fastapi" /><category term="api" /><category term="backend" /><category term="tutorial" /><category term="beginner" /><summary type="html"><![CDATA[Lab 3 beginner-friendly tutorial to create a Simple To-Do List API using FastAPI and Pydantic. Step-by-step guide for beginners.]]></summary></entry></feed>